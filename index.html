<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TNG é»„é‡‘ç®¡å®¶ V52</title>
  <style>
    :root{
      --primary: #007aff; 
      --cost-color: #ff9f0a;
      --text: #1c1c1e; --sub: #8e8e93;
      --glass-bg: #ffffff; 
      --glass-border: 1px solid rgba(0,0,0,0.05);
      --glass-shadow: 0 4px 12px rgba(0,0,0,0.05);
      --nav-h: 65px; --safe-pb: env(safe-area-inset-bottom);
      --green: #34c759; --red: #ff3b30;
      --bg-color: #f2f2f7;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --text: #f2f2f7; --sub: #98989d;
        --glass-bg: #1c1c1e;
        --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        --bg-color: #000;
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; 
      background: var(--bg-color); 
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
      padding-bottom: calc(var(--nav-h) + 20px + var(--safe-pb));
      user-select: none; -webkit-font-smoothing: antialiased;
    }

    .view { display: none; padding: 20px; padding-top: 60px; animation: fadeIn 0.3s; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Cards */
    .glass-card {
      background: var(--glass-bg); border-radius: 20px; border: var(--glass-border); box-shadow: var(--glass-shadow);
      padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden;
    }

    /* Top Bar */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px; z-index: 90;
      background: var(--glass-bg); border-bottom: var(--glass-border);
      display: flex; justify-content: space-between; align-items: flex-end; padding: 0 24px 12px;
    }
    .app-title { font-size: 20px; font-weight: 700; }
    .icon-btn-top { font-size: 20px; padding: 4px 8px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
    .icon-btn-top:active { opacity: 1; transform: scale(0.9); }

    /* Hero */
    .hero-card {
      text-align: center; padding: 32px 20px;
      background: linear-gradient(135deg, #007aff, #0055ff);
      color: white; border: none; box-shadow: 0 8px 25px rgba(0,122,255,0.3);
      position: relative;
    }
    .hero-label { font-size: 13px; opacity: 0.9; font-weight: 500; margin-bottom: 8px; }
    .hero-val { font-size: 42px; font-weight: 800; letter-spacing: -1px; margin: 4px 0 16px 0; }
    .hero-pill { 
      font-size: 13px; background: rgba(255,255,255,0.9); padding: 6px 14px; 
      border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; color: #333;
    }
    .eye-btn { font-size: 16px; cursor: pointer; opacity: 0.8; margin-left: 5px; }
    .blur-mode { filter: blur(8px); opacity: 0.5; }

    /* Inputs */
    .input-row {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--glass-bg); padding: 16px 20px; border-radius: 20px;
      box-shadow: var(--glass-shadow); border: var(--glass-border); margin-bottom: 20px;
    }
    .input-row input {
      border: none; background: transparent; text-align: right; 
      font-size: 22px; font-weight: 700; color: var(--primary); width: 120px; outline: none; margin-right: 10px;
    }
    .save-btn {
      width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 16px;
      display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border: none;
    }

    /* Grid */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .stat-item { padding: 20px; display: flex; flex-direction: column; justify-content: center; position: relative; }
    .stat-label { font-size: 12px; color: var(--sub); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }
    .stat-val { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    .info-icon { position: absolute; top: 16px; right: 16px; opacity: 0.3; }

    /* List Header */
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .list-title { font-weight: 700; font-size: 15px; color: var(--text); }
    .sort-select {
      appearance: none; border: none; background: rgba(120,120,128,0.1); 
      color: var(--primary); font-size: 12px; padding: 6px 12px; border-radius: 8px; font-weight: 600; outline: none;
    }
    .list-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
    .list-row:last-child { border-bottom: none; }
    .row-l { display: flex; flex-direction: column; gap: 4px; }
    .row-r { text-align: right; display: flex; flex-direction: column; gap: 4px; }
    .tag { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 700; margin-right: 8px; }
    .buy { background: rgba(52,199,89,0.15); color: #32ae50; }
    .sell { background: rgba(255,59,48,0.15); color: #ff3b30; }

    /* Hist Item */
    .hist-item { padding: 16px 0; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
    .hist-top { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
    .hist-date { font-weight: 600; font-size: 16px; color: var(--text); }
    .hist-time { font-size: 12px; color: var(--sub); margin-left: 6px; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
    .hist-val { font-weight: 700; font-size: 16px; color: var(--primary); }
    .hist-btm { display: flex; justify-content: space-between; font-size: 12px; color: var(--sub); }

    /* Chart */
    .chart-head-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .chart-title { font-weight: 700; font-size: 16px; }
    .zoom-group { display: flex; gap: 4px; background: rgba(120,120,128,0.1); border-radius: 8px; padding: 2px; }
    .zoom-btn { width: 32px; height: 32px; border: none; background: transparent; font-size: 18px; color: var(--primary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .chart-scroll-wrapper { overflow-x: auto; padding-bottom: 10px; }
    .chart-box { height: 320px; position: relative; margin-top: 10px; width: 100%; transition: width 0.3s ease; }
    svg { width: 100%; height: 100%; overflow: visible; }
    .bar-val { fill: var(--primary); opacity: 0.9; rx: 2; }
    .bar-cost { fill: var(--cost-color); opacity: 0.9; rx: 2; }
    .bar-label-text { font-size: 9px; font-weight: 600; text-anchor: middle; font-family: monospace; letter-spacing: -0.5px; }
    .val-text { fill: var(--primary); }
    .cost-text { fill: var(--cost-color); }
    .diff-text-pos { fill: var(--green); font-weight: 800; font-size: 10px; }
    .diff-text-neg { fill: var(--red); font-weight: 800; font-size: 10px; }
    .axis-label { font-size: 10px; fill: var(--sub); }
    .grid-line { stroke: var(--text); stroke-opacity: 0.05; stroke-width: 1; stroke-dasharray: 4,4; }
    .chart-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; color: var(--sub); cursor: pointer; padding: 4px 8px; border-radius: 8px; transition: 0.2s; }
    .legend-item.hidden { opacity: 0.4; filter: grayscale(1); }

    /* SIMULATOR STYLES - 3 PART LAYOUT */
    .sim-top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .sim-card-top { background: var(--glass-bg); border-radius: 16px; padding: 16px; box-shadow: var(--glass-shadow); border: var(--glass-border); display: flex; flex-direction: column; justify-content: center; height: 100%; }
    .sim-card-top.right { background: rgba(0,122,255,0.05); border: 1px solid rgba(0,122,255,0.1); }
    
    .sim-title-sm { font-size: 12px; color: var(--sub); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; }
    .sim-big-val { font-size: 20px; font-weight: 800; margin-bottom: 2px; color: var(--text); }
    .sim-sub-val { font-size: 12px; color: var(--sub); }
    .sim-tag { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 6px; font-weight: 700; }
    .sim-tag.green { background: rgba(52,199,89,0.15); color: var(--green); }
    .sim-tag.red { background: rgba(255,59,48,0.15); color: var(--red); }
    
    .sim-extra-info { margin-top: 10px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.05); font-size: 12px; }
    .sim-row-sm { display: flex; justify-content: space-between; margin-bottom: 4px; }

    .sim-input-area { background: var(--glass-bg); border-radius: 20px; padding: 24px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border: var(--glass-border); }
    
    .sim-toggle { display: flex; background: rgba(120,120,128,0.1); padding: 4px; border-radius: 12px; margin-bottom: 20px; }
    .sim-tab { flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 600; border-radius: 8px; color: var(--sub); transition: 0.2s; }
    .sim-tab.active { background: var(--glass-bg); color: var(--text); box-shadow: 0 2px 6px rgba(0,0,0,0.05); }

    .sim-hint { font-size: 12px; color: var(--cost-color); margin-top: 6px; font-weight: 500; display: none; background: rgba(255,159,10,0.1); padding: 8px; border-radius: 8px; }

    /* Calendar */
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; font-weight: 700; font-size: 16px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
    .cal-head-day { font-size: 11px; color: var(--sub); font-weight: 600; margin-bottom: 8px; }
    .cal-cell { height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; font-weight: 500; border-radius: 10px; position: relative; transition: 0.2s; cursor: pointer; }
    .cal-cell.today { background: rgba(0,122,255,0.1); color: var(--primary); font-weight: 700; }
    .cal-cell.has-tx { background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    .cal-cell.selected { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.4); border:none; }
    .cal-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 4px; }
    .cal-dot.green { background: var(--green); }
    .cal-dot.red { background: var(--red); }
    .cal-cell.selected .cal-dot { background: white; }
    .cal-detail-box { margin-top: 20px; padding: 16px; background: rgba(120,120,128,0.05); border-radius: 16px; }

    /* Dock & FAB */
    .dock { position: fixed; bottom: calc(20px + var(--safe-pb)); left: 50%; transform: translateX(-50%); width: 90%; max-width: 320px; height: 70px; background: var(--glass-bg); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: var(--glass-border); z-index: 100; }
    .dock-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 50px; height: 50px; color: var(--sub); border-radius: 50%; transition: 0.3s; position: relative; }
    .dock-btn.active { color: var(--primary); transform: translateY(-5px); }
    .dock-btn svg { width: 26px; height: 26px; fill: currentColor; }
    .fab { position: fixed; bottom: calc(110px + var(--safe-pb)); right: 24px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 25px rgba(0,122,255,0.4); z-index: 90; }

    /* Modals & Commons */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
    .modal-card { width: 85%; max-width: 360px; background: var(--glass-bg); border-radius: 32px; padding: 28px; box-shadow: 0 25px 60px rgba(0,0,0,0.25); border: var(--glass-border); transform: scale(0.95); transition: 0.3s; }
    .modal-overlay.show .modal-card { transform: scale(1); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--sub); margin-bottom: 6px; margin-left: 4px; }
    input.form-input { width: 100%; padding: 16px; background: rgba(120,120,128,0.08); border: none; border-radius: 16px; font-size: 18px; color: var(--text); outline: none; font-weight: 600; }
    .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 700; margin-top: 10px; }
    .settings-list { display: flex; flex-direction: column; gap: 0; border-radius: 16px; overflow: hidden; background: rgba(120,120,128,0.08); }
    .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: transparent; border: none; width: 100%; text-align: left; font-size: 16px; color: var(--text); border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
    .settings-item:last-child { border-bottom: none; }
    .calc-detail-box { background: rgba(120,120,128,0.05); padding: 16px; border-radius: 16px; font-size: 14px; line-height: 1.6; }
    .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 8px; }
    .calc-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; font-weight: 700; font-size: 16px; color: var(--primary); }
    .share-card-container { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 24px; padding: 30px; color: #fff; text-align: center; box-shadow: 0 20px 50px rgba(255, 165, 0, 0.4); margin-bottom: 20px; }
    .share-title { font-size: 16px; font-weight: 600; opacity: 0.9; margin-bottom: 10px; letter-spacing: 2px; }
    .share-amount { font-size: 48px; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .share-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .share-item { background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; }
    .share-label { font-size: 12px; opacity: 0.8; margin-bottom: 4px; }
    .share-val { font-size: 18px; font-weight: 700; }
    .share-footer { margin-top: 20px; font-size: 12px; opacity: 0.7; }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="app-title">TNG é»„é‡‘ç®¡å®¶</div>
  <div>
    <span class="icon-btn-top" onclick="openShareModal()">â</span>
    <span class="icon-btn-top" onclick="openSettings()">âš™ï¸</span>
  </div>
</div>

<div id="view-home" class="view active">
  <div class="glass-card hero-card">
    <div class="hero-label">å½“å‰æŒä»“æ€»å€¼ (RM) <span class="eye-btn" onclick="togglePrivacy()">ğŸ‘ï¸</span></div>
    <div class="hero-val" id="kpiVal">0.00</div>
    <div class="hero-pill" id="kpiProfit">ç›ˆäº: ---</div>
  </div>

  <div class="input-row">
    <div style="display:flex; align-items:center; gap:8px">
      <div style="width:4px; height:16px; background:var(--primary); border-radius:2px"></div>
      <div style="font-weight:600; font-size:16px">ä»Šæ—¥é‡‘ä»·</div>
    </div>
    <div style="display:flex; align-items:center">
      <input type="number" id="marketPrice" placeholder="0.00" inputmode="decimal" step="any" oninput="render(true)">
      <button class="save-btn" onclick="confirmSave()">â”</button>
    </div>
  </div>

  <div class="grid-2">
    <div class="glass-card stat-item">
      <div class="stat-label">æŒæœ‰å…‹æ•°</div>
      <div class="stat-val"><span id="kpiHolding">0.000000</span> <span style="font-size:14px;font-weight:500">g</span></div>
    </div>
    <div class="glass-card stat-item">
      <div class="stat-label">å¹³å‡æˆæœ¬</div>
      <div class="stat-val"><span id="kpiAvg">0.00</span> <span style="font-size:14px;font-weight:500">/g</span></div>
      <div class="info-icon" onclick="showCalcDetail()">?</div>
    </div>
  </div>

  <div class="glass-card">
    <div class="list-header">
      <div class="list-title">æœ€è¿‘äº¤æ˜“</div>
      <select id="sortSelect" class="sort-select" onchange="changeSort()">
        <option value="date-desc">äº¤æ˜“æ—¥æœŸ â†“</option>
        <option value="date-asc">äº¤æ˜“æ—¥æœŸ â†‘</option>
        <option value="price-desc">å•ä»· â†“</option>
      </select>
    </div>
    <div id="txList"></div>
  </div>
</div>

<div id="view-chart" class="view">
  <div class="glass-card" id="chartCard">
    <div class="chart-head-row">
      <div class="chart-title">èµ„äº§èµ°åŠ¿ (å…¨æ˜¾æ¨¡å¼)</div>
      <div class="zoom-group">
        <button class="zoom-btn" onclick="changeZoom(-0.5)">âˆ’</button>
        <button class="zoom-btn" onclick="changeZoom(0.5)">+</button>
      </div>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
      <div class="chart-legend">
        <div class="legend-item" id="lg-val" onclick="toggleChart('val')"><div style="width:12px;height:12px;background:var(--primary);border-radius:2px"></div> å¸‚å€¼</div>
        <div class="legend-item" id="lg-cost" onclick="toggleChart('cost')"><div style="width:12px;height:12px;background:var(--cost-color);border-radius:2px"></div> æˆæœ¬</div>
      </div>
      <button style="font-size:12px; color:var(--primary); background:rgba(0,122,255,0.1); border:none; padding:6px 12px; border-radius:12px; font-weight:600" onclick="openHistModal()">+ è¡¥å½•</button>
    </div>

    <div class="chart-scroll-wrapper">
      <div class="chart-box" id="trendChart"></div>
    </div>
  </div>
  <div class="glass-card">
    <div style="font-weight:700; font-size:15px; margin-bottom:12px; color:var(--text)">å†å²å›æº¯è¯¦æƒ… (æ—¥å†…è®°å½•)</div>
    <div id="histList"></div>
  </div>
</div>

<div id="view-cal" class="view">
  <div class="glass-card">
    <div class="cal-header">
      <div onclick="changeMonth(-1)" style="cursor:pointer;padding:10px">â®</div>
      <div id="calTitle"></div>
      <div onclick="changeMonth(1)" style="cursor:pointer;padding:10px">â¯</div>
    </div>
    <div class="cal-grid">
      <div class="cal-head-day">æ—¥</div><div class="cal-head-day">ä¸€</div><div class="cal-head-day">äºŒ</div>
      <div class="cal-head-day">ä¸‰</div><div class="cal-head-day">å››</div><div class="cal-head-day">äº”</div><div class="cal-head-day">å…­</div>
    </div>
    <div id="calDays" class="cal-grid"></div>
    <div id="calDetail" class="cal-detail-box">
      <div style="font-weight:700;margin-bottom:8px" id="calDetailDate"></div>
      <div id="calDetailContent"></div>
    </div>
  </div>
</div>

<div id="view-sim" class="view">
  <div class="sim-top-row">
    <div class="sim-card-top left">
      <div class="sim-title-sm">å½“å‰çŠ¶æ€</div>
      <div class="sim-big-val" id="simCurAvg">--</div>
      <div class="sim-sub-val" id="simCurHold">-- g</div>
    </div>
    
    <div class="sim-card-top right">
      <div class="sim-title-sm" style="color:var(--primary)">æ¨æ¼”ç»“æœ</div>
      <div class="sim-big-val" style="color:var(--primary)" id="simNewAvg">--</div>
      <div class="sim-sub-val" id="simNewHold">-- g</div>
      
      <div class="sim-extra-info">
        <div class="sim-row-sm">
            <span>å›æœ¬éœ€æ¶¨</span>
            <span style="font-weight:700" id="resBreakEven">--</span>
        </div>
        <div class="sim-row-sm" id="rowProfit" style="display:none">
            <span>é¢„è®¡åˆ©æ¶¦</span>
            <span style="font-weight:700;color:var(--green)" id="resNetProfit">--</span>
        </div>
      </div>
    </div>
  </div>

  <div class="sim-input-area">
    <div class="sim-toggle">
        <div class="sim-tab active" id="tab-mode-amt" onclick="setSimMode('amt')">æŒ‰é‡‘é¢æ¨æ¼”</div>
        <div class="sim-tab" id="tab-mode-target" onclick="setSimMode('target')">æŒ‰ç›®æ ‡åæ¨</div>
    </div>

    <div class="form-group">
      <label class="form-label">å‡è®¾ä¹°å…¥å•ä»· (RM/g)</label>
      <input type="number" id="simPrice" class="form-input" placeholder="0.00" oninput="runSim()">
    </div>
    
    <div class="form-group" id="input-grp-amt">
      <label class="form-label">è®¡åˆ’æŠ•å…¥é‡‘é¢ (RM)</label>
      <input type="number" id="simAmt" class="form-input" placeholder="å‡†å¤‡ä¹°å¤šå°‘é’±?" oninput="runSim()">
    </div>
    <div class="form-group" id="input-grp-target" style="display:none">
      <label class="form-label">ç›®æ ‡å¹³å‡æˆæœ¬ (RM/g)</label>
      <input type="number" id="simTargetCost" class="form-input" placeholder="æƒ³é™åˆ°å¤šå°‘?" oninput="runSim()">
      <div class="sim-hint" id="simHintTarget"></div>
    </div>

    <div class="form-group" style="margin-bottom:0;margin-top:20px;padding-top:20px;border-top:1px dashed rgba(0,0,0,0.1)">
      <label class="form-label">ç›®æ ‡å–å‡ºä»· (å¯é€‰)</label>
      <input type="number" id="simSellPrice" class="form-input" placeholder="é¢„æµ‹æœªæ¥å–å‡ºä»·" oninput="runSim()">
    </div>
  </div>
</div>

<div class="dock">
  <div class="dock-btn active" id="nav-home" onclick="switchTab('home')">
    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
  </div>
  <div class="dock-btn" id="nav-chart" onclick="switchTab('chart')">
    <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
  </div>
  <div class="dock-btn" id="nav-cal" onclick="switchTab('cal')">
    <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
  </div>
  <div class="dock-btn" id="nav-sim" onclick="switchTab('sim')">
    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 2h5v5h-5V5zm-5 5h5v5H7v-5zm0-5h5v5H7V5zm5 14H7v-5h5v5zm5 0h-5v-5h5v5zm0-7h-5v-5h5v5z"/></svg>
  </div>
</div>

<div class="fab" id="fabBtn" onclick="openTxModal()">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
</div>

<div class="modal-overlay" id="shareModal">
  <div class="modal-card" style="background:white">
    <div class="share-card-container">
      <div class="share-title">TNG é»„é‡‘æˆ˜ç»©</div>
      <div class="share-amount" id="shareVal">0.00</div>
      <div class="share-grid">
        <div class="share-item"><div class="share-label">æŒä»“ (g)</div><div class="share-val" id="shareHold">0</div></div>
        <div class="share-item"><div class="share-label">ç›ˆäº</div><div class="share-val" id="sharePL">0</div></div>
        <div class="share-item"><div class="share-label">å¹³å‡æˆæœ¬</div><div class="share-val" id="shareAvg">0</div></div>
        <div class="share-item"><div class="share-label">æ”¶ç›Šç‡</div><div class="share-val" id="sharePct">0%</div></div>
      </div>
      <div class="share-footer">Designed by TNG é»„é‡‘ç®¡å®¶</div>
    </div>
    <div style="text-align:center;font-size:12px;color:#999;margin-bottom:15px">æˆªå›¾æ­¤å¡ç‰‡å³å¯åˆ†äº«</div>
    <button class="btn-main" onclick="closeModal('shareModal')">å…³é—­</button>
  </div>
</div>

<div class="modal-overlay" id="txModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:24px">è®°ä¸€ç¬”äº¤æ˜“</h3>
    <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-input" id="tDate"></div>
    <div class="form-group"><label class="form-label">æ€»é‡‘é¢ (RM)</label><input type="number" class="form-input" id="tAmt" placeholder="0.00" inputmode="decimal" step="any" oninput="calcG()"></div>
    <div style="display:flex; gap:12px">
      <div class="form-group" style="flex:1"><label class="form-label">å•ä»· (RM/g)</label><input type="number" class="form-input" id="tPrice" placeholder="0.00" inputmode="decimal" step="any" oninput="calcG()"></div>
      <div class="form-group" style="flex:1"><label class="form-label">å…‹æ•°</label><input type="number" class="form-input" id="tGrams" placeholder="è‡ªåŠ¨è®¡ç®—" disabled></div>
    </div>
    <button class="btn-main" onclick="saveTx()">ä¿å­˜è®°å½•</button>
    <div style="text-align:center; margin-top:16px; color:#ff3b30; font-size:14px; display:none" id="btnDelTx" onclick="delTx()">åˆ é™¤æ­¤è®°å½•</div>
    <div style="text-align:center; margin-top:16px; color:var(--sub); font-size:14px" onclick="closeModal('txModal')">å–æ¶ˆ</div>
  </div>
</div>

<div class="modal-overlay" id="histModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:24px">è¡¥å½•å†å²èµ„äº§</h3>
    <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-input" id="hDate"></div>
    <div class="form-group"><label class="form-label">æ—¶é—´</label><input type="time" class="form-input" id="hTime"></div>
    <div class="form-group"><label class="form-label">æ€»å¸‚å€¼ (RM)</label><input type="number" class="form-input" id="hTotalVal" placeholder="0.00" inputmode="decimal" step="any"></div>
    <button class="btn-main" onclick="saveHist()">ä¿å­˜</button>
    <div style="text-align:center; margin-top:16px; color:#ff3b30; font-size:14px; display:none" id="btnDelHist" onclick="delHist()">åˆ é™¤</div>
    <div style="text-align:center; margin-top:16px; color:var(--sub); font-size:14px" onclick="closeModal('histModal')">å–æ¶ˆ</div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:24px">æ•°æ®ç®¡ç†</h3>
    <div class="settings-list">
      <button class="settings-item" onclick="exportData()"><span>ğŸ“¤ å¤‡ä»½æ•°æ®</span></button>
      <div style="position:relative"><button class="settings-item"><span>ğŸ“¥ æ¢å¤å¤‡ä»½</span></button><input type="file" onchange="importData(this)" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer"></div>
      <button class="settings-item" onclick="resetAll()"><span style="color:var(--red)">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</span></button>
    </div>
    <button class="btn-main" onclick="closeModal('settingsModal')" style="background:#eee; color:#333; margin-top:20px">å…³é—­</button>
  </div>
</div>

<div class="modal-overlay" id="calcDetailModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:20px">å¹³å‡æˆæœ¬è®¡ç®—</h3>
    <div class="calc-detail-box">
      <div class="calc-row"><span>æ€»æŠ•å…¥é‡‘é¢</span><span id="detailCost">0.00</span></div>
      <div class="calc-row"><span>æ€»æŒæœ‰å…‹æ•°</span><span id="detailGrams">0.000000</span></div>
      <div class="calc-row"><span>å¹³å‡æˆæœ¬</span><span id="detailAvg">0.00</span></div>
    </div>
    <button class="btn-main" onclick="closeModal('calcDetailModal')">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>

<script>
  const PRELOAD_TX = [{"ts":1769197202982,"type":"buy","date":"2025-05-18","amount":10,"grams":0.022438,"price":445.669382},{"ts":1769197251472,"type":"buy","date":"2025-12-25","amount":10,"grams":0.016995,"price":588.417299},{"ts":1769197276233,"type":"buy","date":"2025-12-31","amount":10,"grams":0.017494,"price":571.610734},{"ts":1769197303771,"type":"buy","date":"2026-01-21","amount":500,"grams":0.796725,"price":627.568989},{"ts":1769197324261,"type":"buy","date":"2026-01-23","amount":1000,"grams":1.553877,"price":643.551401},{"ts":1769679188602,"type":"buy","date":"2025-04-23","amount":10,"grams":0.021294,"price":469.623106},{"ts":1769679209117,"type":"buy","date":"2025-05-10","amount":10,"grams":0.021391,"price":467.48292}];
  const PRELOAD_HIST = [{"ts":1770000000000,"date":"2026-01-22","time":"00:00","val":558.05},{"ts":1770000000001,"date":"2026-01-23","time":"00:00","val":1547.97},{"ts":1770000000002,"date":"2026-01-24","time":"00:00","val":1559.44},{"ts":1770000000003,"date":"2026-01-25","time":"00:00","val":1558.89},{"ts":1769570138096,"date":"2026-01-26","time":"10:00","val":1580.48},{"ts":1769570149763,"date":"2026-01-27","time":"10:00","val":1571.57},{"ts":1769570157362,"date":"2026-01-28","time":"10:00","val":1597.82},{"ts":1769679309649,"date":"2026-01-29","time":"10:00","val":1623.05},{"ts":1769679322265,"date":"2026-01-29","time":"11:00","val":1627.36},{"ts":1769679331450,"date":"2026-01-29","time":"12:00","val":1708.71},{"ts":1769679360449,"date":"2026-01-29","time":"17:00","val":1696.79}];
  const KEY = { TX: 'tng_tx_v52', HS: 'tng_hs_v52', MK: 'tng_mk_v52' };
  const el = id => document.getElementById(id);
  
  let editId = null, editHistId = null, currentZoom = 1.0;
  let sortMode = 'date-desc', chartVis = { val: true, cost: true }, privacyMode = false;
  let curCalYear = new Date().getFullYear(), curCalMonth = new Date().getMonth();
  let selectedDate = null;
  let simMode = 'amt';

  function init(){
    if(!localStorage.getItem(KEY.TX)) localStorage.setItem(KEY.TX, JSON.stringify(PRELOAD_TX));
    if(!localStorage.getItem(KEY.HS)) localStorage.setItem(KEY.HS, JSON.stringify(PRELOAD_HIST));
    el('tDate').value = new Date().toISOString().split('T')[0];
    const savedP = localStorage.getItem(KEY.MK);
    if(savedP) el('marketPrice').value = savedP;
    render();
  }

  function getDB(){ return { tx: JSON.parse(localStorage.getItem(KEY.TX)||'[]'), hs: JSON.parse(localStorage.getItem(KEY.HS)||'[]') }; }
  
  function getHoldingAt(dateStr = null){
    const tx = getDB().tx.sort((a,b)=> a.date.localeCompare(b.date) || a.ts - b.ts);
    let h = 0, totalCost = 0;
    for(let t of tx){
      if(dateStr && t.date > dateStr) break;
      const g = Number(t.grams), a = Number(t.amount);
      if(t.type === 'buy'){ h += g; totalCost += a; }
      else { 
        if(h > 0){ const avg = totalCost / h; totalCost -= (g * avg); }
        h -= g; 
      }
    }
    if(h < 0.000001) { h = 0; totalCost = 0; }
    return { h, c: totalCost };
  }

  function render(previewOnly = false){
    const {h, c} = getHoldingAt();
    const mp = parseFloat(el('marketPrice').value)||0;
    const avg = h > 0 ? (c / h) : 0;
    
    const blurClass = privacyMode ? 'blur-mode' : '';
    el('kpiHolding').className = blurClass; el('kpiHolding').innerText = h.toFixed(6);
    el('kpiAvg').className = blurClass; el('kpiAvg').innerText = "RM " + avg.toFixed(2);
    el('kpiVal').className = "hero-val " + blurClass;

    if(mp && h){
      const val = h * mp;
      const profit = val - c;
      const pct = c > 0 ? (profit / c) * 100 : 0;
      const color = profit >= 0 ? 'var(--green)' : 'var(--red)';
      const sign = profit >= 0 ? '+' : '';
      if(!privacyMode) el('kpiVal').innerText = val.toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2});
      el('kpiProfit').innerHTML = `ç›ˆäº <strong style="color:${color}; margin-left:4px">RM ${sign}${profit.toFixed(2)} (${pct.toFixed(2)}%)</strong>`;
    } else {
      if(!privacyMode) el('kpiVal').innerText = '0.00';
      el('kpiProfit').innerText = 'ç›ˆäº: ---';
    }

    if(!previewOnly){
        let txs = getDB().tx;
        if(sortMode === 'date-desc') txs.sort((a,b) => b.date.localeCompare(a.date));
        else if(sortMode === 'date-asc') txs.sort((a,b) => a.date.localeCompare(b.date));
        else if(sortMode === 'price-desc') txs.sort((a,b) => b.price - a.price);
        else if(sortMode === 'price-asc') txs.sort((a,b) => a.price - b.price);

        const list = el('txList'); list.innerHTML = '';
        txs.slice(0, 10).forEach(t => {
        list.innerHTML += `<div class="list-row" onclick="editT(${t.ts})">
            <div class="row-l"><div style="font-weight:600;font-size:16px;color:var(--text)"><span class="tag ${t.type}">${t.type==='buy'?'ä¹°':'å–'}</span>RM ${Number(t.amount).toFixed(2)}</div><div style="font-size:12px;color:var(--sub)">${t.date}</div></div>
            <div class="row-r"><div style="font-weight:700;font-size:15px;color:var(--text)">${Number(t.grams).toFixed(6)} g</div><div style="font-size:12px;color:var(--sub)">@ ${Number(t.price).toFixed(2)}</div></div></div>`;
        });

        const hList = el('histList'); hList.innerHTML = '';
        const hs = getDB().hs.sort((a,b) => b.date.localeCompare(a.date) || b.time.localeCompare(a.time));
        hs.forEach(h => {
            const stats = getHoldingAt(h.date);
            const impliedPrice = stats.h > 0 ? (h.val / stats.h) : 0;
            hList.innerHTML += `<div class="hist-item" onclick="editHist('${h.ts}')">
                <div class="hist-top"><div class="hist-date">${h.date} <span class="hist-time">${h.time || '00:00'}</span></div><div class="hist-val">RM ${Number(h.val).toFixed(2)}</div></div>
                <div class="hist-btm"><span>æŒä»“ ${stats.h.toFixed(6)}g</span><span>çº¦ ${impliedPrice.toFixed(2)}/g</span></div></div>`;
        });
    }
  }

  // --- Simulator (Optimized) ---
  function setSimMode(m){
      simMode = m;
      el('tab-mode-amt').className = m=='amt' ? 'sim-tab active' : 'sim-tab';
      el('tab-mode-target').className = m=='target' ? 'sim-tab active' : 'sim-tab';
      el('input-grp-amt').style.display = m=='amt' ? 'block' : 'none';
      el('input-grp-target').style.display = m=='target' ? 'block' : 'none';
      runSim();
  }

  function runSim(){
      const simP = parseFloat(el('simPrice').value);
      const sellP = parseFloat(el('simSellPrice').value);
      const {h, c} = getHoldingAt();
      const curAvg = h > 0 ? c/h : 0;
      
      el('simCurAvg').innerText = "RM " + curAvg.toFixed(2);
      el('simCurHold').innerText = h.toFixed(4) + " g";
      el('simHintTarget').style.display = 'none';
      el('rowProfit').style.display = 'none';

      let simAmt = 0;
      let valid = false;

      if(simP > 0) {
          if(simMode === 'amt'){
              simAmt = parseFloat(el('simAmt').value);
              if(simAmt > 0) valid = true;
          } else {
              const targetCost = parseFloat(el('simTargetCost').value);
              if(targetCost > 0){
                  // Logic Fix & Smart Hint
                  if(targetCost < curAvg){
                      el('simHintTarget').style.display = 'block';
                      el('simHintTarget').innerText = `ğŸ’¡ æç¤ºï¼šä¹°å…¥ä»·å¿…é¡»ä½äº RM ${targetCost.toFixed(2)} æ‰èƒ½å®ç°`;
                  }
                  
                  if(targetCost < curAvg && simP < targetCost){ 
                      if(Math.abs(1 - targetCost/simP) > 0.001){
                          simAmt = (targetCost*h - c) / (1 - targetCost/simP);
                          if(simAmt > 0) valid = true;
                      }
                  } else if (targetCost > curAvg && simP > targetCost) {
                      simAmt = (targetCost*h - c) / (1 - targetCost/simP);
                      if(simAmt > 0) valid = true;
                  }
              }
          }
      }

      if(valid){
          const newG = simAmt / simP;
          const totalC = c + simAmt;
          const totalH = h + newG;
          const newAvg = totalC / totalH;
          
          el('simNewAvg').innerText = "RM " + newAvg.toFixed(2);
          el('simNewHold').innerText = totalH.toFixed(4) + " g";
          
          // Break Even
          const riseNeed = ((newAvg - simP) / simP) * 100;
          if(newAvg > simP) el('resBreakEven').innerHTML = `éœ€æ¶¨ <span style="color:var(--red);font-weight:700">${riseNeed.toFixed(2)}%</span> å›æœ¬`;
          else el('resBreakEven').innerHTML = `å½“å‰å·²ç›ˆ <span style="color:var(--green);font-weight:700">${Math.abs(riseNeed).toFixed(2)}%</span>`;

          if(sellP > 0){
              const revenue = totalH * sellP;
              const profit = revenue - totalC;
              el('rowProfit').style.display = 'flex';
              el('resNetProfit').innerText = (profit>=0?'+':'') + "RM " + profit.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
              el('resNetProfit').style.color = profit>=0 ? 'var(--green)' : 'var(--red)';
          }

      } else {
          el('simNewAvg').innerText = "--";
          el('simNewHold').innerText = "-- g";
          el('resBreakEven').innerText = "--";
      }
  }

  // --- Calendar ---
  function changeMonth(delta){
    curCalMonth += delta;
    if(curCalMonth > 11) { curCalMonth=0; curCalYear++; }
    if(curCalMonth < 0) { curCalMonth=11; curCalYear--; }
    renderCalendar();
  }

  function renderCalendar(){
    const y = curCalYear, m = curCalMonth;
    el('calTitle').innerText = `${y}å¹´ ${m+1 < 10 ? '0'+(m+1) : m+1}æœˆ`;
    const firstDay = new Date(y, m, 1).getDay();
    const daysInMonth = new Date(y, m+1, 0).getDate();
    
    const tx = getDB().tx;
    const dayMap = {};
    tx.forEach(t => {
      const d = new Date(t.date);
      if(d.getFullYear() === y && d.getMonth() === m){
        const day = d.getDate();
        if(!dayMap[day]) dayMap[day] = {buy:0, sell:0};
        if(t.type==='buy') dayMap[day].buy += Number(t.amount);
        else dayMap[day].sell += Number(t.amount);
      }
    });

    let html = '';
    for(let i=0; i<firstDay; i++) html += '<div></div>';
    for(let i=1; i<=daysInMonth; i++){
      const hasData = dayMap[i];
      let dots = '';
      if(hasData){
        if(hasData.buy > 0) dots += '<div class="cal-dot green"></div>';
        if(hasData.sell > 0) dots += '<div class="cal-dot red"></div>';
      }
      const today = new Date();
      const isToday = (today.getFullYear()===y && today.getMonth()===m && today.getDate()===i);
      const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
      const isSelected = selectedDate === dateStr;
      html += `<div class="cal-cell ${isToday?'today':''} ${hasData?'has-tx':''} ${isSelected?'selected':''}" onclick="showCalDetail(${i}, this)">${i} ${dots}</div>`;
    }
    el('calDays').innerHTML = html;
  }

  function showCalDetail(day, cell){
    document.querySelectorAll('.cal-cell').forEach(c => c.classList.remove('selected'));
    if(cell) cell.classList.add('selected');
    const tx = getDB().tx;
    const y = curCalYear, m = curCalMonth;
    const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
    selectedDate = dateStr;
    const dayTxs = tx.filter(t => t.date === dateStr);
    el('calDetailDate').innerText = dateStr;
    if(dayTxs.length === 0) {
        el('calDetailContent').innerHTML = '<div style="text-align:center;color:var(--sub);padding:10px">å½“æ—¥æ— äº¤æ˜“è®°å½•</div>';
        return;
    }
    let html = '';
    dayTxs.forEach(t => {
      const color = t.type==='buy' ? 'var(--green)' : 'var(--red)';
      html += `<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.05)">
        <span style="color:${color};font-weight:700">${t.type==='buy'?'ä¹°å…¥':'å–å‡º'} RM ${Number(t.amount).toFixed(2)}</span>
        <span style="color:var(--text)">${Number(t.grams).toFixed(4)}g</span>
      </div>`;
    });
    el('calDetailContent').innerHTML = html;
  }

  function openShareModal(){
    const {h, c} = getHoldingAt();
    const mp = parseFloat(el('marketPrice').value)||0;
    const avg = h > 0 ? (c / h) : 0;
    if(mp && h){
        const val = h * mp;
        const profit = val - c;
        const pct = c > 0 ? (profit / c) * 100 : 0;
        el('shareVal').innerText = "RM " + val.toLocaleString('en-US',{minimumFractionDigits:2});
        el('shareHold').innerText = h.toFixed(4);
        el('sharePL').innerText = (profit>=0?'+':'') + profit.toFixed(2);
        el('shareAvg').innerText = avg.toFixed(2);
        el('sharePct').innerText = (profit>=0?'+':'') + pct.toFixed(2) + "%";
    } else {
        el('shareVal').innerText = "RM 0.00";
    }
    openModal('shareModal');
  }

  function togglePrivacy(){ privacyMode = !privacyMode; render(true); }
  function confirmSave(){ const p=parseFloat(el('marketPrice').value); if(!p||p<=0)return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘ä»·"); if(confirm(`ç¡®è®¤å†™å…¥ä»Šæ—¥é‡‘ä»· RM ${p.toFixed(2)}?`)) saveAndChart(p); }
  function saveAndChart(p){ 
      localStorage.setItem(KEY.MK,p); 
      const {h}=getHoldingAt(); 
      if(h>0){ 
          const now = new Date();
          const d = now.toISOString().split('T')[0];
          const time = now.toTimeString().slice(0,5);
          let hs=getDB().hs; 
          hs.push({ts: Date.now(), date:d, time:time, val:h*p}); 
          localStorage.setItem(KEY.HS,JSON.stringify(hs)); 
      } 
      render(); switchTab('chart'); 
  }
  function toggleChart(t){ chartVis[t]=!chartVis[t]; el('lg-'+t).className=chartVis[t]?'legend-item':'legend-item hidden'; drawChart(); }
  function changeZoom(delta){
      currentZoom += delta;
      if(currentZoom < 0.5) currentZoom = 0.5;
      if(currentZoom > 5) currentZoom = 5;
      drawChart();
  }
  function changeSort(){ sortMode=el('sortSelect').value; render(); }
  function showCalcDetail(){ const {h,c}=getHoldingAt(); const avg=h>0?(c/h):0; el('detailCost').innerText="RM "+c.toFixed(2); el('detailGrams').innerText=h.toFixed(6)+" g"; el('detailAvg').innerText="RM "+avg.toFixed(2)+" /g"; openModal('calcDetailModal'); }

  function drawChart(){
    const {hs} = getDB();
    const box = el('trendChart'); box.innerHTML = '';
    if(hs.length<2) { box.innerHTML='<div style="text-align:center;padding-top:120px;color:var(--sub)">æš‚æ— æ•°æ®</div>'; return; }
    
    const data = hs.sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time)).map(h=>{ 
        const s=getHoldingAt(h.date); 
        return {date:h.date, time:h.time, val:h.val, cost:s.c}; 
    });
    
    const vals = data.map(d=>d.val).concat(data.map(d=>d.cost));
    const min=Math.min(...vals)*0.98, max=Math.max(...vals)*1.02, h=320, w=box.offsetWidth*currentZoom;
    
    let svg = `<svg style="width:${w}px;height:${h}px">`;
    const step = Math.ceil(data.length / (5 * currentZoom));
    const groupW = w / data.length;
    const barW = Math.max(4, groupW * 0.35); 
    
    const pts = data.map((d,i)=>({ 
        x: i * groupW + groupW/2, 
        yVal: h-30-((d.val-min)/(max-min))*(h-60), 
        yCost: h-30-((d.cost-min)/(max-min))*(h-60), 
        d 
    }));
    
    if(chartVis.cost){
        svg += pts.map((p,i)=> {
            let bar = `<rect x="${p.x - barW}" y="${p.yCost}" width="${barW}" height="${h-30-p.yCost}" class="bar-cost" onclick="alert('${p.d.date} ${p.d.time} æˆæœ¬: ${p.d.cost.toFixed(2)}')"></rect>`;
            bar += `<text x="${p.x - barW/2}" y="${p.yCost - 5}" class="bar-label-text cost-text">${p.d.cost.toFixed(2)}</text>`;
            return bar;
        }).join('');
    }
    if(chartVis.val){
        svg += pts.map((p,i)=> {
            let bar = `<rect x="${p.x}" y="${p.yVal}" width="${barW}" height="${h-30-p.yVal}" class="bar-val" onclick="alert('${p.d.date} ${p.d.time} å¸‚å€¼: ${p.d.val.toFixed(2)}')"></rect>`;
            bar += `<text x="${p.x + barW/2}" y="${p.yVal - 5}" class="bar-label-text val-text">${p.d.val.toFixed(2)}</text>`;
            const diff = p.d.val - p.d.cost;
            const diffY = Math.min(p.yVal, p.yCost) - 15;
            const colorClass = diff >= 0 ? 'diff-text-pos' : 'diff-text-neg';
            const sign = diff >= 0 ? '+' : '';
            bar += `<text x="${p.x}" y="${diffY}" class="bar-label-text ${colorClass}" style="font-size:8px">${sign}${diff.toFixed(2)}</text>`;
            return bar;
        }).join('');
    }
    svg += pts.map((p,i)=> (i%Math.ceil(data.length/(5*currentZoom))===0) ? `<text x="${p.x}" y="${h-10}" class="axis-label" style="text-anchor:middle">${p.d.date.slice(5)}</text>` : '').join('');
    box.innerHTML = svg + '</svg>';
  }

  function saveTx(){ const d=el('tDate').value, a=el('tAmt').value, p=el('tPrice').value, g=el('tGrams').value; if(!a||!g)return alert("å®Œæ•´å¡«å†™"); let tx=getDB().tx; const rec={ts:editId||Date.now(), type:'buy', date:d, amount:a, grams:g, price:p}; if(editId){const i=tx.findIndex(x=>x.ts==editId);if(i>-1)tx[i]=rec;}else tx.push(rec); localStorage.setItem(KEY.TX,JSON.stringify(tx)); closeModal('txModal'); render(); }
  function saveHist(){ const d=el('hDate').value, time=el('hTime').value, v=parseFloat(el('hTotalVal').value); if(!v)return alert("è¾“å…¥é‡‘é¢"); let hs=getDB().hs; if(editHistId){ const i=hs.findIndex(x=>x.ts==editHistId); if(i>-1)hs[i]={...hs[i], date:d, time:time, val:v}; } else { hs.push({ts:Date.now(), date:d, time:time||"00:00", val:v}); } localStorage.setItem(KEY.HS,JSON.stringify(hs)); closeModal('histModal'); render(); drawChart(); }
  function delTx(){ if(confirm("åˆ é™¤?")){ localStorage.setItem(KEY.TX,JSON.stringify(getDB().tx.filter(x=>x.ts!=editId))); closeModal('txModal'); render(); } }
  function delHist(){ if(confirm("åˆ é™¤?")){ localStorage.setItem(KEY.HS,JSON.stringify(getDB().hs.filter(x=>x.ts!=editHistId))); closeModal('histModal'); render(); drawChart(); } }
  function calcG(){ const a=parseFloat(el('tAmt').value), p=parseFloat(el('tPrice').value); if(a&&p)el('tGrams').value=(a/p).toFixed(6); }
  
  function openModal(id){ el(id).classList.add('show'); }
  function closeModal(id){ el(id).classList.remove('show'); }
  function openTxModal(){ editId=null; el('tAmt').value=''; el('tPrice').value=''; el('tGrams').value=''; el('btnDelTx').style.display='none'; openModal('txModal'); }
  function editT(ts){ const t=getDB().tx.find(x=>x.ts==ts); if(!t)return; editId=ts; el('tDate').value=t.date; el('tAmt').value=t.amount; el('tPrice').value=t.price; el('tGrams').value=t.grams; el('btnDelTx').style.display='block'; openModal('txModal'); }
  function openHistModal(){ editHistId=null; el('hDate').value=new Date().toISOString().split('T')[0]; el('hTime').value="10:00"; el('hTotalVal').value=''; el('btnDelHist').style.display='none'; openModal('histModal'); }
  function editHist(ts){ const h=getDB().hs.find(x=>x.ts==ts); if(!h)return; editHistId=ts; el('hDate').value=h.date; el('hTime').value=h.time||"00:00"; el('hTotalVal').value=h.val; el('btnDelHist').style.display='block'; openModal('histModal'); }
  function openSettings(){ openModal('settingsModal'); }
  function switchTab(t){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); el('view-'+t).classList.add('active'); el('nav-home').className=t=='home'?'dock-btn active':'dock-btn'; el('nav-chart').className=t=='chart'?'dock-btn active':'dock-btn'; el('nav-cal').className=t=='cal'?'dock-btn active':'dock-btn'; el('nav-sim').className=t=='sim'?'dock-btn active':'dock-btn'; el('fabBtn').style.display=t=='home'?'flex':'none'; if(t=='chart')drawChart(); if(t=='cal')renderCalendar(); }
  function exportData(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(getDB())],{type:'application/json'})); a.download='backup.json'; a.click(); }
  function importData(i){ const r=new FileReader(); r.onload=e=>{ try{const d=JSON.parse(e.target.result); if(d.tx)localStorage.setItem(KEY.TX,JSON.stringify(d.tx)); if(d.hs)localStorage.setItem(KEY.HS,JSON.stringify(d.hs)); location.reload();}catch{alert('Error');} }; r.readAsText(i.files[0]); }
  function resetAll(){ if(confirm('æ¸…ç©º?')){ localStorage.clear(); location.reload(); } }

  init();
</script>
</body>
</html>
