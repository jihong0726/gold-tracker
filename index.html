<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TNG 黄金资产走势</title>
  <style>
    :root{
      --bg: #f4f6f8; --card: #ffffff; --text: #111827; --sub: #6b7280;
      --primary: #005eb8; /* TNG Blue */
      --line: #e5e7eb;
      --green: #10b981; --red: #ef4444;
      --radius: 12px;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --sub: #94a3b8;
        --line: #334155;
      }
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding-bottom: 60px; }
    .wrap { max-width: 500px; margin: 0 auto; padding: 12px; }

    /* Header */
    header { display: flex; justify-content: space-between; align-items: center; padding: 4px 0 12px; }
    h1 { font-size: 18px; margin: 0; font-weight: 800; color: var(--primary); }
    .badge { font-size: 10px; background: rgba(0,94,184,0.1); color: var(--primary); padding: 2px 8px; border-radius: 99px; font-weight: 600; }

    /* Market Input */
    .market-bar {
      background: linear-gradient(135deg, var(--primary), #004c9e);
      color: white; padding: 14px; border-radius: var(--radius);
      margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0,94,184,0.2);
    }
    .market-bar input {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: white; width: 100px; text-align: right; padding: 8px; 
      border-radius: 8px; font-weight: 700; font-size: 16px; outline: none;
    }
    .market-bar input:focus { background: rgba(255,255,255,0.3); border-color: #fff; }

    /* Chart Section */
    .chart-card {
      background: var(--card); padding: 16px; border-radius: var(--radius);
      margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .chart-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .chart-title { font-size: 13px; font-weight: 700; color: var(--text); }
    .chart-val { font-size: 13px; font-weight: 700; color: var(--primary); }
    
    /* SVG Chart Container */
    .chart-box {
      width: 100%; height: 180px; position: relative;
      border-bottom: 1px solid var(--line); border-left: 1px solid var(--line);
    }
    svg { width: 100%; height: 100%; overflow: visible; }
    .tooltip {
      position: absolute; background: rgba(0,0,0,0.8); color: white;
      padding: 4px 8px; border-radius: 4px; font-size: 10px; pointer-events: none;
      opacity: 0; transition: opacity 0.2s; top: 0; left: 0; transform: translate(-50%, -100%);
    }
    .chart-label { font-size: 10px; fill: var(--sub); }
    .chart-line { fill: none; stroke: var(--primary); stroke-width: 2; stroke-linejoin: round; stroke-linecap: round; }
    .chart-area { fill: rgba(0, 94, 184, 0.1); stroke: none; }
    .chart-dot { fill: var(--card); stroke: var(--primary); stroke-width: 2; }

    /* Dashboard */
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
    .card { background: var(--card); padding: 14px; border-radius: var(--radius); }
    .label { font-size: 11px; color: var(--sub); margin-bottom: 4px; text-transform: uppercase; }
    .val { font-size: 18px; font-weight: 700; line-height: 1.2; }
    .sub-text { font-size: 11px; margin-top: 4px; }
    .green { color: var(--green); } .red { color: var(--red); }

    /* Form & List (Simplified for brevity) */
    .btn { width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--line); border-radius: 8px; font-weight: 600; color: var(--primary); cursor: pointer; margin-top: 10px; }
    .list-header { font-size: 12px; color: var(--sub); margin-bottom: 8px; display: flex; justify-content: space-between; }
    .tx-item { background: var(--card); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; border-left: 3px solid transparent; }
    .tx-item.buy { border-left-color: var(--green); } .tx-item.sell { border-left-color: var(--red); }
    
    /* Input Modal */
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99;
      background: rgba(0,0,0,0.5); display: none; align-items: flex-end;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card); width: 100%; padding: 20px 20px 40px;
      border-radius: 20px 20px 0 0; animation: slideUp 0.3s;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--line); border-radius: 8px; font-size: 16px; background: var(--bg); color: var(--text); box-sizing: border-box; }
    .btn-primary { background: var(--primary); color: white; border: none; }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>TNG 黄金资产</h1>
    <span class="badge">V5.0 图表版</span>
  </header>

  <div class="market-bar">
    <div>
      <div style="font-size:13px; font-weight:600">今日回收价 (We Buy)</div>
      <div style="font-size:10px; opacity:0.8">输入即刻记录今日市值</div>
    </div>
    <input type="number" id="marketPrice" placeholder="0.00" inputmode="decimal" step="0.01">
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <span class="chart-title">资产总值趋势 (RM)</span>
      <span class="chart-val" id="chartCurrentVal">---</span>
    </div>
    <div class="chart-box" id="chartBox">
      <div class="tooltip" id="tooltip"></div>
    </div>
    <div style="text-align: center; font-size: 10px; color: var(--sub); margin-top: 8px;">
      * 每天记录一次，取当日最后输入的市场价
    </div>
  </div>

  <div class="dashboard">
    <div class="card">
      <div class="label">持有克数</div>
      <div class="val" id="kpiHolding">0.000000</div>
    </div>
    <div class="card">
      <div class="label">浮动盈亏 (RM)</div>
      <div class="val" id="kpiUnrealized">0.00</div>
      <div class="sub-text" id="kpiRoi">---</div>
    </div>
  </div>

  <button class="btn btn-primary" onclick="openModal()">+ 记一笔交易</button>

  <div class="list-header" style="margin-top:20px">
    <span>最近交易</span>
    <span style="color:var(--primary)" onclick="clearHistory()">重置图表</span>
  </div>
  <div id="txList"></div>

</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 style="margin:0 0 16px">新增记录</h3>
    <select id="type"><option value="buy">买入</option><option value="sell">卖出</option></select>
    <input type="date" id="date">
    <input type="number" id="amount" placeholder="金额 (RM)" oninput="calcGrams()">
    <input type="number" id="price" placeholder="单价 (RM/g)" oninput="calcGrams()">
    <input type="number" id="grams" placeholder="克数 (g)">
    <div style="display:flex; gap:10px">
      <button class="btn" style="margin:0; background:var(--bg); color:var(--text)" onclick="closeModal()">取消</button>
      <button class="btn btn-primary" style="margin:0" onclick="saveTx()">保存</button>
    </div>
  </div>
</div>

<script>
  const LS_TX = "tng_tx_v5";
  const LS_MARKET = "tng_market_v5";
  const LS_HISTORY = "tng_asset_history_v5"; // 存储每天的市值记录

  const el = (id) => document.getElementById(id);

  function init(){
    el('date').value = new Date().toISOString().split('T')[0];
    el('marketPrice').value = localStorage.getItem(LS_MARKET) || "";
    
    // 监听市场价：不仅更新数字，还保存历史
    el('marketPrice').addEventListener('change', (e) => {
      const price = parseFloat(e.target.value);
      if(price > 0){
        localStorage.setItem(LS_MARKET, price);
        updateHistory(price); // 核心功能：更新今日市值
        render();
      }
    });

    render();
  }

  // --- 核心业务逻辑 ---

  function loadTx() { return JSON.parse(localStorage.getItem(LS_TX) || "[]"); }
  function loadHistory() { return JSON.parse(localStorage.getItem(LS_HISTORY) || "[]"); }

  function getMetrics(txs){
    // 计算当前持仓
    let holding = 0, cost = 0;
    txs.sort((a,b) => (a.date > b.date ? 1 : -1)).forEach(t => {
      const g = parseFloat(t.grams), a = parseFloat(t.amount);
      if(t.type === 'buy') { holding += g; cost += a; }
      else { 
        if(holding>0) cost -= (g * (cost/holding)); 
        holding -= g; 
      }
    });
    if(holding < 0.000001) { holding = 0; cost = 0; }
    return { holding, cost };
  }

  // 更新历史市值记录
  function updateHistory(currentPrice){
    const txs = loadTx();
    const { holding } = getMetrics(txs);
    if(holding <= 0) return;

    const today = new Date().toISOString().split('T')[0];
    const assetValue = holding * currentPrice;
    
    let history = loadHistory();
    // 查找今天是否已经记录过
    const idx = history.findIndex(h => h.date === today);
    
    if(idx >= 0){
      history[idx].val = assetValue; // 更新今天的记录
    } else {
      history.push({ date: today, val: assetValue }); // 新增今天的记录
    }
    
    // 只保留最近30天或全部，按需调整。这里保留全部。
    history.sort((a,b) => (a.date > b.date ? 1 : -1));
    localStorage.setItem(LS_HISTORY, JSON.stringify(history));
  }

  // --- 图表绘制逻辑 (零依赖 SVG) ---
  function drawChart(){
    const history = loadHistory();
    const box = el('chartBox');
    box.innerHTML = '<div class="tooltip" id="tooltip"></div>'; // Reset, keep tooltip div
    
    if(history.length < 2) {
      box.innerHTML += '<div style="position:absolute;top:45%;left:0;right:0;text-align:center;color:var(--sub);font-size:12px">暂无足够数据，请输入今日金价<br>积累两天以上数据后显示趋势</div>';
      return;
    }

    // 1. 计算坐标轴范围
    const values = history.map(h => h.val);
    const minVal = Math.min(...values) * 0.98; // 底部留一点空隙
    const maxVal = Math.max(...values) * 1.02; // 顶部留一点空隙
    const range = maxVal - minVal || 1;

    const w = box.offsetWidth;
    const h = box.offsetHeight;
    const pad = 10; // 内边距

    // 2. 生成路径点
    const points = history.map((d, i) => {
      const x = pad + (i / (history.length - 1)) * (w - pad * 2);
      const y = h - pad - ((d.val - minVal) / range) * (h - pad * 2);
      return { x, y, val: d.val, date: d.date };
    });

    // 3. 构建 SVG
    let pathD = `M ${points[0].x} ${points[0].y}`;
    points.forEach(p => pathD += ` L ${p.x} ${p.y}`);

    // 填充区域 (闭合路径)
    let areaD = pathD + ` L ${points[points.length-1].x} ${h} L ${points[0].x} ${h} Z`;

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    
    // 绘制填充
    const area = document.createElementNS("http://www.w3.org/2000/svg", "path");
    area.setAttribute("d", areaD);
    area.setAttribute("class", "chart-area");
    svg.appendChild(area);

    // 绘制线条
    const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
    line.setAttribute("d", pathD);
    line.setAttribute("class", "chart-line");
    svg.appendChild(line);

    // 绘制交互点
    points.forEach(p => {
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", p.x);
      circle.setAttribute("cy", p.y);
      circle.setAttribute("r", 4);
      circle.setAttribute("class", "chart-dot");
      // 简单交互
      circle.onclick = () => showTooltip(p.x, p.y, p.val, p.date);
      svg.appendChild(circle);
    });

    box.appendChild(svg);
    
    // 显示最新的值
    el('chartCurrentVal').innerText = "RM " + history[history.length-1].val.toFixed(2);
  }

  function showTooltip(x, y, val, date){
    const t = el('tooltip');
    t.innerHTML = `${date}<br>RM ${val.toFixed(2)}`;
    t.style.left = x + 'px';
    t.style.top = (y - 8) + 'px';
    t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 3000); // 3秒后消失
  }

  // --- 界面渲染 ---
  function render(){
    const txs = loadTx();
    const m = getMetrics(txs);
    const mp = parseFloat(el('marketPrice').value) || 0;

    // KPI
    el('kpiHolding').innerText = m.holding.toFixed(6);
    
    if(mp > 0 && m.holding > 0){
      const marketVal = m.holding * mp;
      const profit = marketVal - m.cost;
      const pct = (profit / m.cost) * 100;
      const sign = profit >= 0 ? "+" : "";
      const cls = profit >= 0 ? "green" : "red";
      
      el('kpiUnrealized').innerHTML = `<span class="${cls}">RM ${sign}${profit.toFixed(2)}</span>`;
      el('kpiRoi').innerHTML = `<span class="${cls}">${sign}${pct.toFixed(2)}%</span> (总值 RM${marketVal.toFixed(2)})`;
    }

    // 列表
    const list = el('txList');
    list.innerHTML = "";
    [...txs].reverse().forEach(t => {
      const div = document.createElement('div');
      div.className = `tx-item ${t.type}`;
      div.innerHTML = `
        <div><div style="font-weight:700;font-size:14px">${t.type==='buy'?'买入':'卖出'}</div><div style="font-size:11px;color:#888">${t.date}</div></div>
        <div style="text-align:right"><div style="font-weight:700">RM ${t.amount}</div><div style="font-size:11px;color:#888">${Number(t.grams).toFixed(4)}g</div></div>
      `;
      list.appendChild(div);
    });

    // 绘制图表
    drawChart();
  }

  // --- 交易操作 ---
  function openModal(){ el('modal').classList.add('show'); }
  function closeModal(){ el('modal').classList.remove('show'); }
  
  function calcGrams(){
    const a = parseFloat(el('amount').value), p = parseFloat(el('price').value);
    if(a && p) el('grams').value = (a/p).toFixed(6);
  }

  function saveTx(){
    const type = el('type').value;
    const date = el('date').value;
    const amount = el('amount').value;
    const grams = el('grams').value;
    const price = el('price').value;
    
    if(!amount || !grams){ alert("请填写完整"); return; }
    
    const txs = loadTx();
    txs.push({ id: Date.now(), type, date, amount, grams, price });
    localStorage.setItem(LS_TX, JSON.stringify(txs));
    
    closeModal();
    // 交易变动后，如果当前有市场价，应该重新计算一下今日市值
    const mp = parseFloat(el('marketPrice').value);
    if(mp) updateHistory(mp);
    
    render();
  }

  function clearHistory(){
    if(confirm("确定清除图表历史数据？(交易记录保留)")){
      localStorage.removeItem(LS_HISTORY);
      render();
    }
  }

  init();
</script>
</body>
</html>
