<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TNG é»„é‡‘ç®¡å®¶</title>
  <style>
    :root{
      /* åŸºç¡€å˜é‡ */
      --primary: #007aff; 
      --text: #000; --sub: #8e8e93;
      --card-bg: rgba(255, 255, 255, 0.65); /* é«˜é€ç»ç’ƒ */
      --nav-bg: rgba(255, 255, 255, 0.8);
      --blur: blur(25px);
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
      --border: 1px solid rgba(255, 255, 255, 0.4);
      --safe-pb: env(safe-area-inset-bottom);
      --nav-h: 60px;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --text: #fff; --sub: #98989d;
        --card-bg: rgba(30, 30, 30, 0.6);
        --nav-bg: rgba(20, 20, 20, 0.8);
        --border: 1px solid rgba(255, 255, 255, 0.1);
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; 
      /* iOS é£æ ¼å¤šå½©åŠ¨æ€èƒŒæ™¯ */
      background: radial-gradient(circle at 0% 0%, #e0f7fa 0%, #e1bee7 50%, #fff9c4 100%);
      background-attachment: fixed;
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", sans-serif;
      padding-bottom: calc(var(--nav-h) + 20px + var(--safe-pb));
      user-select: none;
      -webkit-font-smoothing: antialiased;
    }
    @media (prefers-color-scheme: dark) {
      body { background: radial-gradient(circle at 0% 0%, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%); }
    }

    /* å®¹å™¨åŠ¨ç”» */
    .view { display: none; padding: 20px; padding-top: 70px; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

    /* é¡¶éƒ¨å¯¼èˆª (Glass) */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px; z-index: 90;
      background: var(--nav-bg); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      border-bottom: var(--border); display: flex; justify-content: space-between; align-items: flex-end;
      padding: 0 20px 12px;
    }
    .app-title { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
    .settings-btn { font-size: 18px; padding: 4px; opacity: 0.8; }

    /* æ°´æ»´å¡ç‰‡é€šç”¨æ ·å¼ */
    .glass-card {
      background: var(--card-bg); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      border-radius: 24px; border: var(--border); box-shadow: var(--shadow);
      padding: 20px; margin-bottom: 16px; position: relative; overflow: hidden;
    }

    /* æ ¸å¿ƒ KPI å¡ç‰‡ (å¤§æ°´æ»´) */
    .hero-card {
      text-align: center; padding: 30px 20px;
      background: linear-gradient(135deg, rgba(0,122,255,0.85), rgba(0,198,255,0.85));
      color: white; border: none; box-shadow: 0 10px 30px rgba(0,122,255,0.35);
    }
    .hero-label { font-size: 13px; opacity: 0.9; font-weight: 500; margin-bottom: 4px; }
    .hero-val { font-size: 40px; font-weight: 800; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .hero-tag { 
      font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 12px; 
      border-radius: 20px; display: inline-block; margin-top: 8px; backdrop-filter: blur(5px);
    }

    /* è¾“å…¥æ¡ */
    .input-row {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--card-bg); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      padding: 16px 20px; border-radius: 20px; margin-bottom: 20px;
      box-shadow: var(--shadow); border: var(--border);
    }
    .input-row input {
      border: none; background: transparent; text-align: right; 
      font-size: 20px; font-weight: 700; color: var(--primary); width: 140px; outline: none;
    }

    /* æ•°æ®ç½‘æ ¼ */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .stat-item { padding: 16px; display: flex; flex-direction: column; justify-content: center; }
    .stat-label { font-size: 12px; color: var(--sub); margin-bottom: 4px; font-weight: 500; }
    .stat-val { font-size: 18px; font-weight: 700; }

    /* åˆ—è¡¨é¡¹ */
    .list-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 0; border-bottom: 0.5px solid rgba(150,150,150,0.1);
    }
    .list-row:last-child { border-bottom: none; }
    .row-main { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
    .row-sub { font-size: 12px; color: var(--sub); }
    .tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 700; margin-right: 8px; vertical-align: middle; }
    .tag.buy { background: rgba(52,199,89,0.15); color: #34c759; }
    .tag.sell { background: rgba(255,59,48,0.15); color: #ff3b30; }

    /* å›¾è¡¨ */
    .chart-container { height: 240px; width: 100%; position: relative; }
    svg { width: 100%; height: 100%; overflow: visible; }
    .chart-path-area { fill: url(#grad); opacity: 0.4; }
    .chart-path-line { fill: none; stroke: var(--primary); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
    .chart-dot { fill: #fff; stroke: var(--primary); stroke-width: 2.5; }
    .axis-label { font-size: 10px; fill: var(--sub); }

    /* åº•éƒ¨å¯¼èˆª (Float) */
    .dock {
      position: fixed; bottom: calc(20px + var(--safe-pb)); left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 320px; height: 60px;
      background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-radius: 30px; display: flex; justify-content: space-around; align-items: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.5); z-index: 100;
    }
    @media (prefers-color-scheme: dark) { .dock { background: rgba(40,40,40,0.85); border: 1px solid rgba(255,255,255,0.15); } }
    
    .dock-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      width: 50px; height: 50px; color: var(--sub); border-radius: 50%; transition: 0.2s;
    }
    .dock-btn.active { color: var(--primary); background: rgba(0,122,255,0.1); }
    .dock-btn svg { width: 24px; height: 24px; fill: currentColor; }

    /* FAB (è®°è´¦æŒ‰é’®) */
    .fab {
      position: fixed; bottom: calc(90px + var(--safe-pb)); right: 20px;
      width: 56px; height: 56px; background: #007aff; border-radius: 50%;
      color: white; display: flex; justify-content: center; align-items: center;
      box-shadow: 0 8px 20px rgba(0,122,255,0.4); z-index: 90; transition: transform 0.1s;
    }
    .fab:active { transform: scale(0.9); }

    /* å¼¹çª—ç³»ç»Ÿ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200;
      background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.show { display: flex; opacity: 1; }
    .modal-card {
      width: 85%; max-width: 340px; background: var(--nav-bg); backdrop-filter: blur(30px);
      border-radius: 24px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      border: var(--border);
    }
    .modal-overlay.show .modal-card { transform: scale(1); }

    /* è¡¨å•å…ƒç´  */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; color: var(--sub); margin-bottom: 8px; margin-left: 4px; }
    input, select { 
      width: 100%; padding: 14px; background: rgba(120,120,128,0.1); border: none; border-radius: 12px;
      font-size: 17px; color: var(--text); outline: none; transition: 0.2s;
    }
    input:focus { background: rgba(120,120,128,0.2); }
    
    .btn-primary { width: 100%; padding: 14px; background: #007aff; color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; margin-top: 10px; }
    .btn-text { width: 100%; padding: 12px; background: transparent; color: var(--sub); border: none; font-size: 14px; margin-top: 4px; }
    
    .segment-control { display: flex; background: rgba(120,120,128,0.1); padding: 3px; border-radius: 10px; margin-bottom: 16px; }
    .segment-opt { flex: 1; text-align: center; padding: 8px; font-size: 13px; border-radius: 8px; font-weight: 500; color: var(--sub); }
    .segment-opt.active { background: var(--card-bg); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* å†å²è¯¦æƒ…è¡Œä¼˜åŒ– */
    .hist-detail-row {
      display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 0.5px solid rgba(150,150,150,0.1);
    }
    .hist-date { font-weight: 600; font-size: 15px; }
    .hist-val { font-weight: 700; font-size: 15px; color: var(--primary); }
    .hist-meta { font-size: 11px; color: var(--sub); margin-top: 2px; }
    .hist-right { text-align: right; }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="app-title">TNG é»„é‡‘ç®¡å®¶</div>
  <div class="settings-btn" onclick="openSettings()">âš™ï¸</div>
</div>

<div id="view-home" class="view active">
  <div class="glass-card hero-card">
    <div class="hero-label">å½“å‰æŒä»“ä¼°å€¼ (RM)</div>
    <div class="hero-val" id="kpiVal">0.00</div>
    <div class="hero-tag" id="kpiProfit">ç›ˆäº: ---</div>
  </div>

  <div class="input-row">
    <div style="font-weight:600; font-size:15px">ä»Šæ—¥é‡‘ä»· (We Buy)</div>
    <input type="number" id="marketPrice" placeholder="0.00" inputmode="decimal">
  </div>

  <div class="grid-2">
    <div class="glass-card stat-item">
      <div class="stat-label">æŒæœ‰å…‹æ•° (g)</div>
      <div class="stat-val" id="kpiHolding">0.0000</div>
    </div>
    <div class="glass-card stat-item">
      <div class="stat-label">å¹³å‡æˆæœ¬ (RM)</div>
      <div class="stat-val" id="kpiAvg">0.00</div>
    </div>
  </div>

  <div class="glass-card">
    <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:var(--sub)">æœ€è¿‘äº¤æ˜“</div>
    <div id="txList"></div>
  </div>
</div>

<div id="view-chart" class="view">
  <div class="glass-card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center">
      <div style="font-weight:700; font-size:16px">èµ„äº§èµ°åŠ¿</div>
      <div style="font-size:12px; color:var(--primary); background:rgba(0,122,255,0.1); padding:4px 10px; border-radius:12px" onclick="openHistModal()">+ è¡¥å½•</div>
    </div>
    <div class="chart-container" id="chartBox"></div>
  </div>

  <div class="glass-card">
    <div style="font-size:14px; font-weight:700; margin-bottom:6px; color:var(--sub)">å†å²è¯¦æƒ…</div>
    <div style="font-size:11px; color:var(--sub); margin-bottom:12px">ç‚¹å‡»åˆ—è¡¨é¡¹å¯ä¿®æ”¹é‡‘é¢æˆ–åˆ é™¤</div>
    <div id="histList"></div>
  </div>
</div>

<div class="dock">
  <div class="dock-btn active" id="nav-home" onclick="switchTab('home')">
    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
  </div>
  <div class="dock-btn" id="nav-chart" onclick="switchTab('chart')">
    <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
  </div>
</div>

<div class="fab" id="fabBtn" onclick="openTxModal()">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
</div>

<div class="modal-overlay" id="txModal">
  <div class="modal-card">
    <h3 style="margin:0 0 20px; text-align:center" id="txTitle">è®°ä¸€ç¬”</h3>
    <div class="form-group">
      <div class="segment-control">
        <div class="segment-opt active" id="type-buy" onclick="setTxType('buy')">ä¹°å…¥</div>
        <div class="segment-opt" id="type-sell" onclick="setTxType('sell')">å–å‡º</div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" id="tDate"></div>
    <div class="form-group"><label class="form-label">æ€»é‡‘é¢ (RM)</label><input type="number" id="tAmt" placeholder="0.00" inputmode="decimal" oninput="calcG()"></div>
    <div class="grid-2">
      <div><label class="form-label">å•ä»·</label><input type="number" id="tPrice" placeholder="0.00" oninput="calcG()"></div>
      <div><label class="form-label">å…‹æ•°</label><input type="number" id="tGrams" disabled></div>
    </div>
    <button class="btn-primary" onclick="saveTx()">ä¿å­˜</button>
    <button class="btn-text" id="btnDelTx" style="display:none; color:#ff3b30" onclick="delTx()">åˆ é™¤</button>
    <button class="btn-text" onclick="closeModal('txModal')">å–æ¶ˆ</button>
  </div>
</div>

<div class="modal-overlay" id="histModal">
  <div class="modal-card">
    <h3 style="margin:0 0 20px; text-align:center" id="histTitle">è¡¥å½•èµ„äº§</h3>
    
    <div class="segment-control" id="histSeg">
      <div class="segment-opt active" id="mode-val" onclick="setHistMode('val')">æŒ‰æ€»å€¼</div>
      <div class="segment-opt" id="mode-price" onclick="setHistMode('price')">æŒ‰é‡‘ä»·</div>
    </div>

    <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" id="hDate"></div>
    
    <div id="box-val">
      <div class="form-group"><label class="form-label">èµ„äº§æ€»å€¼ (RM)</label><input type="number" id="hTotalVal" placeholder="ä¾‹å¦‚ 1500.00"></div>
    </div>
    <div id="box-price" style="display:none">
      <div class="form-group"><label class="form-label">å½“æ—¶é‡‘ä»· (RM/g)</label><input type="number" id="hUnitPrice" placeholder="ä¾‹å¦‚ 580.00"></div>
    </div>

    <button class="btn-primary" onclick="saveHist()">ä¿å­˜</button>
    <button class="btn-text" id="btnDelHist" style="display:none; color:#ff3b30" onclick="delHist()">åˆ é™¤æ­¤è®°å½•</button>
    <button class="btn-text" onclick="closeModal('histModal')">å–æ¶ˆ</button>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:20px">è®¾ç½®</h3>
    <button class="btn-text" onclick="exportData()" style="text-align:left; border-bottom:1px solid #eee">ğŸ“¤ å¤‡ä»½æ•°æ® (JSON)</button>
    <div style="position:relative">
      <button class="btn-text" style="text-align:left; border-bottom:1px solid #eee">ğŸ“¥ æ¢å¤å¤‡ä»½</button>
      <input type="file" onchange="importData(this)" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0">
    </div>
    <button class="btn-text" onclick="resetAll()" style="text-align:left; color:#ff3b30">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    <button class="btn-primary" style="margin-top:20px" onclick="closeModal('settingsModal')">å…³é—­</button>
  </div>
</div>

<script>
  // --- æ•°æ®åˆå§‹åŒ– ---
  const PRELOAD_TX = [
    {"ts":1769197202982,"type":"buy","date":"2025-05-18","amount":10,"grams":0.022438,"price":445.669382},
    {"ts":1769197251472,"type":"buy","date":"2025-12-25","amount":10,"grams":0.016995,"price":588.417299},
    {"ts":1769197276233,"type":"buy","date":"2025-12-31","amount":10,"grams":0.017494,"price":571.610734},
    {"ts":1769197303771,"type":"buy","date":"2026-01-21","amount":500,"grams":0.796725,"price":627.568989},
    {"ts":1769197324261,"type":"buy","date":"2026-01-23","amount":1000,"grams":1.553877,"price":643.551401}
  ];
  const PRELOAD_HIST = [
    {"date":"2026-01-22","val":558.05},
    {"date":"2026-01-23","val":1547.97},
    {"date":"2026-01-24","val":1559.44},
    {"date":"2026-01-25","val":1558.89}
  ];

  const KEY = { TX: 'tng_tx_v16', HS: 'tng_hs_v16', MK: 'tng_mk_v16' };
  const el = id => document.getElementById(id);
  let editId = null, editHistDate = null, histMode = 'val', txType = 'buy';

  function init(){
    if(!localStorage.getItem(KEY.TX)) localStorage.setItem(KEY.TX, JSON.stringify(PRELOAD_TX));
    if(!localStorage.getItem(KEY.HS)) localStorage.setItem(KEY.HS, JSON.stringify(PRELOAD_HIST));
    
    el('tDate').value = new Date().toISOString().split('T')[0];
    const savedP = localStorage.getItem(KEY.MK);
    if(savedP) el('marketPrice').value = savedP;

    el('marketPrice').addEventListener('change', e => {
      const p = parseFloat(e.target.value);
      if(p){ localStorage.setItem(KEY.MK, p); autoRecHist(p); render(); }
    });

    render();
  }

  function getDB(){ return { tx: JSON.parse(localStorage.getItem(KEY.TX)||'[]'), hs: JSON.parse(localStorage.getItem(KEY.HS)||'[]') }; }
  
  // è®¡ç®—æˆªè‡³æŸæ—¥æœŸçš„æŒä»“ (å¦‚æœ date ä¸º null åˆ™è®¡ç®—æ‰€æœ‰)
  function getHoldingAt(dateStr = null){
    const tx = getDB().tx;
    let h=0, c=0;
    // æ’åºä¿è¯è®¡ç®—é¡ºåº
    const sorted = tx.sort((a,b)=>a.date>b.date?1:-1);
    
    for(let t of sorted){
      if(dateStr && t.date > dateStr) break; // è¶…è¿‡æ—¥æœŸåœæ­¢
      const g=Number(t.grams), a=Number(t.amount);
      if(t.type=='buy'){ h+=g; c+=a; }
      else { if(h>0)c-=(g*(c/h)); h-=g; }
    }
    return { h:Math.max(0,h), c:Math.max(0,c) };
  }

  function render(){
    const {h, c} = getHoldingAt(); // Current Stats
    const mp = parseFloat(el('marketPrice').value)||0;

    // 1. Home KPI
    el('kpiHolding').innerText = h.toFixed(4);
    el('kpiAvg').innerText = h>0 ? (c/h).toFixed(2) : '0.00';
    if(mp && h){
      const v = h*mp, pl = v-c, pct = (pl/c)*100;
      el('kpiVal').innerText = v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
      el('kpiProfit').innerHTML = `ç›ˆäº: <span style="color:${pl>=0?'#fff':'#ffcccc'}">RM ${pl>=0?'+':''}${pl.toFixed(2)} (${pct.toFixed(2)}%)</span>`;
    } else {
      el('kpiVal').innerText = '0.00';
      el('kpiProfit').innerText = 'è¾“å…¥é‡‘ä»·æŸ¥çœ‹ç›ˆäº';
    }

    // 2. Transaction List
    const list = el('txList'); list.innerHTML = '';
    const tx = getDB().tx.sort((a,b)=>b.ts-a.ts);
    tx.slice(0,10).forEach(t=>{
      list.innerHTML += `
        <div class="list-row" onclick="editT(${t.ts})">
          <div>
            <div class="row-main"><span class="tag ${t.type}">${t.type=='buy'?'ä¹°':'å–'}</span>RM ${Number(t.amount).toFixed(2)}</div>
            <div class="row-sub">${t.date}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:14px; font-weight:600">${Number(t.grams).toFixed(4)}g</div>
            <div class="row-sub">@ ${Number(t.price).toFixed(2)}</div>
          </div>
        </div>`;
    });

    // 3. History Detailed List (Backfill Logic)
    const hList = el('histList'); hList.innerHTML = '';
    const hs = getDB().hs.sort((a,b)=>b.date>a.date?1:-1); // Newest first
    
    hs.forEach(h => {
      // Back-calculate holding at that date
      const stats = getHoldingAt(h.date);
      const holdingThen = stats.h;
      const priceThen = holdingThen > 0 ? (h.val / holdingThen) : 0;
      
      hList.innerHTML += `
        <div class="hist-detail-row" onclick="editHist('${h.date}', ${h.val})">
          <div>
            <div class="hist-date">${h.date}</div>
            <div class="hist-meta">æŒæœ‰: ${holdingThen.toFixed(4)} g</div>
          </div>
          <div class="hist-right">
            <div class="hist-val">RM ${Number(h.val).toFixed(2)}</div>
            <div class="hist-meta">å¸‚ä»·: ${priceThen.toFixed(2)}/g</div>
          </div>
        </div>`;
    });
  }

  function drawChart(){
    const {hs} = getDB();
    const box = el('chartBox'); box.innerHTML = '';
    if(hs.length<2) { box.innerHTML='<div style="text-align:center;padding-top:100px;font-size:12px;color:var(--sub)">æš‚æ— è¶³å¤Ÿæ•°æ®</div>'; return; }
    
    const vals = hs.map(x=>x.val);
    const min=Math.min(...vals)*0.99, max=Math.max(...vals)*1.01, h=240, w=box.offsetWidth;
    const pts = hs.sort((a,b)=>a.date>b.date?1:-1).map((d,i)=>({ x: (i/(hs.length-1))*w, y: h-20 - ((d.val-min)/(max-min))*(h-40), v:d.val, d:d.date }));

    let pStr = `M ${pts[0].x} ${pts[0].y}`;
    pts.forEach(p => pStr += ` L ${p.x} ${p.y}`);

    // Generate Date Labels (Start, End, Middle)
    let labels = '';
    if(pts.length > 0) {
       labels += `<text x="${pts[0].x+5}" y="${h-5}" class="axis-label" style="text-anchor:start">${pts[0].d.slice(5)}</text>`;
       labels += `<text x="${pts[pts.length-1].x-5}" y="${h-5}" class="axis-label" style="text-anchor:end">${pts[pts.length-1].d.slice(5)}</text>`;
       if(pts.length > 4) {
         let mid = Math.floor(pts.length/2);
         labels += `<text x="${pts[mid].x}" y="${h-5}" class="axis-label">${pts[mid].d.slice(5)}</text>`;
       }
    }

    box.innerHTML = `<svg><defs><linearGradient id="grad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#007aff" stop-opacity="0.3"/><stop offset="100%" stop-color="#007aff" stop-opacity="0"/></linearGradient></defs>
      <path d="${pStr} L ${w} ${h-20} L 0 ${h-20} Z" class="chart-path-area"/>
      <path d="${pStr}" class="chart-path-line"/>
      ${pts.map(p=>`<circle cx="${p.x}" cy="${p.y}" r="4" class="chart-dot" onclick="alert('${p.d}: RM ${p.v}')"/>`).join('')}
      ${labels}
    </svg>`;
  }

  // --- Modal & Form Actions ---
  function openTxModal(){ 
    editId=null; el('txTitle').innerText="è®°ä¸€ç¬”"; el('btnDelTx').style.display='none'; 
    el('tAmt').value=''; el('tPrice').value=''; el('tGrams').value=''; 
    openModal('txModal'); 
  }
  
  function editT(ts){ 
    const t=getDB().tx.find(x=>x.ts==ts); if(!t)return; editId=ts; 
    el('txTitle').innerText="ä¿®æ”¹è®°å½•"; el('btnDelTx').style.display='block'; 
    setTxType(t.type); el('tDate').value=t.date; el('tAmt').value=t.amount; 
    el('tPrice').value=t.price; el('tGrams').value=t.grams; 
    openModal('txModal'); 
  }
  
  function openHistModal(){ 
    editHistDate=null; el('histTitle').innerText="è¡¥å½•èµ„äº§"; 
    el('hDate').value=new Date().toISOString().split('T')[0]; el('hDate').disabled=false;
    el('btnDelHist').style.display='none'; el('histSeg').style.display='flex';
    setHistMode('val'); openModal('histModal'); 
  }

  function editHist(date, val){
    editHistDate = date; 
    el('histTitle').innerText = "ä¿®æ”¹å†å² (æ—¥æœŸä¸å¯å˜)";
    el('hDate').value = date; el('hDate').disabled = true;
    el('hTotalVal').value = val;
    el('btnDelHist').style.display = 'block'; 
    el('histSeg').style.display = 'none'; // Force value edit mode for simplicity
    setHistMode('val');
    openModal('histModal');
  }

  function setHistMode(m){ 
    histMode = m;
    el('mode-val').className=m=='val'?'segment-opt active':'segment-opt';
    el('mode-price').className=m=='price'?'segment-opt active':'segment-opt';
    el('box-val').style.display=m=='val'?'block':'none';
    el('box-price').style.display=m=='price'?'block':'none';
  }

  function setTxType(t){
    txType = t;
    el('type-buy').className=t=='buy'?'segment-opt active':'segment-opt';
    el('type-sell').className=t=='sell'?'segment-opt active':'segment-opt';
  }

  function calcG(){ const a=el('tAmt').value, p=el('tPrice').value; if(a&&p)el('tGrams').value=(a/p).toFixed(6); }

  function saveTx(){
    const date=el('tDate').value, amt=el('tAmt').value, price=el('tPrice').value, grams=el('tGrams').value;
    if(!amt||!grams)return alert("è¯·å¡«å†™å®Œæ•´");
    let tx = getDB().tx;
    const rec = { ts: editId||Date.now(), type: txType, date, amount: amt, grams, price };
    if(editId){ const i=tx.findIndex(x=>x.ts==editId); if(i>-1)tx[i]=rec; } else tx.push(rec);
    localStorage.setItem(KEY.TX, JSON.stringify(tx));
    closeModal('txModal'); render();
  }

  function saveHist(){
    const d=el('hDate').value; let val=0;
    if(histMode=='val'){
      val=parseFloat(el('hTotalVal').value); if(!val)return alert("è¾“å…¥é‡‘é¢");
    } else {
      const p=parseFloat(el('hUnitPrice').value); if(!p)return alert("è¾“å…¥å•ä»·");
      const s=getHoldingAt(d); if(s.h<=0)return alert("å½“æ—¶æ— æŒä»“"); val=s.h*p;
    }
    let hs=getDB().hs; const i=hs.findIndex(x=>x.date==d);
    if(i>-1) hs[i].val=val; else hs.push({date:d, val});
    localStorage.setItem(KEY.HS, JSON.stringify(hs));
    closeModal('histModal'); render(); drawChart();
  }
  
  function delTx(){ if(confirm("åˆ é™¤?")){ localStorage.setItem(KEY.TX, JSON.stringify(getDB().tx.filter(x=>x.ts!=editId))); closeModal('txModal'); render(); } }
  function delHist(){ if(confirm("åˆ é™¤?")){ localStorage.setItem(KEY.HS, JSON.stringify(getDB().hs.filter(x=>x.date!=editHistDate))); closeModal('histModal'); render(); drawChart(); } }
  function autoRecHist(p){ const {h}=getHoldingAt(); if(h>0) { let hs=getDB().hs; const d=new Date().toISOString().split('T')[0]; const i=hs.findIndex(x=>x.date==d); if(i>-1)hs[i].val=h*p; else hs.push({date:d, val:h*p}); localStorage.setItem(KEY.HS,JSON.stringify(hs)); } }

  // --- UI Utils ---
  function openModal(id){ el(id).classList.add('show'); }
  function closeModal(id){ el(id).classList.remove('show'); }
  function openSettings(){ openModal('settingsModal'); }
  function switchTab(t){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); el('view-'+t).classList.add('active');
    el('nav-home').className=t=='home'?'dock-btn active':'dock-btn'; el('nav-chart').className=t=='chart'?'dock-btn active':'dock-btn';
    el('fabBtn').style.display=t=='home'?'flex':'none';
    if(t=='chart') drawChart();
  }
  
  function exportData(){ const b=new Blob([JSON.stringify(getDB())],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click(); }
  function importData(i){ const r=new FileReader(); r.onload=e=>{ try{const d=JSON.parse(e.target.result); if(d.tx)localStorage.setItem(KEY.TX,JSON.stringify(d.tx)); if(d.hs)localStorage.setItem(KEY.HS,JSON.stringify(d.hs)); location.reload();}catch{alert('Error');} }; r.readAsText(i.files[0]); }
  function resetAll(){ if(confirm("æ¸…ç©º?")){ localStorage.clear(); location.reload(); } }

  init();
</script>
</body>
</html>
