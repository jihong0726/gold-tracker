<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
  <meta charset="UTF-8" />
  <title>UsTrip Finance v17.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" id="theme-color">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/10543/10543323.png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet" />

  <style>
    /* 1. å…¨å±€é”å®š */
    html, body { height: 100dvh; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: "Noto Sans SC", sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
    
    /* 2. App å®¹å™¨ */
    #app { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 480px; margin: 0 auto; background: #fff; }
    
    input, button { outline: none !important; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

    /* ================= ğŸŸ¢ é‡‘åº“é¡µé¢ (Scrollable) ================= */
    .page-scrollable {
      flex: 1; 
      overflow-y: auto; 
      overflow-x: hidden;
      padding: 80px 20px 20px;
    }

    /* ================= ğŸ”µ è®¡ç®—é¡µé¢ (Fixed Layout) ================= */
    .page-fixed {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* ä¸ŠåŠåŒºï¼šæ˜¾ç¤ºå± */
    .calc-display-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 80px 24px 10px;
      min-height: 0;
    }
    .font-clamp-big { font-size: clamp(3rem, 12vw, 5rem); line-height: 1; }
    .font-clamp-mid { font-size: clamp(2rem, 8vw, 3.5rem); line-height: 1.1; }

    /* ä¸‹åŠåŒºï¼šé”®ç›˜ */
    .calc-keyboard-area {
      flex: 0 0 auto;
      height: 55%;
      background: rgb(241 245 249);
      border-top-left-radius: 2.5rem;
      border-top-right-radius: 2.5rem;
      position: relative;
      z-index: 20;
      padding-top: 2.5rem;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
      transition: background-color .3s;
    }
    html.dark .calc-keyboard-area { background: rgb(15 23 42); }

    /* å†å²èƒ¶å›Š (æ‚¬æµ®æŒ‰é’®) */
    .history-capsule {
      position: absolute; top: 0.8rem; left: 50%; transform: translateX(-50%);
      background: #fff; padding: .5rem 1rem; border-radius: 99px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid rgb(226 232 240);
      display: flex; align-items: center; gap: .5rem; cursor: pointer; z-index: 50; /* æé«˜å±‚çº§ */
      transition: all 0.2s;
    }
    .history-capsule:active { transform: translateX(-50%) scale(0.95); }
    html.dark .history-capsule { background: rgb(30 41 59); border-color: rgb(51 65 85); }
    .capsule-text { font-size: .65rem; font-weight: 900; letter-spacing: .05em; text-transform: uppercase; color: rgb(71 85 105); }
    html.dark .capsule-text { color: rgb(203 213 225); }

    /* ğŸŒŸ å†å²è®°å½•æ»‘åŠ¨åˆ—è¡¨ (Swipe Actions) */
    .swipe-list-item {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      margin-bottom: 0.75rem;
    }
    .swipe-content {
      position: relative;
      z-index: 10;
      background: white;
      transition: transform 0.2s ease-out;
      display: flex;
      align-items: center;
      padding: 1rem;
      border: 1px solid #f1f5f9;
    }
    html.dark .swipe-content { background: #1e293b; border-color: #334155; }
    
    /* æ»‘åŠ¨æ“ä½œèƒŒæ™¯å±‚ */
    .swipe-actions {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      z-index: 1;
    }
    .action-left { background: #eab308; width: 50%; display: flex; align-items: center; padding-left: 1.5rem; color: white; font-weight: bold; }
    .action-right { background: #ef4444; width: 50%; display: flex; align-items: center; justify-content: flex-end; padding-right: 1.5rem; color: white; font-weight: bold; }

    /* è®¡ç®—å™¨ç½‘æ ¼ */
    .calc-grid { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      grid-template-rows: repeat(5, 1fr); 
      gap: 10px; 
      padding: 0 16px 16px; 
      flex: 1; 
    }
    .calc-btn { 
      @apply rounded-[1.2rem] flex items-center justify-center text-2xl font-bold transition-all duration-75 active:scale-95 shadow-sm border-b-2 border-slate-200 dark:border-slate-800; 
      height: 100%; width: 100%;
    }
    .btn-num { @apply bg-white text-slate-800 dark:bg-slate-800 dark:text-slate-100; font-size: 1.6rem; }
    .btn-op { @apply bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400 text-2xl font-black border-indigo-100 dark:border-indigo-900; }
    .btn-ac { @apply bg-red-50 text-red-500 dark:bg-red-900/20 dark:text-red-400 text-lg font-black border-red-100 dark:border-red-900; }
    .btn-eq { @apply bg-emerald-500 text-white shadow-lg shadow-emerald-200/50 dark:shadow-none text-2xl active:bg-emerald-600 border-none; }

    /* ================= ğŸŒŸ å¼¹çª—ä¼˜åŒ– ================= */
    .rate-card {
      @apply bg-slate-50 dark:bg-slate-900 rounded-2xl p-4 border border-slate-100 dark:border-slate-700 flex justify-between items-center mb-6;
    }
    
    /* ğŸŒŸ æ™ºèƒ½å˜è‰²è¾“å…¥æ¡† */
    .exchange-input-box {
      @apply rounded-3xl p-2 border-2 border-transparent transition-all flex items-center shadow-sm;
    }
    /* è“è‰²æ¨¡å¼ (MYR) */
    .box-myr { @apply bg-blue-50 dark:bg-blue-900/20 focus-within:border-blue-300 dark:focus-within:border-blue-700; }
    /* æ©™è‰²æ¨¡å¼ (TWD) */
    .box-twd { @apply bg-orange-50 dark:bg-orange-900/20 focus-within:border-orange-300 dark:focus-within:border-orange-700; }

    .exchange-input {
      @apply flex-1 bg-transparent font-black text-4xl outline-none text-slate-900 dark:text-white placeholder-slate-300 dark:placeholder-slate-600 ml-4 py-4 min-w-0;
    }
    .currency-toggle {
      @apply flex items-center gap-2 px-5 py-3 rounded-2xl font-black text-sm transition-all cursor-pointer select-none active:scale-95 ml-2 mr-1 shadow-sm border border-transparent;
    }
    .toggle-twd { @apply bg-orange-100 text-orange-600 border-orange-200 dark:bg-orange-800 dark:text-orange-100; }
    .toggle-myr { @apply bg-blue-100 text-blue-600 border-blue-200 dark:bg-blue-800 dark:text-blue-100; }

    .cat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px; }
    .cat-item {
      @apply flex flex-col items-center justify-center p-2 rounded-xl border border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 cursor-pointer transition-all active:scale-90;
    }
    .cat-item.active { @apply bg-indigo-50 dark:bg-indigo-900/30 border-indigo-200 dark:border-indigo-700; }
    .cat-emoji { font-size: 24px; margin-bottom: 4px; }
    .cat-name { font-size: 10px; font-weight: bold; color: #64748b; }
    .active .cat-name { @apply text-indigo-600 dark:text-indigo-300; }

    /* åº•éƒ¨ Tab */
    .bottom-nav {
      flex: 0 0 auto;
      background: rgba(255,255,255,0.95);
      border-top: 1px solid #f1f5f9;
      padding-top: 10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      z-index: 40;
    }
    html.dark .bottom-nav { background: rgba(15,23,42,0.95); border-color: #1e293b; }

    .transaction-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
    .item-exchange { border-left-color: #10b981; }
    .item-expense { border-left-color: #6366f1; }
    
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .slide-enter-active, .slide-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-enter-from, .slide-leave-to { transform: translateY(100%); }
  </style>
</head>
<body class="bg-white dark:bg-slate-950 text-slate-800 dark:text-slate-100 transition-colors duration-300">

<div id="app">

  <header class="absolute top-0 left-0 right-0 z-50 px-6 py-4 flex justify-between items-center pointer-events-none">
    <div class="flex items-center gap-3 pointer-events-auto">
      <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg transition-all duration-300" 
           :class="currentTab === 'assets' ? 'bg-slate-800 dark:bg-slate-700' : 'bg-emerald-500'">
        <i class="fas" :class="currentTab === 'assets' ? 'fa-wallet' : 'fa-calculator'"></i>
      </div>
      <h1 v-if="currentTab==='assets'" class="text-xl font-black tracking-tight text-slate-900 dark:text-white">æˆ‘çš„é‡‘åº“</h1>
    </div>
    <div class="flex gap-4 text-slate-400 pointer-events-auto">
      <button @click="toggleDark" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800/60 flex items-center justify-center transition-colors active:scale-90 hover:bg-slate-200 dark:hover:bg-slate-700"><i class="fas text-sm" :class="isDark ? 'fa-sun text-yellow-400' : 'fa-moon'"></i></button>
      <template v-if="currentTab === 'assets'">
        <button @click="exportAllData" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800/60 flex items-center justify-center transition-colors"><i class="fas fa-save"></i></button>
        <button @click="triggerImport" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800/60 flex items-center justify-center transition-colors"><i class="fas fa-upload"></i></button>
      </template>
    </div>
  </header>

  <div v-show="currentTab === 'assets'" class="page-scrollable">
    <section class="bg-gradient-to-br from-slate-800 to-slate-900 dark:from-slate-900 dark:to-slate-950 p-8 rounded-[2.5rem] text-white shadow-2xl shadow-slate-200 dark:shadow-none relative overflow-hidden mb-6">
      <div class="relative z-10">
        <div class="flex justify-between items-start mb-8">
          <div>
            <p class="text-xs font-bold opacity-60 uppercase tracking-widest mb-2">å°å¸å‰©ä½™</p>
            <h2 class="text-6xl font-black mono leading-none tracking-tight">{{ Math.round(twdBalance) }}</h2>
          </div>
          <div class="text-right">
            <span class="text-[10px] font-bold opacity-60 uppercase block mb-1">å¹³å‡æ±‡ç‡</span>
            <span class="text-xs font-bold mono text-emerald-400 bg-white/10 px-2.5 py-1 rounded-md backdrop-blur-md">1 : {{ averageRate }}</span>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-6 border-t border-white/10 pt-6">
          <div><p class="text-[10px] opacity-50 uppercase mb-1 font-bold">ç°é‡‘å·²èŠ±</p><p class="text-xl font-bold mono opacity-90">{{ totalCashSpent }}</p></div>
          <div><p class="text-[10px] opacity-50 uppercase mb-1 font-bold">å¡ç‰‡å·²èŠ±</p><p class="text-xl font-bold mono opacity-90">{{ totalCardSpent }}</p></div>
        </div>
      </div>
    </section>

    <section class="grid grid-cols-2 gap-4 mb-4">
      <button @click="openModal('exchange')" class="bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800 p-5 rounded-3xl flex items-center gap-4 active:scale-95 transition hover:bg-slate-100 dark:hover:bg-slate-800">
        <div class="w-12 h-12 bg-emerald-100/80 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-2xl flex items-center justify-center shadow-sm"><i class="fas fa-sync text-lg"></i></div>
        <div class="text-left"><p class="text-base font-black dark:text-white">å»æ¢é’±</p><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Exchange</p></div>
      </button>
      <button @click="openModal('expense')" class="bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800 p-5 rounded-3xl flex items-center gap-4 active:scale-95 transition hover:bg-slate-100 dark:hover:bg-slate-800">
        <div class="w-12 h-12 bg-indigo-100/80 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-2xl flex items-center justify-center shadow-sm"><i class="fas fa-shopping-bag text-lg"></i></div>
        <div class="text-left"><p class="text-base font-black dark:text-white">è®°å¼€é”€</p><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Expense</p></div>
      </button>
    </section>

    <div class="space-y-3">
      <div v-for="item in allTransactions" :key="item.id" class="transaction-item bg-white dark:bg-slate-900/80 p-4 rounded-2xl flex justify-between items-center border border-slate-50 dark:border-slate-800/50 shadow-sm" :class="getTranClass(item)">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center text-base" :class="getIconColor(item)"><i :class="getIcon(item)"></i></div>
          <div>
            <p class="font-bold text-slate-800 dark:text-slate-200 text-sm">{{ item.type === 'exchange' ? 'æ¢å°å¸' : item.name }}</p>
            <p class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase mono mt-0.5">{{ item.date }} Â· {{ item.type==='exchange' ? 'Rate '+item.rate : 'Expense' }}</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-base font-black mono" :class="item.type === 'exchange' ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-800 dark:text-slate-200'">{{ item.type === 'exchange' ? '+' : '-' }}{{ item.type === 'exchange' ? item.targetAmount : item.amount }}</p>
          <button @click="deleteItem(item)" class="text-[9px] text-slate-300 hover:text-red-400 font-bold px-1 py-1 opacity-60 hover:opacity-100">DEL</button>
        </div>
      </div>
    </div>
  </div>

  <div v-show="currentTab === 'calc'" class="page-fixed">
    
    <div class="calc-display-area">
      <div class="flex justify-between items-center mb-auto opacity-80 pointer-events-auto">
         <span class="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 text-slate-400 px-3 py-1.5 rounded-full">Rate: {{ averageRate }}</span>
      </div>

      <input v-model="calcNote" class="w-full bg-transparent text-right text-sm font-bold text-slate-400 placeholder-slate-200 dark:placeholder-slate-700 outline-none transition-all focus:placeholder-slate-400 mb-2 pointer-events-auto" placeholder="å¤‡æ³¨...">

      <div class="flex flex-col items-end gap-1">
        <div class="h-6 text-slate-400 font-bold text-lg mono opacity-50">{{ calcExpr }}</div>
        
        <div class="font-clamp-big font-black text-slate-900 dark:text-white tracking-tighter break-all text-right w-full mb-3 drop-shadow-sm" style="word-break: break-all;">
          {{ calcInput || '0' }}
          <span class="text-2xl text-slate-300 dark:text-slate-600 font-bold ml-1">TWD</span>
        </div>

        <div class="w-full bg-emerald-500 dark:bg-emerald-600 text-white rounded-[1.8rem] p-4 shadow-xl shadow-emerald-200/40 dark:shadow-none flex flex-col items-end justify-center active:scale-[0.98] transition-all cursor-pointer hover:shadow-2xl hover:bg-emerald-500/90 gap-0.5 pointer-events-auto" @click="saveCalculation">
          <div class="font-clamp-mid font-black mono tracking-tight leading-none">
            {{ calcResult }}
          </div>
          <div class="flex items-center gap-1 opacity-80">
            <span class="text-[10px] font-bold uppercase tracking-wider">æŠ˜åˆé©¬å¸ (RM)</span>
            <i class="fas fa-save text-xs ml-1"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="calc-keyboard-area pb-safe">
      
      <div class="history-capsule" @click="toggleHistory">
        <i class="fas fa-history text-emerald-500 text-sm"></i>
        <span class="capsule-text">å†å²è®°å½•</span>
        <i class="fas text-slate-300 text-xs" :class="showHistory ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
      </div>

      <transition name="slide">
        <div v-if="showHistory" class="absolute inset-0 bg-slate-50 dark:bg-slate-900 rounded-t-[2.5rem] z-20 pt-14 px-6 overflow-y-auto border-t border-slate-200 dark:border-slate-800 flex flex-col">
          
          <div class="space-y-3 pb-safe">
              <div v-if="calcHistory.length===0" class="text-center py-10 text-slate-300 text-sm">æš‚æ— è®°å½•</div>
              
              <div v-for="(rec,i) in calcHistory" :key="rec.time" 
                   class="swipe-list-item"
                   @touchstart="touchStart($event, i)"
                   @touchmove="touchMove($event, i)"
                   @touchend="touchEnd($event, i)">
                
                <div class="swipe-actions">
                  <div class="action-left" @click="pinItem(i)">ç½®é¡¶</div>
                  <div class="action-right" @click="delItem(i)">åˆ é™¤</div>
                </div>

                <div class="swipe-content" :style="{ transform: `translateX(${swipeOffsets[i] || 0}px)` }">
                  <div class="flex-1">
                    <div class="font-bold text-sm text-slate-700 dark:text-slate-200">{{ rec.note || 'æœªå¤‡æ³¨' }}</div>
                    <div class="text-xs text-slate-400 mt-0.5">{{ rec.twd }} TWD (Rate: {{rec.rateUsed}})</div>
                  </div>
                  <div class="text-right">
                    <div class="font-black text-emerald-600 dark:text-emerald-400 text-lg">{{ rec.myr }}</div>
                    <div class="text-[9px] text-slate-300 font-bold">{{ rec.time }}</div>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </transition>

      <div class="calc-grid">
        <button @click="key('AC')" class="calc-btn btn-ac">AC</button>
        <button @click="key('DEL')" class="calc-btn btn-op"><i class="fas fa-backspace"></i></button>
        <button @click="key('%')" class="calc-btn btn-op">%</button>
        <button @click="key('/')" class="calc-btn btn-op">Ã·</button>
        
        <button @click="key('7')" class="calc-btn btn-num">7</button>
        <button @click="key('8')" class="calc-btn btn-num">8</button>
        <button @click="key('9')" class="calc-btn btn-num">9</button>
        <button @click="key('*')" class="calc-btn btn-op">Ã—</button>

        <button @click="key('4')" class="calc-btn btn-num">4</button>
        <button @click="key('5')" class="calc-btn btn-num">5</button>
        <button @click="key('6')" class="calc-btn btn-num">6</button>
        <button @click="key('-')" class="calc-btn btn-op">-</button>

        <button @click="key('1')" class="calc-btn btn-num">1</button>
        <button @click="key('2')" class="calc-btn btn-num">2</button>
        <button @click="key('3')" class="calc-btn btn-num">3</button>
        <button @click="key('+')" class="calc-btn btn-op">+</button>

        <button @click="key('0')" class="calc-btn btn-num">0</button>
        <button @click="key('00')" class="calc-btn btn-num">00</button>
        <button @click="key('.')" class="calc-btn btn-num">.</button>
        <button @click="key('=')" class="calc-btn btn-eq">=</button>
      </div>
    </div>
  </div>

  <nav class="bottom-nav flex justify-around items-center bg-white/90 dark:bg-slate-900/90 border-t border-slate-100 dark:border-slate-800 transition-colors duration-300">
    <button @click="currentTab='assets'" class="flex flex-col items-center gap-1 transition active:scale-95 px-6" :class="currentTab==='assets'?'text-slate-900 dark:text-white':'text-slate-400 dark:text-slate-500'">
      <i class="fas fa-wallet text-xl"></i><span class="text-[10px] font-bold">é‡‘åº“</span>
    </button>
    <button @click="currentTab='calc'" class="flex flex-col items-center gap-1 transition active:scale-95 px-6" :class="currentTab==='calc'?'text-emerald-500':'text-slate-400 dark:text-slate-500'">
      <i class="fas fa-calculator text-xl"></i><span class="text-[10px] font-bold">æ¢ç®—</span>
    </button>
  </nav>

  <input type="file" ref="importInput" class="hidden" @change="handleImport" accept=".json">
  
  <transition name="fade">
    <div v-if="showModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showModal=false"></div>
      
      <transition name="slide" appear>
      <div class="bg-white dark:bg-slate-950 w-full max-w-[340px] rounded-[2rem] p-6 relative z-10 shadow-2xl transition-colors border border-slate-100 dark:border-slate-800">
        
        <h3 class="text-lg font-black mb-6 text-slate-900 dark:text-white flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm" :class="modalType==='exchange'?'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400':'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400'">
             <i class="fas text-sm" :class="modalType==='exchange'?'fa-sync-alt':'fa-pen'"></i>
          </div>
          {{ modalType==='exchange'?'å­˜å…¥èµ„é‡‘':'è®°å½•å¼€é”€' }}
        </h3>
        
        <div v-if="modalType==='exchange'" class="mb-6">
          <div class="rate-card">
              <div>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">Jags Rate (Sell)</span>
                <a href="https://www.jagsmoney.com/daily-rates/" target="_blank" class="text-[10px] text-blue-500 font-bold underline">æŸ¥çœ‹å®˜ç½‘</a>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-slate-400 dark:text-slate-500">100 TWD = </span>
                <input type="number" v-model="jagsRate" class="w-24 bg-white dark:bg-slate-800 p-2 rounded-lg text-xl font-black outline-none text-center shadow-sm dark:text-white border border-slate-100 dark:border-slate-700" placeholder="12.63">
                <span class="text-xs font-bold text-slate-400 dark:text-slate-500">MYR</span>
              </div>
          </div>
        </div>

        <div v-if="modalType==='exchange'" class="space-y-4">
          <div>
            <label class="text-[10px] font-bold text-slate-400 mb-2 block ml-2 uppercase tracking-wide">è¾“å…¥é‡‘é¢</label>
            <div class="exchange-input-box" :class="exMode==='MYR'?'box-myr':'box-twd'">
              <input type="number" v-model.number="exInputAmount" class="exchange-input" placeholder="0">
              <button @click="toggleExMode" class="currency-toggle" :class="exMode==='MYR' ? 'toggle-myr' : 'toggle-twd'">
                {{ exMode }}
                <i class="fas fa-exchange-alt text-xs opacity-60"></i>
              </button>
            </div>
          </div>
          
          <div class="flex justify-center -my-3 relative z-10"><i class="fas fa-arrow-down bg-white dark:bg-slate-900 text-slate-300 rounded-full p-1 border dark:border-slate-800 text-xs"></i></div>
          
          <div class="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-4 flex justify-between items-center border border-slate-100 dark:border-slate-800/50">
            <span class="text-xs font-bold text-slate-400">è‡ªåŠ¨æ¢ç®—ä¸º</span>
            <div class="text-xl font-black" :class="exMode==='MYR'?'text-orange-500':'text-blue-500'">
               {{ exResult }} <span class="text-sm">{{ exMode==='MYR'?'TWD':'MYR' }}</span>
            </div>
          </div>
        </div>

        <div v-if="modalType==='expense'" class="space-y-6">
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide ml-1">é€‰æ‹©åˆ†ç±»</label>
            <div class="cat-grid">
              <div v-for="cat in categories" :key="cat.name" 
                   class="cat-item" 
                   :class="selectedCat.name === cat.name ? 'active' : ''"
                   @click="selectedCat = cat">
                <div class="cat-emoji">{{ cat.emoji }}</div>
                <div class="cat-name">{{ cat.name }}</div>
              </div>
            </div>
          </div>

          <div>
             <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-2 block">æ¶ˆè´¹é‡‘é¢ (TWD)</label>
             <div class="exchange-input-box box-twd !p-1">
                <input type="number" v-model.number="newItem.amount" class="exchange-input !ml-2" placeholder="0.00">
                <span class="text-sm font-bold text-slate-400 mr-4">TWD</span>
             </div>
          </div>
          
          <div class="px-2">
             <input v-model="newItem.name" class="w-full bg-transparent border-b border-slate-200 dark:border-slate-800 py-2 text-sm font-bold text-slate-600 dark:text-slate-300 outline-none placeholder-slate-300" placeholder="æ·»åŠ å¤‡æ³¨ (å¯é€‰)...">
          </div>
        </div>

        <button @click="saveItem" class="w-full bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 font-bold py-3.5 rounded-xl mt-8 shadow-lg active:scale-95 transition flex justify-center items-center gap-2"><i class="fas fa-check"></i> ç¡®è®¤ä¿å­˜</button>
      </div>
      </transition>
    </div>
  </transition>
</div>

<script>
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
  const { createApp, ref, computed, onMounted, reactive } = Vue;
  createApp({
    setup() {
      const STORAGE_KEY = "ustrip_v17_2_swipe";
      const currentTab = ref("assets");
      const isDark = ref(false);
      const showHistory = ref(false);
      
      const toggleDark = () => { 
        isDark.value = !isDark.value; 
        const meta = document.getElementById('theme-color');
        if(isDark.value) { document.documentElement.classList.add('dark'); if(meta) meta.setAttribute('content', '#0f172a'); }
        else { document.documentElement.classList.remove('dark'); if(meta) meta.setAttribute('content', '#ffffff'); }
        save(); 
      };
      const toggleHistory = () => showHistory.value = !showHistory.value;

      const showModal = ref(false); const modalType = ref(""); const newItem = ref({}); const importInput = ref(null);
      const exchangeRecords = ref([]); const expenseRecords = ref([]);
      const calcInput = ref("0"); const calcExpr = ref(""); const calcNote = ref(""); const calcHistory = ref([]);
      
      const jagsRate = ref(12.63);
      const exMode = ref("MYR"); 
      const exInputAmount = ref("");
      const categories = [ { name: 'é¥®é£Ÿ', emoji: 'ğŸ”' }, { name: 'äº¤é€š', emoji: 'ğŸš—' }, { name: 'è´­ç‰©', emoji: 'ğŸ›ï¸' }, { name: 'å¨±ä¹', emoji: 'ğŸ®' }, { name: 'ä½å®¿', emoji: 'ğŸ¨' }, { name: 'é›¶é£Ÿ', emoji: 'ğŸ¦' }, { name: 'å…¶ä»–', emoji: 'ğŸ“¦' } ];
      const selectedCat = ref(categories[0]);

      // ğŸŒŸ æ»‘åŠ¨é€»è¾‘
      const swipeOffsets = reactive({});
      let startX = 0;
      let activeIndex = null;

      const touchStart = (e, i) => { startX = e.touches[0].clientX; activeIndex = i; };
      const touchMove = (e, i) => {
        if(activeIndex !== i) return;
        const diff = e.touches[0].clientX - startX;
        // é™åˆ¶æ»‘åŠ¨èŒƒå›´ -100 (Delete) åˆ° 100 (Pin)
        if(diff < -100) swipeOffsets[i] = -100;
        else if(diff > 100) swipeOffsets[i] = 100;
        else swipeOffsets[i] = diff;
      };
      const touchEnd = (e, i) => {
        if(Math.abs(swipeOffsets[i]) > 60) {
           swipeOffsets[i] = swipeOffsets[i] > 0 ? 100 : -100; // å¸é™„
        } else {
           swipeOffsets[i] = 0; // å›å¼¹
        }
      };
      
      const delItem = (i) => { calcHistory.value.splice(i, 1); delete swipeOffsets[i]; save(); };
      const pinItem = (i) => { 
        const item = calcHistory.value.splice(i, 1)[0];
        calcHistory.value.unshift(item);
        delete swipeOffsets[i];
        save();
      };

      const twdPerMyrFromJags = computed(() => {
        const x = parseFloat(String(jagsRate.value));
        if(!x) return 7.900;
        return (100 / x);
      });

      const toggleExMode = () => {
        exMode.value = exMode.value === "MYR" ? "TWD" : "MYR";
        exInputAmount.value = "";
      };

      const exResult = computed(() => {
        const val = parseFloat(exInputAmount.value);
        if(!val) return "0";
        const rate = twdPerMyrFromJags.value;
        if (exMode.value === "MYR") return Math.round(val * rate);
        else return (val / rate).toFixed(2);
      });

      const twdBalance = computed(() => {
        const i = exchangeRecords.value.reduce((s,r)=>s+(parseFloat(r.targetAmount)||0),0);
        const o = expenseRecords.value.reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
        return Math.max(0, i-o);
      });
      const averageRate = computed(() => {
        const b = exchangeRecords.value.reduce((s,r)=>s+(parseFloat(r.baseAmount)||0),0);
        const t = exchangeRecords.value.reduce((s,r)=>s+(parseFloat(r.targetAmount)||0),0);
        return b>0?(t/b).toFixed(3):"7.100";
      });
      const calcResult = computed(() => {
        try { return (eval(calcInput.value.replace(/[^-()\d/*+.]/g,''))/parseFloat(averageRate.value)).toFixed(2); } catch { return "0.00"; }
      });
      const totalCardSpent = computed(() => expenseRecords.value.filter(e=>e.catEmoji==='ğŸ›ï¸').reduce((s,e)=>s+(parseFloat(e.amount)||0),0).toFixed(2));
      const totalCashSpent = computed(() => expenseRecords.value.reduce((s,e)=>s+(parseFloat(e.amount)||0),0));
      const allTransactions = computed(() => [...exchangeRecords.value.map(r=>({...r,type:'exchange'})), ...expenseRecords.value.map(r=>({...r,type:'expense'}))].sort((a,b)=>b.id-a.id));
      
      const key = (k) => {
        if(k==='AC'){calcInput.value="0";calcExpr.value="";return;}
        if(k==='DEL'){calcInput.value=calcInput.value.length>1?calcInput.value.slice(0,-1):"0";return;}
        if(k==='%'){ try{ calcInput.value = String(eval(calcInput.value)/100); }catch{} return; }
        if(k==='='){try{calcInput.value=String(eval(calcInput.value.replace(/[^-()\d/*+.]/g,'')));calcExpr.value="";}catch{}return;}
        if(['+','-','*','/'].includes(k)){calcExpr.value=calcInput.value;calcInput.value+=k;}
        else{calcInput.value=(calcInput.value==='0'&&k!=='.')?k:calcInput.value+k;}
      };
      const saveCalculation = () => {
        const v = parseFloat(calcInput.value); if(!v)return;
        const d = new Date();
        calcHistory.value.unshift({twd:v, myr:calcResult.value, note:calcNote.value, time:`${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`});
        calcNote.value=""; calcInput.value="0"; calcExpr.value=""; save(); 
      };
      const clearHistory = () => { if(confirm("æ¸…ç©º?")){calcHistory.value=[];save();} };
      const exportHistoryCSV = () => {
        let csv = "Time,Note,TWD,MYR,Rate\n";
        calcHistory.value.forEach(r => csv += `${r.time},${r.note},${r.twd},${r.myr},${averageRate.value}\n`);
        const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,\uFEFF"+csv); link.download = "shopping_list.csv"; link.click();
      };

      const openModal = (t) => { modalType.value=t; newItem.value=t==='exchange'?{}:{amount:"",name:""}; showModal.value=true; };
      
      const saveItem = () => {
        const id=Date.now(); const d=new Date().toLocaleDateString('zh-CN',{month:'2-digit',day:'2-digit'}).replace('/','-');
        
        if(modalType.value==='exchange') {
           const val = parseFloat(exInputAmount.value);
           if(!val) return;
           if(exMode.value === 'MYR') exchangeRecords.value.unshift({id, date:d, baseAmount: val, targetAmount: parseFloat(exResult.value)});
           else exchangeRecords.value.unshift({id, date:d, baseAmount: parseFloat(exResult.value), targetAmount: val});
        } else {
           if(!newItem.value.amount) return;
           expenseRecords.value.unshift({
             ...newItem.value, id, date:d, 
             name: (newItem.value.name || selectedCat.value.name) + ' ' + selectedCat.value.emoji
           });
        }
        save(); showModal.value=false;
      };
      
      const deleteItem = (i) => { if(!confirm("åˆ ?"))return; if(i.type==='exchange')exchangeRecords.value=exchangeRecords.value.filter(r=>r.id!==i.id); else expenseRecords.value=expenseRecords.value.filter(r=>r.id!==i.id); save(); };
      
      const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify({ex:exchangeRecords.value, ep:expenseRecords.value, ch:calcHistory.value, dark:isDark.value, jrate:jagsRate.value}));
      const exportAllData = () => { const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([localStorage.getItem(STORAGE_KEY)],{type:"application/json"})); a.download="UsTrip.json"; a.click(); };
      const triggerImport = () => importInput.value.click();
      const handleImport = (e) => { const r=new FileReader(); r.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);exchangeRecords.value=d.ex||[];expenseRecords.value=d.ep||[];calcHistory.value=d.ch||[];save();alert("OK");}catch{alert("Err");}}; r.readAsText(e.target.files[0]); };

      onMounted(() => {
        const d = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
        exchangeRecords.value=d.ex||[]; expenseRecords.value=d.ep||[]; calcHistory.value=d.ch||[]; isDark.value=d.dark||false;
        if(d.jrate) jagsRate.value = d.jrate;
        const meta = document.getElementById('theme-color');
        if(isDark.value) { document.documentElement.classList.add('dark'); if(meta) meta.setAttribute('content', '#0f172a'); }
        else { if(meta) meta.setAttribute('content', '#ffffff'); }
        if(exchangeRecords.value.length===0) { exchangeRecords.value.push({id:1,date:'02-04',baseAmount:402.55,targetAmount:3200}); save(); }
      });

      return { 
        currentTab, isDark, toggleDark, showHistory, toggleHistory, showModal, modalType, newItem, twdBalance, averageRate, 
        totalCardSpent, totalCashSpent, allTransactions, calcInput, calcExpr, calcResult, calcNote, calcHistory, 
        key, saveCalculation, clearHistory, openModal, closeModal:()=>showModal.value=false, saveItem, deleteItem, exportAllData, triggerImport, handleImport, importInput, exportHistoryCSV,
        getTranClass: (i)=>i.type==='exchange'?'item-exchange':(i.method==='card'?'item-card':'item-expense'),
        getIcon: (i)=>i.type==='exchange'?'fas fa-sync':(i.method==='card'?'fas fa-credit-card':'fas fa-wallet'),
        getIconColor: (i)=>i.type==='exchange'?'bg-emerald-50 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-400' : 'bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-400',
        jagsRate, 
        exMode, toggleExMode, exInputAmount, exResult,
        categories, selectedCat,
        touchStart, touchMove, touchEnd, swipeOffsets, delItem, pinItem
      };
    }
  }).mount("#app");
</script>
</body>
</html>
