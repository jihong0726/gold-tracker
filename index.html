<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>é‡‘åº“ & æ¢ç®—</title>
  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --ink:#0b1324;
      --muted:rgba(11,19,36,.55);
      --line:rgba(11,19,36,.08);

      --green:#14a874;
      --green-weak:rgba(20,168,116,.10);

      --blue:#2b6cff;
      --blue-weak:rgba(43,108,255,.10);

      --danger:#ff3b30;
      --danger-weak:rgba(255,59,48,.10);

      --shadow:0 18px 40px rgba(0,0,0,.07);
      --radius:26px;

      --tabH:78px;
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --card:#121a2b;
      --ink:#e9eefc;
      --muted:rgba(233,238,252,.58);
      --line:rgba(233,238,252,.10);

      --green:#28d18f;
      --green-weak:rgba(40,209,143,.12);

      --blue:#5c8cff;
      --blue-weak:rgba(92,140,255,.14);

      --shadow:0 18px 40px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Noto Sans CJK SC", "Microsoft YaHei", Arial;
      background: radial-gradient(1000px 500px at 20% -10%, rgba(20,168,116,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(43,108,255,.14), transparent 55%),
                  var(--bg);
      color:var(--ink);
    }

    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      padding-bottom: calc(var(--tabH) + env(safe-area-inset-bottom));
    }

    /* é¡¶éƒ¨æ  */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 18px 10px;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .appIcon{
      width:52px;height:52px;border-radius:18px;
      background: linear-gradient(145deg, rgba(20,168,116,1), rgba(20,168,116,.65));
      display:grid;place-items:center;
      box-shadow: 0 14px 30px rgba(20,168,116,.25);
      flex:0 0 auto;
    }
    .titleWrap{min-width:0}
    .title{
      font-size:38px;
      font-weight:900;
      letter-spacing:-.5px;
      line-height:1;
      margin:0;
    }
    .subtitle{
      margin-top:6px;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .actions{display:flex;align-items:center;gap:12px;flex:0 0 auto;}
    .iconBtn{
      width:54px;height:54px;border-radius:20px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: 0 10px 26px rgba(0,0,0,.05);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{transform:scale(.98)}

    /* å°èƒ¶å›Š */
    .pillRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 18px 10px;
    }
    .ratePill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:14px 16px;
      border-radius:999px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: 0 12px 28px rgba(0,0,0,.05);
      min-width:0;
    }
    .ratePill .bolt{
      width:22px;height:22px;border-radius:10px;
      background:var(--green-weak);
      display:grid;place-items:center;
      color:var(--green);
      font-weight:900;
      flex:0 0 auto;
    }
    .rateText{
      font-weight:900;
      letter-spacing:.2px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rateText b{color:var(--ink)}
    .histBtn{
      padding:14px 16px;
      border-radius:999px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: 0 12px 28px rgba(0,0,0,.05);
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      display:flex;align-items:center;gap:10px;
    }
    .histBtn:active{transform:scale(.99)}

    /* é¡µé¢å®¹å™¨ */
    .page{display:none;}
    .page.show{display:block;}

    /* ===== æ¢ç®—é¡µ ===== */
    .fxPanel{
      margin:6px 18px 10px;
      border-radius: var(--radius);
      background:
        linear-gradient(90deg, var(--blue-weak), transparent 55%),
        linear-gradient(270deg, var(--green-weak), transparent 55%),
        var(--card);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .fxInner{
      padding:18px 18px 14px;
      display:flex;
      align-items:stretch;
      gap:16px;
    }
    .col{
      flex:1; min-width:0;
      border-radius:22px;
      padding:14px 14px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      border:1px solid rgba(0,0,0,0);
    }
    .col.left{
      background: linear-gradient(180deg, rgba(43,108,255,.12), transparent 70%);
      border:1px solid color-mix(in srgb, var(--blue) 18%, transparent);
    }
    .col.right{
      background: linear-gradient(180deg, rgba(20,168,116,.12), transparent 70%);
      border:1px solid color-mix(in srgb, var(--green) 18%, transparent);
      text-align:right;
    }
    .miniRow{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 75%, transparent);
      user-select:none;
      white-space:nowrap;
    }
    .tag .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--blue);
      box-shadow:0 0 0 6px rgba(43,108,255,.10);
    }
    .right .tag .dot{
      background:var(--green);
      box-shadow:0 0 0 6px rgba(20,168,116,.10);
    }
    .hint{
      font-size:12px;
      font-weight:900;
      color:rgba(11,19,36,.40);
    }
    [data-theme="dark"] .hint{color:rgba(233,238,252,.42)}
    .bigLine{
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .right .bigLine{justify-content:flex-end}
    .bigNum{
      font-size:64px;
      font-weight:950;
      letter-spacing:-1.8px;
      line-height:1;
      color:var(--ink);
    }
    .right .bigNum{color:var(--green)}
    .unit{
      font-size:18px;
      font-weight:950;
      color:rgba(11,19,36,.35);
    }
    [data-theme="dark"] .unit{color:rgba(233,238,252,.35)}

    .saveBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px 14px;
      border-top:1px solid var(--line);
      background: linear-gradient(90deg, rgba(43,108,255,.06), rgba(20,168,116,.08));
    }
    .saveText{
      font-weight:950;
      letter-spacing:.2px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .saveText b{color:var(--ink)}
    .saveBtn{
      flex:0 0 auto;
      display:flex;align-items:center;gap:10px;
      padding:14px 22px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(20,168,116,1), rgba(20,168,116,.72));
      color:white;
      border:none;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 18px 34px rgba(20,168,116,.28);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .saveBtn:active{transform:scale(.99)}

    /* é”®ç›˜åŒº */
    .padWrap{
      flex:1;
      display:flex;
      padding:0 18px 18px;
    }
    .pad{
      width:100%;
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      padding:14px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1.05fr;
      grid-template-rows: repeat(5, minmax(54px, 1fr));
      gap:14px;
      align-items:stretch;
      min-height: 340px;
    }
    .key{
      border-radius:22px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      display:flex;align-items:center;justify-content:center;
      font-weight:950;
      font-size:28px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 12px 26px rgba(0,0,0,.05);
    }
    .key:active{transform:scale(.99)}
    .key.op{
      background: color-mix(in srgb, var(--blue-weak) 45%, var(--card));
      color: color-mix(in srgb, var(--blue) 75%, var(--ink));
    }
    .key.ac{
      background: rgba(255,60,60,.10);
      color:var(--danger);
      border-color: rgba(255,60,60,.18);
    }
    .key.eq{
      background: linear-gradient(135deg, rgba(20,168,116,1), rgba(20,168,116,.72));
      color:white;
      border:none;
      box-shadow: 0 18px 34px rgba(20,168,116,.28);
      grid-row: 4 / span 2;
      grid-column: 4;
      font-size:34px;
      border-radius:26px;
    }
    .key.zero{
      grid-column: 1 / span 2;
      justify-content:center;
    }
    .key.back{font-size:22px;}

    /* ===== é‡‘åº“é¡µï¼ˆä¸æ˜¾ç¤ºè®¡ç®—å™¨ï¼‰ ===== */
    .vaultHero{
      margin:6px 18px 12px;
      border-radius: 34px;
      border:1px solid var(--line);
      background: linear-gradient(145deg, rgba(11,19,36,.98), rgba(11,19,36,.82));
      box-shadow: var(--shadow);
      padding:20px 20px 18px;
      color:white;
      overflow:hidden;
      position:relative;
    }
    [data-theme="dark"] .vaultHero{
      background: linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      color:var(--ink);
    }
    .vaultHero .row1{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
    }
    .vaultHero .label{
      font-weight:900;
      opacity:.72;
      letter-spacing:.2px;
    }
    .vaultHero .balance{
      font-size:72px;
      font-weight:950;
      letter-spacing:-2px;
      line-height:1;
      margin-top:8px;
    }
    .vaultHero .rateBadge{
      border-radius:999px;
      padding:10px 14px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      font-weight:950;
      color: rgba(255,255,255,.88);
      white-space:nowrap;
    }
    [data-theme="dark"] .vaultHero .rateBadge{
      background: rgba(20,168,116,.12);
      border:1px solid rgba(20,168,116,.18);
      color:var(--green);
    }
    .vaultMeta{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      opacity:.86;
      font-weight:900;
    }

    .vaultBtns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      padding: 0 18px 12px;
    }
    .bigAction{
      border-radius: 28px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: 0 14px 30px rgba(0,0,0,.06);
      padding:18px 16px;
      display:flex;
      align-items:center;
      gap:14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .bigAction:active{transform:scale(.995)}
    .bigAction .ic{
      width:50px;height:50px;border-radius:18px;
      display:grid;place-items:center;
      flex:0 0 auto;
      background: var(--green-weak);
      color: var(--green);
      border:1px solid color-mix(in srgb, var(--green) 18%, transparent);
    }
    .bigAction .ic.blue{
      background: var(--blue-weak);
      color: var(--blue);
      border:1px solid color-mix(in srgb, var(--blue) 18%, transparent);
    }
    .bigAction .t{
      font-size:20px;
      font-weight:950;
      letter-spacing:-.2px;
      margin:0;
      line-height:1.1;
    }
    .bigAction .s{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      font-weight:850;
      letter-spacing:.2px;
    }

    .vaultListWrap{
      padding: 0 18px 18px;
    }
    .sectionTitle{
      display:flex;align-items:center;justify-content:space-between;
      margin:6px 2px 10px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:.2px;
    }
    .vaultList{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .vaultItem{
      border-radius: 24px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 96%, transparent);
      box-shadow: 0 10px 22px rgba(0,0,0,.04);
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .vaultItem:active{transform:scale(.998)}
    .vaultItem .left{
      display:flex;align-items:center;gap:12px;min-width:0;
    }
    .vaultItem .emoji{
      width:44px;height:44px;border-radius:18px;
      display:grid;place-items:center;
      background: color-mix(in srgb, var(--green-weak) 70%, var(--card));
      border:1px solid color-mix(in srgb, var(--green) 18%, transparent);
      font-size:20px;
    }
    .vaultItem .txt{
      min-width:0;
    }
    .vaultItem .txt .name{
      font-weight:950;
      letter-spacing:-.2px;
      margin:0;
      line-height:1.1;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .vaultItem .txt .meta{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .vaultItem .amt{
      text-align:right;
      font-weight:950;
      letter-spacing:-.2px;
      font-size:20px;
      color:var(--ink);
      white-space:nowrap;
    }

    /* å¼¹çª—å¤ç”¨ */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.38);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(720px, 100%);
      border-radius: 30px;
      background: var(--card);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 18px 10px;
      gap:12px;
    }
    .modalTitle{
      display:flex;align-items:center;gap:12px;min-width:0;
    }
    .modalTitle h2{
      margin:0;
      font-size:28px;
      font-weight:950;
      letter-spacing:-.4px;
      line-height:1.1;
    }
    .modalTitle p{
      margin:4px 0 0;
      font-size:13px;
      color:var(--muted);
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modalIcon{
      width:52px;height:52px;border-radius:18px;
      background: var(--green-weak);
      display:grid;place-items:center;
      color:var(--green);
      flex:0 0 auto;
      border:1px solid color-mix(in srgb, var(--green) 18%, transparent);
    }
    .closeBtn{
      width:52px;height:52px;border-radius:20px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .closeBtn:active{transform:scale(.99)}

    .modalActions{
      display:flex;
      gap:12px;
      padding:10px 18px 14px;
    }
    .ghostBtn{
      flex:1;
      padding:16px 14px;
      border-radius: 22px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      font-weight:950;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .ghostBtn:active{transform:scale(.99)}
    .dangerBtn{
      flex:1;
      padding:16px 14px;
      border-radius: 22px;
      border:1px solid rgba(255,60,60,.18);
      background: rgba(255,60,60,.10);
      color:var(--danger);
      font-weight:950;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dangerBtn:active{transform:scale(.99)}

    .list{
      padding:0 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height: min(62vh, 560px);
      overflow:auto;
    }
    .item{
      border-radius: 24px;
      border:1px solid var(--line);
      background:
        linear-gradient(90deg, var(--blue-weak), transparent 55%),
        linear-gradient(270deg, var(--green-weak), transparent 55%),
        color-mix(in srgb, var(--card) 96%, transparent);
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .item:active{transform:scale(.998)}
    .itemLeft{min-width:0;display:flex;flex-direction:column;gap:6px;}
    .line1{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;font-weight:950;letter-spacing:-.2px;}
    .line1 .twd{color:var(--ink);font-size:26px;}
    .line1 .twd small{font-size:14px;color:rgba(11,19,36,.40);font-weight:950;margin-left:6px;}
    [data-theme="dark"] .line1 .twd small{color:rgba(233,238,252,.38)}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 78%, transparent);
      font-size:13px;color:var(--muted);font-weight:950;white-space:nowrap;
    }
    .line2{font-size:13px;color:var(--muted);font-weight:850;display:flex;gap:10px;flex-wrap:wrap;}
    .itemRight{text-align:right;display:flex;flex-direction:column;gap:6px;flex:0 0 auto;align-items:flex-end;}
    .rm{font-size:30px;font-weight:950;color:var(--green);letter-spacing:-.4px;}
    .rm small{font-size:14px;color:rgba(11,19,36,.40);font-weight:950;margin-left:6px;}
    [data-theme="dark"] .rm small{color:rgba(233,238,252,.38)}
    .empty{
      border-radius: 24px;border:1px dashed var(--line);
      padding:18px;color:var(--muted);font-weight:900;text-align:center;
      background: color-mix(in srgb, var(--card) 92%, transparent);
    }

    .detailBody{padding:0 18px 18px;display:flex;flex-direction:column;gap:12px;}
    .detailCard{
      border-radius: 26px;border:1px solid var(--line);
      background:
        linear-gradient(90deg, var(--blue-weak), transparent 55%),
        linear-gradient(270deg, var(--green-weak), transparent 55%),
        color-mix(in srgb, var(--card) 96%, transparent);
      padding:16px 16px;
    }
    .detailTop{display:flex;justify-content:space-between;gap:14px;align-items:flex-start;}
    .detailTop .leftBlock{display:flex;flex-direction:column;gap:8px;min-width:0;}
    .detailTop .rightBlock{text-align:right;display:flex;flex-direction:column;gap:8px;align-items:flex-end;}
    .bigPair{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;}
    .bigPair .num{font-size:44px;font-weight:950;letter-spacing:-1px;}
    .bigPair .u{font-size:16px;font-weight:950;color:rgba(11,19,36,.42);}
    [data-theme="dark"] .bigPair .u{color:rgba(233,238,252,.40)}
    .bigPair.rm .num{color:var(--green)}
    .meta{font-size:13px;color:var(--muted);font-weight:850;display:flex;gap:10px;flex-wrap:wrap;}
    .detailBtns{display:flex;gap:12px;}
    .primaryClose{
      flex:1;padding:18px 14px;border-radius: 22px;border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      font-weight:950;cursor:pointer;
    }
    .deleteBtn{
      flex:1;padding:18px 14px;border-radius: 22px;border:1px solid rgba(255,60,60,.18);
      background: rgba(255,60,60,.10);color:var(--danger);
      font-weight:950;cursor:pointer;
    }

    /* åº•éƒ¨ tab */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;
      height: calc(var(--tabH) + env(safe-area-inset-bottom));
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
      display:flex;justify-content:center;
      pointer-events:none;
    }
    .tabInner{
      width:min(520px, calc(100% - 24px));
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border:1px solid var(--line);
      border-radius: 26px;
      box-shadow: var(--shadow);
      display:flex;
      overflow:hidden;
      pointer-events:auto;
    }
    .tab{
      flex:1;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:950;
      color:rgba(11,19,36,.42);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    [data-theme="dark"] .tab{color:rgba(233,238,252,.48)}
    .tab.active{
      color:var(--ink);
      background: linear-gradient(90deg, rgba(43,108,255,.08), rgba(20,168,116,.10));
    }
    .tab + .tab{border-left:1px solid var(--line);}

    @media (max-width:560px){
      .fxInner{flex-direction:column}
      .bigNum{font-size:58px}
    }
    @media (max-width:420px){
      .title{font-size:34px}
      .pad{gap:12px}
      .key{font-size:26px;border-radius:20px}
      .vaultHero .balance{font-size:62px}
    }
  </style>
</head>

<body>
  <div class="screen" id="screen">
    <div class="topbar">
      <div class="brand">
        <div class="appIcon" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
            <rect x="6" y="3.8" width="12" height="16.4" rx="2.2" stroke="white" stroke-width="2"/>
            <path d="M8.5 8.5h7" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 12h7" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 15.5h4.5" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="titleWrap">
          <div class="title" id="pageTitle">æ¢ç®—</div>
          <div class="subtitle" id="subTitle">è¾“å…¥ TWDï¼Œå³ä¾§è‡ªåŠ¨æŠ˜åˆ RM</div>
        </div>
      </div>

      <div class="actions">
        <div class="iconBtn" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜" aria-label="åˆ‡æ¢ä¸»é¢˜">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M21 12.5A8.5 8.5 0 1 1 11.5 3a6.2 6.2 0 0 0 9.5 9.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="iconBtn" id="undoBtn" title="æ’¤å›è¾“å…¥" aria-label="æ’¤å›è¾“å…¥">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M9 9H4V4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4 9a8 8 0 1 1 2.4 5.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="pillRow" id="pillRow">
      <div class="ratePill" title="ç›®å‰å…‘æ¢æ±‡ç‡">
        <div class="bolt">âš¡</div>
        <div class="rateText">å½“å‰æ±‡ç‡ <b id="rateLabel">1 : 7.949</b> <span style="opacity:.8">TWD/MYR</span></div>
      </div>

      <div class="histBtn" id="openHistory">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M3 12a9 9 0 1 0 3-6.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M3 4v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        å†å²
      </div>
    </div>

    <!-- =========================
         æ¢ç®—é¡µï¼ˆæ˜¾ç¤ºè®¡ç®—å™¨ï¼‰
    ========================== -->
    <div class="page show" id="pageCalc">
      <div class="fxPanel">
        <div class="fxInner">
          <div class="col left">
            <div class="miniRow">
              <div class="tag"><span class="dot"></span> è¾“å…¥</div>
              <div class="hint">å¯ç¼–è¾‘</div>
            </div>
            <div class="bigLine">
              <span class="bigNum" id="twdValue">0</span>
              <span class="unit">TWD</span>
            </div>
          </div>

          <div class="col right">
            <div class="miniRow">
              <div class="tag"><span class="dot"></span> æ¢ç®—</div>
              <div class="hint">ä»…æ˜¾ç¤º</div>
            </div>
            <div class="bigLine">
              <span class="bigNum" id="rmValue">0.00</span>
              <span class="unit">RM</span>
            </div>
          </div>
        </div>

        <div class="saveBar">
          <div class="saveText">ç”¨å½“å‰æ±‡ç‡ <b id="rateSmall">1 : 7.949</b> ä¿å­˜è¿™æ¬¡æ¢ç®—</div>
          <button class="saveBtn" id="saveBtn" type="button" title="ä¿å­˜è®°å½•">ä¿å­˜</button>
        </div>
      </div>

      <div class="padWrap">
        <div class="pad" id="pad">
          <div class="key ac" data-act="ac">AC</div>
          <div class="key op back" data-act="back">âŒ«</div>
          <div class="key op" data-act="div">Ã·</div>
          <div class="key op" data-act="mul">Ã—</div>

          <div class="key" data-act="7">7</div>
          <div class="key" data-act="8">8</div>
          <div class="key" data-act="9">9</div>
          <div class="key op" data-act="sub">âˆ’</div>

          <div class="key" data-act="4">4</div>
          <div class="key" data-act="5">5</div>
          <div class="key" data-act="6">6</div>
          <div class="key op" data-act="add">+</div>

          <div class="key" data-act="1">1</div>
          <div class="key" data-act="2">2</div>
          <div class="key" data-act="3">3</div>
          <div class="key eq" data-act="eq">=</div>

          <div class="key zero" data-act="0">0</div>
          <div class="key" data-act="dot">.</div>
        </div>
      </div>
    </div>

    <!-- =========================
         é‡‘åº“é¡µï¼ˆä¸æ˜¾ç¤ºè®¡ç®—å™¨ï¼‰
    ========================== -->
    <div class="page" id="pageVault">
      <div class="vaultHero">
        <div class="row1">
          <div>
            <div class="label">å°å¸ä½™é¢</div>
            <div class="balance" id="vaultBalance">0</div>
          </div>
          <div class="rateBadge" id="vaultRateBadge">1 : 7.949</div>
        </div>
        <div class="vaultMeta">
          <div>ç°é‡‘å·²èŠ± <span id="vaultCash">0</span></div>
          <div>å¡ç‰‡å·²èŠ± <span id="vaultCard">0</span></div>
        </div>
      </div>

      <div class="vaultBtns">
        <div class="bigAction" id="vaultGoExchange">
          <div class="ic">
            ğŸ”„
          </div>
          <div>
            <div class="t">å»æ¢é’±</div>
            <div class="s">è®°å½•ä¸€æ¬¡æ¢æ±‡å­˜å…¥</div>
          </div>
        </div>
        <div class="bigAction" id="vaultAddExpense">
          <div class="ic blue">
            ğŸ§¾
          </div>
          <div>
            <div class="t">è®°å¼€é”€</div>
            <div class="s">äº¤é€š / åƒå– / ç©ä¹â€¦</div>
          </div>
        </div>
      </div>

      <div class="vaultListWrap">
        <div class="sectionTitle">
          <span>è®°å½•</span>
          <span style="opacity:.75">ç‚¹å¼€æ‰å¯åˆ é™¤</span>
        </div>
        <div class="vaultList" id="vaultList"></div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨ Tab -->
  <div class="tabbar">
    <div class="tabInner">
      <div class="tab" id="tabVault">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <rect x="3" y="6" width="18" height="14" rx="2.5" stroke="currentColor" stroke-width="2"/>
          <path d="M7 10h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        é‡‘åº“
      </div>
      <div class="tab active" id="tabCalc">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <rect x="5" y="3" width="14" height="18" rx="2.5" stroke="currentColor" stroke-width="2"/>
          <path d="M8 8h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 16h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        æ¢ç®—
      </div>
    </div>
  </div>

  <!-- å†å²è®°å½•ï¼ˆæ¢ç®—ä¿å­˜åˆ—è¡¨ï¼‰ -->
  <div class="overlay" id="historyOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">
          <div class="modalIcon" aria-hidden="true">ğŸ•˜</div>
          <div style="min-width:0">
            <h2>å†å²è®°å½•</h2>
            <p>ç‚¹å‡»ä¸€æ¡è®°å½•æŸ¥çœ‹è¯¦æƒ…ï¼Œè¯¦æƒ…é¡µæ‰æä¾›åˆ é™¤</p>
          </div>
        </div>
        <div class="closeBtn" id="closeHistory" aria-label="å…³é—­">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <div class="modalActions">
        <button class="ghostBtn" id="exportBtn" type="button">å¯¼å‡º</button>
        <button class="dangerBtn" id="clearBtn" type="button">æ¸…ç©º</button>
      </div>

      <div class="list" id="historyList"></div>
    </div>
  </div>

  <!-- è¯¦æƒ…ï¼ˆåˆ é™¤åªåœ¨è¿™é‡Œï¼‰ -->
  <div class="overlay" id="detailOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">
          <div class="modalIcon" aria-hidden="true">ğŸ—‘ï¸</div>
          <div style="min-width:0">
            <h2 id="detailTitle">è®°å½•è¯¦æƒ…</h2>
            <p id="detailSub"></p>
          </div>
        </div>
        <div class="closeBtn" id="closeDetail" aria-label="å…³é—­">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <div class="detailBody">
        <div class="detailCard">
          <div class="detailTop">
            <div class="leftBlock">
              <div class="bigPair">
                <span class="num" id="detailTwd">0</span>
                <span class="u">TWD</span>
              </div>
              <div class="meta" id="detailMetaLeft"></div>
            </div>
            <div class="rightBlock">
              <div class="bigPair rm">
                <span class="num" id="detailRm">0.00</span>
                <span class="u">RM</span>
              </div>
              <div class="meta" id="detailMetaRight"></div>
            </div>
          </div>
        </div>

        <div class="detailBtns">
          <button class="primaryClose" id="detailCloseBtn" type="button">å…³é—­</button>
          <button class="deleteBtn" id="detailDeleteBtn" type="button">åˆ é™¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é‡‘åº“ï¼šæ–°å¢è®°å½•å¼¹çª—ï¼ˆå»æ¢é’± / è®°å¼€é”€ï¼‰ -->
  <div class="overlay" id="vaultOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">
          <div class="modalIcon" id="vaultModalIcon" aria-hidden="true">ğŸ”„</div>
          <div style="min-width:0">
            <h2 id="vaultModalTitle">æ–°å¢è®°å½•</h2>
            <p id="vaultModalSub">è¾“å…¥æ•°å­—å³å¯</p>
          </div>
        </div>
        <div class="closeBtn" id="closeVault" aria-label="å…³é—­">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <div class="detailBody">
        <div class="detailCard" style="background: color-mix(in srgb, var(--card) 96%, transparent);">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
            <div class="chip" id="vaultModeChip">ğŸ”„ æ¢æ±‡å­˜å…¥</div>
            <div class="chip" id="vaultModeHint">è¾“å…¥ TWD</div>
          </div>

          <div style="margin-top:14px;display:flex;gap:12px;align-items:baseline;flex-wrap:wrap;">
            <div style="font-size:52px;font-weight:950;letter-spacing:-1.4px;" id="vaultInputPreview">0</div>
            <div style="font-size:16px;font-weight:950;color:rgba(11,19,36,.42);" id="vaultInputUnit">TWD</div>
          </div>

          <div style="margin-top:10px;color:var(--muted);font-weight:850;font-size:13px;" id="vaultCalcHint"></div>

          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;" id="emojiPick">
            <span class="chip" data-emo="ğŸ”">ğŸ” åƒå–</span>
            <span class="chip" data-emo="ğŸš—">ğŸš— äº¤é€š</span>
            <span class="chip" data-emo="ğŸ®">ğŸ® ç©ä¹</span>
            <span class="chip" data-emo="ğŸ›ï¸">ğŸ›ï¸ è´­ç‰©</span>
            <span class="chip" data-emo="ğŸ¨">ğŸ¨ ä½å®¿</span>
            <span class="chip" data-emo="ğŸ">ğŸ å…¶ä»–</span>
          </div>
        </div>

        <div class="detailBtns">
          <button class="primaryClose" id="vaultCancelBtn" type="button">å–æ¶ˆ</button>
          <button class="saveBtn" id="vaultConfirmBtn" type="button" style="flex:1;justify-content:center;">ç¡®è®¤</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =====================
    // Theme
    // =====================
    const themeBtn = document.getElementById("themeBtn");
    function loadTheme(){
      const t = localStorage.getItem("fx_theme");
      document.body.dataset.theme = (t === "dark") ? "dark" : "light";
    }
    function toggleTheme(){
      const next = (document.body.dataset.theme === "dark") ? "light" : "dark";
      document.body.dataset.theme = next;
      localStorage.setItem("fx_theme", next);
    }
    themeBtn.addEventListener("click", toggleTheme);
    loadTheme();

    // =====================
    // Rate (å½“å‰æ±‡ç‡)
    // =====================
    let currentRate = 7.949; // TWD per MYR
    const rateLabel = document.getElementById("rateLabel");
    const rateSmall = document.getElementById("rateSmall");
    const vaultRateBadge = document.getElementById("vaultRateBadge");
    function renderRate(){
      const txt = `1 : ${Number(currentRate).toFixed(3)}`;
      rateLabel.textContent = txt;
      rateSmall.textContent = txt;
      vaultRateBadge.textContent = txt;
    }
    renderRate();

    // =====================
    // History (æ¢ç®—ä¿å­˜è®°å½•) - ä¿ç•™æ—§è®°å½•è¿ç§»
    // =====================
    const HISTORY_KEY = "fx_history_v2";
    const LEGACY_KEYS = ["fx_history","history","convert_history","records","exchange_history"];

    function normalizeRecord(raw) {
      if (!raw) return null;
      const ts = Number(raw.ts ?? raw.time ?? raw.timestamp ?? Date.now());
      const rate = Number(raw.rate ?? raw.fxRate ?? raw.exchangeRate ?? 0);
      const twd = Number(raw.twd ?? raw.inputTWD ?? raw.amountTWD ?? raw.input ?? 0);
      const rm  = Number(raw.rm  ?? raw.outputRM ?? raw.amountRM ?? raw.output ?? 0);
      const note = (raw.note ?? raw.remark ?? raw.memo ?? "").toString();
      const category = (raw.category ?? raw.type ?? raw.tag ?? "").toString();
      const id = raw.id ?? `${Math.round(ts/1000)}_${rate}_${twd}_${rm}`;
      if (!Number.isFinite(ts) || !Number.isFinite(rate) || !Number.isFinite(twd) || !Number.isFinite(rm)) return null;
      return { id, ts, rate, twd, rm, category, note };
    }
    function safeParse(json){ try { return JSON.parse(json); } catch { return null; } }
    function readArrayFromKey(key){
      const txt = localStorage.getItem(key);
      if (!txt) return [];
      const parsed = safeParse(txt);
      if (!parsed) return [];
      const arr = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.list) ? parsed.list : []);
      return arr.map(normalizeRecord).filter(Boolean);
    }
    function mergeUnique(a,b){
      const map = new Map();
      [...a, ...b].forEach(r => { if (r) map.set(r.id, r); });
      return Array.from(map.values()).sort((x,y)=> y.ts - x.ts);
    }
    function migrateHistoryOnce(){
      const cur = readArrayFromKey(HISTORY_KEY);
      let merged = [...cur];
      LEGACY_KEYS.forEach(k=>{
        if (k === HISTORY_KEY) return;
        const legacy = readArrayFromKey(k);
        if (legacy.length) merged = mergeUnique(merged, legacy);
      });
      if (merged.length !== cur.length) localStorage.setItem(HISTORY_KEY, JSON.stringify(merged));
      return merged;
    }
    function loadHistory(){ return migrateHistoryOnce(); }
    function saveHistory(list){ localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); }
    function addHistory(record){
      const list = loadHistory();
      const n = normalizeRecord(record);
      if (!n) return list;
      const merged = mergeUnique(list, [n]);
      saveHistory(merged);
      return merged;
    }

    // =====================
    // Vault Records (é‡‘åº“æµæ°´ï¼šæ¢æ±‡å­˜å…¥ + å¼€é”€)
    // =====================
    const VAULT_KEY = "vault_records_v1";

    function loadVault(){
      const txt = localStorage.getItem(VAULT_KEY);
      const parsed = safeParse(txt);
      const arr = Array.isArray(parsed) ? parsed : [];
      return arr.map(x=>{
        return {
          id: x.id ?? `${x.ts}_${x.kind}_${x.amount}`,
          ts: Number(x.ts ?? Date.now()),
          kind: x.kind ?? "exchange_in", // exchange_in | expense
          amount: Number(x.amount ?? 0), // TWD for exchange_in, RM for expense (è¿™é‡Œç”¨ RM æ›´ç›´è§‚)
          emo: (x.emo ?? "ğŸ”„").toString(),
          note: (x.note ?? "").toString(),
          rate: Number(x.rate ?? currentRate)
        };
      }).sort((a,b)=>b.ts-a.ts);
    }
    function saveVault(list){ localStorage.setItem(VAULT_KEY, JSON.stringify(list)); }
    function addVault(rec){
      const list = loadVault();
      list.unshift(rec);
      saveVault(list);
      return list;
    }
    function deleteVault(id){
      const list = loadVault().filter(x=>x.id!==id);
      saveVault(list);
      return list;
    }

    // =====================
    // Calc input & keypad
    // =====================
    let expr = "0";
    let lastExprStack = [];
    const twdValueEl = document.getElementById("twdValue");
    const rmValueEl  = document.getElementById("rmValue");

    function clampExpr(s){
      if (!s || s === "") return "0";
      if (s.length > 18) return s.slice(0,18);
      return s;
    }
    function safeEval(s){
      if (!/^[0-9.+\-*/() ]+$/.test(s)) return 0;
      try{
        return Function("return (" + s + ")")();
      }catch{ return 0; }
    }
    function prettyNum(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return "0";
      const isInt = Math.abs(x - Math.round(x)) < 1e-10;
      return isInt ? String(Math.round(x)) : String(x);
    }
    function calcRM(twd){
      const v = Number(twd) || 0;
      const rate = Number(currentRate) || 1;
      return v / rate;
    }
    function renderCalc(){
      const twd = safeEval(expr);
      const rm = calcRM(twd);
      twdValueEl.textContent = prettyNum(twd);
      rmValueEl.textContent = (Number.isFinite(rm) ? rm : 0).toFixed(2);
    }
    renderCalc();

    const pad = document.getElementById("pad");
    pad.addEventListener("click", (e)=>{
      const btn = e.target.closest(".key");
      if (!btn) return;
      const act = btn.dataset.act;

      lastExprStack.push(expr);
      if (lastExprStack.length > 40) lastExprStack.shift();

      if (act === "ac"){ expr = "0"; lastExprStack = []; renderCalc(); return; }
      if (act === "back"){
        expr = (expr.length<=1) ? "0" : expr.slice(0,-1);
        expr = clampExpr(expr);
        renderCalc(); return;
      }
      if (act === "dot"){
        expr = (expr === "0") ? "0." : (expr + ".");
        expr = clampExpr(expr);
        renderCalc(); return;
      }
      if (act === "add") { expr += "+"; expr = clampExpr(expr); renderCalc(); return; }
      if (act === "sub") { expr += "-"; expr = clampExpr(expr); renderCalc(); return; }
      if (act === "mul") { expr += "*"; expr = clampExpr(expr); renderCalc(); return; }
      if (act === "div") { expr += "/"; expr = clampExpr(expr); renderCalc(); return; }
      if (act === "eq"){
        const v = safeEval(expr);
        expr = String(Number.isFinite(v) ? v : 0);
        expr = clampExpr(expr);
        renderCalc(); return;
      }
      if (/^\d$/.test(act)){
        expr = (expr === "0") ? act : (expr + act);
        expr = clampExpr(expr);
        renderCalc(); return;
      }
    });

    document.getElementById("undoBtn").addEventListener("click", ()=>{
      const prev = lastExprStack.pop();
      if (prev !== undefined) expr = prev;
      renderCalc();
    });

    // ä¿å­˜æ¢ç®—åˆ°å†å²
    document.getElementById("saveBtn").addEventListener("click", ()=>{
      const twd = safeEval(expr);
      const rm = calcRM(twd);
      addHistory({
        ts: Date.now(),
        rate: Number(currentRate),
        twd: Number(twd),
        rm: Number((Number.isFinite(rm) ? rm : 0).toFixed(2)),
        category: "",
        note: ""
      });
      flashSub("å·²ä¿å­˜åˆ°å†å²è®°å½•");
    });

    function flashSub(text){
      const sub = document.getElementById("subTitle");
      const old = sub.textContent;
      sub.textContent = text;
      setTimeout(()=> sub.textContent = old, 900);
    }

    // =====================
    // Switch pages (REAL switch)
    // =====================
    const tabVault = document.getElementById("tabVault");
    const tabCalc  = document.getElementById("tabCalc");
    const pageVault = document.getElementById("pageVault");
    const pageCalc  = document.getElementById("pageCalc");
    const pageTitle = document.getElementById("pageTitle");
    const pillRow   = document.getElementById("pillRow");

    function showCalc(){
      tabCalc.classList.add("active");
      tabVault.classList.remove("active");
      pageCalc.classList.add("show");
      pageVault.classList.remove("show");
      pageTitle.textContent = "æ¢ç®—";
      document.getElementById("subTitle").textContent = "è¾“å…¥ TWDï¼Œå³ä¾§è‡ªåŠ¨æŠ˜åˆ RM";
      pillRow.style.display = "flex";
    }
    function showVault(){
      tabVault.classList.add("active");
      tabCalc.classList.remove("active");
      pageVault.classList.add("show");
      pageCalc.classList.remove("show");
      pageTitle.textContent = "é‡‘åº“";
      document.getElementById("subTitle").textContent = "è®°å½•æ¢æ±‡ä¸å¼€é”€ï¼Œä¿æŒæ¸…æ™°";
      pillRow.style.display = "none"; // é‡‘åº“é¡µä¸ç”¨æ˜¾ç¤ºæ±‡ç‡èƒ¶å›Š/å†å²
      renderVault();
    }

    tabCalc.addEventListener("click", showCalc);
    tabVault.addEventListener("click", showVault);

    // =====================
    // History modal (æ¢ç®—å†å²)
    // =====================
    const historyOverlay = document.getElementById("historyOverlay");
    const historyList = document.getElementById("historyList");
    function fmtTime(ts){
      const d = new Date(ts);
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${mm}-${dd} ${hh}:${mi}`;
    }
    function renderHistory(){
      const list = loadHistory();
      historyList.innerHTML = "";
      if (!list.length){
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "æš‚æ— è®°å½•";
        historyList.appendChild(div);
        return;
      }
      list.forEach(rec=>{
        const item = document.createElement("div");
        item.className = "item";
        item.dataset.id = rec.id;

        const left = document.createElement("div");
        left.className = "itemLeft";
        left.innerHTML = `
          <div class="line1">
            <span class="twd">${Number(rec.twd)}<small>TWD</small></span>
          </div>
          <div class="line2">
            <span>${fmtTime(rec.ts)}</span>
            <span>Rate ${Number(rec.rate).toFixed(3)}</span>
          </div>
        `;

        const right = document.createElement("div");
        right.className = "itemRight";
        right.innerHTML = `<div class="rm">${Number(rec.rm).toFixed(2)}<small>RM</small></div>`;

        item.appendChild(left);
        item.appendChild(right);
        item.addEventListener("click", ()=> openDetail(rec.id, "history"));
        historyList.appendChild(item);
      });
    }

    document.getElementById("openHistory").addEventListener("click", ()=>{
      renderHistory();
      historyOverlay.classList.add("show");
    });
    document.getElementById("closeHistory").addEventListener("click", ()=>{
      historyOverlay.classList.remove("show");
    });
    historyOverlay.addEventListener("click", (e)=>{
      if (e.target === historyOverlay) historyOverlay.classList.remove("show");
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const list = loadHistory();
      const blob = new Blob([JSON.stringify(list, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fx_history.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      if (!confirm("ç¡®å®šæ¸…ç©ºå…¨éƒ¨å†å²è®°å½•ï¼Ÿ")) return;
      saveHistory([]);
      renderHistory();
    });

    // =====================
    // Detail modal (for both history & vault)
    // =====================
    const detailOverlay = document.getElementById("detailOverlay");
    const detailTwd = document.getElementById("detailTwd");
    const detailRm  = document.getElementById("detailRm");
    const detailSub = document.getElementById("detailSub");
    const metaLeft  = document.getElementById("detailMetaLeft");
    const metaRight = document.getElementById("detailMetaRight");
    const detailTitle = document.getElementById("detailTitle");
    let currentDetailId = null;
    let currentDetailSource = "history"; // history | vault

    function getHistoryById(id){
      const list = loadHistory();
      return list.find(x=>x.id===id) || null;
    }
    function getVaultById(id){
      const list = loadVault();
      return list.find(x=>x.id===id) || null;
    }

    function openDetail(id, source){
      currentDetailId = id;
      currentDetailSource = source;

      if (source === "history"){
        const rec = getHistoryById(id);
        if (!rec) return;
        detailTitle.textContent = "æ¢ç®—è®°å½•è¯¦æƒ…";
        detailTwd.textContent = Number(rec.twd);
        detailRm.textContent = Number(rec.rm).toFixed(2);
        detailSub.textContent = `${fmtTime(rec.ts)} Â· Rate ${Number(rec.rate).toFixed(3)}`;
        metaLeft.innerHTML = `<span class="chip">è¾“å…¥ï¼ˆTWDï¼‰</span><span class="chip">å¯ç¼–è¾‘</span>`;
        metaRight.innerHTML = `<span class="chip">æ¢ç®—ï¼ˆRMï¼‰</span><span class="chip">ä»…æ˜¾ç¤º</span>`;
      } else {
        const rec = getVaultById(id);
        if (!rec) return;

        detailTitle.textContent = (rec.kind === "exchange_in") ? "é‡‘åº“ Â· æ¢æ±‡å­˜å…¥è¯¦æƒ…" : "é‡‘åº“ Â· å¼€é”€è¯¦æƒ…";
        detailSub.textContent = `${fmtTime(rec.ts)}${rec.kind === "exchange_in" ? ` Â· Rate ${Number(rec.rate).toFixed(3)}` : ""}`;

        // å·¦ä¾§æ˜¾ç¤º TWDï¼ˆå¯¹ç§°å¡ç‰‡æ„Ÿï¼‰
        if (rec.kind === "exchange_in"){
          detailTwd.textContent = Number(rec.amount);
          detailRm.textContent = (Number(rec.amount) / Number(rec.rate || currentRate)).toFixed(2);
          metaLeft.innerHTML = `<span class="chip">${rec.emo} å­˜å…¥</span><span class="chip">TWD</span>`;
          metaRight.innerHTML = `<span class="chip">æŠ˜åˆ RM</span><span class="chip">ä»…æ˜¾ç¤º</span>`;
        }else{
          // å¼€é”€ï¼šå·¦ä¾§ç”¨ RMï¼Œå³ä¾§ç”¨ã€Œâ€”ã€ä¿æŒè§†è§‰å¹³è¡¡ï¼ˆä½†ä»æ˜¾ç¤ºæ•°å€¼ï¼‰
          detailTwd.textContent = "â€”";
          detailRm.textContent = Number(rec.amount).toFixed(2);
          metaLeft.innerHTML = `<span class="chip">${rec.emo} å¼€é”€</span><span class="chip">ä¸æ¢ç®—</span>`;
          metaRight.innerHTML = `<span class="chip">RM</span><span class="chip">å·²æ”¯å‡º</span>`;
        }
      }

      detailOverlay.classList.add("show");
    }

    function closeDetail(){
      detailOverlay.classList.remove("show");
      currentDetailId = null;
      currentDetailSource = "history";
    }
    document.getElementById("closeDetail").addEventListener("click", closeDetail);
    document.getElementById("detailCloseBtn").addEventListener("click", closeDetail);
    detailOverlay.addEventListener("click", (e)=>{
      if (e.target === detailOverlay) closeDetail();
    });

    document.getElementById("detailDeleteBtn").addEventListener("click", ()=>{
      if (!currentDetailId) return;

      if (currentDetailSource === "history"){
        if (!confirm("ç¡®å®šåˆ é™¤è¿™æ¡æ¢ç®—è®°å½•ï¼Ÿ")) return;
        const next = loadHistory().filter(x=>x.id !== currentDetailId);
        saveHistory(next);
        renderHistory();
      }else{
        if (!confirm("ç¡®å®šåˆ é™¤è¿™æ¡é‡‘åº“è®°å½•ï¼Ÿ")) return;
        deleteVault(currentDetailId);
        renderVault();
      }
      closeDetail();
    });

    // =====================
    // Vault UI
    // =====================
    const vaultBalanceEl = document.getElementById("vaultBalance");
    const vaultCashEl = document.getElementById("vaultCash");
    const vaultCardEl = document.getElementById("vaultCard");
    const vaultListEl = document.getElementById("vaultList");

    function sumVault(){
      const list = loadVault();
      let twdBalance = 0;
      let cash = 0;
      let card = 0;

      // ç®€åŒ–ï¼šå¼€é”€ä¸å†åŒºåˆ†ç°é‡‘/å¡ç‰‡ï¼ˆä½ è¦æ±‚å»æ‰æ–¹å¼é€‰æ‹©ï¼‰
      // æ‰€ä»¥ cash/card å…ˆéƒ½æ˜¾ç¤º 0ï¼Œæˆ–ä½ è¦çš„è¯ä¹Ÿå¯ä»¥æŠŠå®ƒä»¬åˆå¹¶æˆã€Œå·²èŠ± RMã€
      list.forEach(r=>{
        if (r.kind === "exchange_in") twdBalance += Number(r.amount || 0);
      });

      return {twdBalance, cash, card, list};
    }

    function renderVault(){
      const {twdBalance, cash, card, list} = sumVault();
      vaultBalanceEl.textContent = String(Math.round(twdBalance));
      vaultCashEl.textContent = String(cash);
      vaultCardEl.textContent = String(card);

      vaultListEl.innerHTML = "";
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "æš‚æ— é‡‘åº“è®°å½•";
        vaultListEl.appendChild(empty);
        return;
      }

      list.forEach(r=>{
        const row = document.createElement("div");
        row.className = "vaultItem";
        row.dataset.id = r.id;

        const left = document.createElement("div");
        left.className = "left";
        const emo = document.createElement("div");
        emo.className = "emoji";
        emo.textContent = r.emo || (r.kind==="exchange_in" ? "ğŸ”„" : "ğŸ§¾");

        const txt = document.createElement("div");
        txt.className = "txt";
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = (r.kind==="exchange_in") ? "æ¢æ±‡å­˜å…¥" : "å¼€é”€";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${fmtTime(r.ts)}${r.kind==="exchange_in" ? ` Â· Rate ${Number(r.rate).toFixed(3)}` : ""}`;

        txt.appendChild(name);
        txt.appendChild(meta);

        left.appendChild(emo);
        left.appendChild(txt);

        const amt = document.createElement("div");
        amt.className = "amt";
        amt.textContent = (r.kind==="exchange_in") ? `+${Number(r.amount)} TWD` : `-${Number(r.amount).toFixed(2)} RM`;

        row.appendChild(left);
        row.appendChild(amt);

        row.addEventListener("click", ()=> openDetail(r.id, "vault"));
        vaultListEl.appendChild(row);
      });
    }

    // =====================
    // Vault add modal (å»æ¢é’± / è®°å¼€é”€ with emoji)
    // =====================
    const vaultOverlay = document.getElementById("vaultOverlay");
    const vaultModalIcon = document.getElementById("vaultModalIcon");
    const vaultModalTitle = document.getElementById("vaultModalTitle");
    const vaultModalSub = document.getElementById("vaultModalSub");
    const vaultModeChip = document.getElementById("vaultModeChip");
    const vaultModeHint = document.getElementById("vaultModeHint");
    const vaultInputPreview = document.getElementById("vaultInputPreview");
    const vaultInputUnit = document.getElementById("vaultInputUnit");
    const vaultCalcHint = document.getElementById("vaultCalcHint");
    const vaultConfirmBtn = document.getElementById("vaultConfirmBtn");
    const emojiPick = document.getElementById("emojiPick");

    let vaultMode = "exchange_in"; // exchange_in | expense
    let vaultAmount = 0;
    let vaultEmo = "ğŸ”„";

    function openVaultModal(mode){
      vaultMode = mode;
      vaultAmount = 0;
      vaultEmo = (mode==="exchange_in") ? "ğŸ”„" : "ğŸ”";

      if (mode==="exchange_in"){
        vaultModalIcon.textContent = "ğŸ”„";
        vaultModalTitle.textContent = "æ¢æ±‡å­˜å…¥";
        vaultModalSub.textContent = "è¾“å…¥ TWD æ•°å­—å³å¯";
        vaultModeChip.textContent = "ğŸ”„ æ¢æ±‡å­˜å…¥";
        vaultModeHint.textContent = "è¾“å…¥ TWD";
        vaultInputUnit.textContent = "TWD";
        vaultCalcHint.textContent = `å°†æŒ‰å½“å‰æ±‡ç‡ 1:${Number(currentRate).toFixed(3)} æŠ˜åˆ RM`;
        emojiPick.style.display = "none";
      }else{
        vaultModalIcon.textContent = "ğŸ§¾";
        vaultModalTitle.textContent = "è®°å½•å¼€é”€";
        vaultModalSub.textContent = "é€‰ä¸€ä¸ªè¡¨æƒ…åˆ†ç±»ï¼Œå†è¾“å…¥ RM æ•°å­—";
        vaultModeChip.textContent = "ğŸ§¾ å¼€é”€";
        vaultModeHint.textContent = "è¾“å…¥ RM";
        vaultInputUnit.textContent = "RM";
        vaultCalcHint.textContent = "ä¸éœ€è¦å¤‡æ³¨ï¼Œç‚¹è¿›è¯¦æƒ…æ‰ä¼šçœ‹åˆ°å¤‡æ³¨ï¼ˆæ­¤å¤„é»˜è®¤ç©ºï¼‰";
        emojiPick.style.display = "flex";
      }

      vaultInputPreview.textContent = "0";
      vaultOverlay.classList.add("show");
    }
    function closeVaultModal(){
      vaultOverlay.classList.remove("show");
    }

    document.getElementById("vaultGoExchange").addEventListener("click", ()=> openVaultModal("exchange_in"));
    document.getElementById("vaultAddExpense").addEventListener("click", ()=> openVaultModal("expense"));

    document.getElementById("closeVault").addEventListener("click", closeVaultModal);
    document.getElementById("vaultCancelBtn").addEventListener("click", closeVaultModal);
    vaultOverlay.addEventListener("click", (e)=>{
      if (e.target === vaultOverlay) closeVaultModal();
    });

    emojiPick.addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip");
      if (!chip) return;
      const emo = chip.dataset.emo;
      if (!emo) return;
      vaultEmo = emo;

      // é€‰ä¸­æ€
      [...emojiPick.querySelectorAll(".chip")].forEach(c=>{
        c.style.outline = "none";
      });
      chip.style.outline = "2px solid rgba(20,168,116,.35)";
      chip.style.outlineOffset = "2px";
    });

    // è¿™é‡Œä¸ºäº†ç®€å•ï¼šé‡‘åº“å¼¹çª—ç›´æ¥ç”¨ prompt è¾“å…¥æ•°å­—ï¼ˆä½ è¦æˆ‘åšæ¼‚äº®æ•°å­—é”®ç›˜æˆ‘ä¹Ÿèƒ½åšï¼‰
    vaultConfirmBtn.addEventListener("click", ()=>{
      const label = (vaultMode==="exchange_in") ? "è¯·è¾“å…¥å­˜å…¥çš„ TWD æ•°å­—" : "è¯·è¾“å…¥å¼€é”€çš„ RM æ•°å­—";
      const v = prompt(label, "0");
      const num = Number(v);
      if (!Number.isFinite(num) || num <= 0) return;

      vaultAmount = num;
      vaultInputPreview.textContent = String(num);

      const rec = {
        id: `${Date.now()}_${vaultMode}_${num}`,
        ts: Date.now(),
        kind: vaultMode,
        amount: num,
        emo: vaultEmo,
        note: "",
        rate: Number(currentRate)
      };
      addVault(rec);
      renderVault();
      closeVaultModal();
    });

    // =====================
    // Init
    // =====================
    migrateHistoryOnce();
    renderVault();
    showCalc(); // é»˜è®¤åœ¨æ¢ç®—é¡µ
  </script>
</body>
</html>
