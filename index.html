<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TNG e-Mas é»„é‡‘è®°è´¦æœ¬</title>
  <style>
    :root{
      --bg: #f3f5f9; --card: #ffffff; --text: #1f2937; --sub: #6b7280;
      --primary: #005eb8; /* TNG Blue-ish */
      --primary-dark: #004c9e;
      --line: #e5e7eb;
      --green: #059669; --red: #dc2626; --orange: #d97706;
      --radius: 12px;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #111827; --card: #1f2937; --text: #f9fafb; --sub: #9ca3af;
        --line: #374151;
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding-bottom: 40px;
    }
    .wrap{max-width:800px; margin:0 auto; padding:16px;}
    
    /* Header */
    header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    h1{ font-size:18px; margin:0; color:var(--primary); font-weight:800; }
    .badge{ font-size:11px; background:var(--primary); color:#fff; padding:2px 6px; border-radius:4px; }

    /* Dashboard Cards */
    .dashboard{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:16px; }
    .card{ background:var(--card); padding:16px; border-radius:var(--radius); box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    .full-width{ grid-column: span 2; }
    
    .label{ font-size:12px; color:var(--sub); margin-bottom:4px; }
    .val{ font-size:20px; font-weight:700; letter-spacing:-0.5px; }
    .val.sm{ font-size:16px; }
    .sub-val{ font-size:12px; margin-top:4px; }
    .green{ color:var(--green); } .red{ color:var(--red); }

    /* Market Price Input Area */
    .market-bar{
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white; padding:12px 16px; border-radius:var(--radius);
      margin-bottom:16px; display:flex; align-items:center; justify-content:space-between;
      box-shadow: 0 4px 12px rgba(0,94,184,0.3);
    }
    .market-bar input{
      background: rgba(255,255,255,0.2); border:none; color:white;
      width: 100px; text-align:right; padding:6px; border-radius:6px; font-weight:bold;
    }
    .market-bar input::placeholder{ color:rgba(255,255,255,0.6); }

    /* Form Area */
    .form-box{ background:var(--card); padding:16px; border-radius:var(--radius); margin-bottom:20px; border:1px solid var(--line); }
    .form-title{ font-size:14px; font-weight:600; margin-bottom:12px; display:flex; justify-content:space-between; }
    
    .input-group{ margin-bottom:12px; }
    .input-row{ display:flex; gap:10px; }
    .input-row > div{ flex:1; }
    
    label{ display:block; font-size:11px; color:var(--sub); margin-bottom:4px; font-weight:500; }
    input, select{
      width:100%; padding:10px; background:var(--bg); border:1px solid var(--line);
      border-radius:8px; color:var(--text); font-size:14px; outline:none;
      transition: border-color 0.2s;
    }
    input:focus{ border-color:var(--primary); }
    
    .helper-chips{ display:flex; gap:6px; margin-top:6px; overflow-x:auto; padding-bottom:2px; }
    .chip{
      font-size:11px; padding:4px 10px; background:var(--bg); border:1px solid var(--line);
      border-radius:20px; color:var(--sub); cursor:pointer; white-space:nowrap;
    }
    .chip:active{ background:var(--line); }

    .btn-main{
      width:100%; background:var(--primary); color:white; border:none;
      padding:14px; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer;
      box-shadow: 0 4px 10px rgba(0,94,184,0.2);
    }
    .btn-main:active{ transform:scale(0.98); }
    .btn-danger{ background:var(--red); box-shadow:none; }

    /* List Area */
    .list-header{ display:flex; justify-content:space-between; align-items:end; margin-bottom:10px; padding:0 4px; }
    .tx-item{
      background:var(--card); padding:12px; border-radius:10px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center;
      border-left: 4px solid transparent;
    }
    .tx-item.buy{ border-left-color: var(--green); }
    .tx-item.sell{ border-left-color: var(--red); }
    
    .tx-left h4{ margin:0 0 2px; font-size:14px; }
    .tx-left p{ margin:0; font-size:11px; color:var(--sub); }
    .tx-right{ text-align:right; }
    .tx-right .amt{ font-weight:700; font-size:14px; }
    .tx-right .grams{ font-size:11px; color:var(--sub); }
    .del-btn{ color:var(--sub); font-size:18px; margin-left:10px; cursor:pointer; padding:0 5px;}

    /* Utilities */
    .modal{
      position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8);
      z-index:99; display:none; justify-content:center; align-items:center; padding:20px;
    }
    .modal-content{ background:var(--card); width:100%; max-width:400px; padding:20px; border-radius:16px; }
    .flex-gap{ display:flex; gap:10px; margin-top:10px; }
    .hidden{ display:none; }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>TNG e-Mas è®°è´¦æœ¬</h1>
    <span class="badge">V2.0</span>
  </header>

  <div class="market-bar">
    <div style="font-size:13px; line-height:1.2">
      <div>å½“å‰å¸‚åœºå–ä»· (RM/g)</div>
      <div style="font-size:10px; opacity:0.8">è¾“å…¥ e-Mas "Sell" ä»·æ ¼æŸ¥çœ‹æµ®ç›ˆ</div>
    </div>
    <input type="number" id="marketPrice" placeholder="0.00" inputmode="decimal" step="0.01">
  </div>

  <div class="dashboard">
    <div class="card">
      <div class="label">å½“å‰æŒä»“ (å…‹)</div>
      <div class="val" id="kpiHolding">0.0000</div>
    </div>
    <div class="card">
      <div class="label">å¹³å‡æˆæœ¬ (RM/g)</div>
      <div class="val" id="kpiAvgCost">0.00</div>
    </div>
    <div class="card full-width">
      <div style="display:flex; justify-content:space-between;">
        <div>
          <div class="label">æŒä»“ç°å€¼ / æµ®åŠ¨ç›ˆäº</div>
          <div class="val" id="kpiMarketValue">RM 0.00</div>
          <div class="sub-val" id="kpiUnrealized">0.00 (0%)</div>
        </div>
        <div style="text-align:right">
          <div class="label">å·²è½è¢‹ç›ˆäº</div>
          <div class="val sm" id="kpiRealized">RM 0.00</div>
        </div>
      </div>
    </div>
  </div>

  <div class="form-box">
    <div class="form-title">
      <span>è®°ä¸€ç¬”</span>
      <span style="font-weight:400; color:var(--sub); font-size:11px" id="toggleMode">é‡ç½®</span>
    </div>
    
    <div class="input-row" style="margin-bottom:12px;">
      <div style="flex:0.7">
        <label>ç±»å‹</label>
        <select id="type" onchange="updateFormColor()">
          <option value="buy">ä¹°å…¥ (Buy)</option>
          <option value="sell">å–å‡º (Sell)</option>
        </select>
      </div>
      <div style="flex:1.3">
        <label>æ—¥æœŸ</label>
        <input id="date" type="date">
      </div>
    </div>

    <div class="input-group">
      <label>æ€»é‡‘é¢ (RM)</label>
      <input id="amount" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ 100.00" step="0.01">
      <div class="helper-chips" id="amtChips">
        <div class="chip" onclick="setAmt(10)">RM10</div>
        <div class="chip" onclick="setAmt(50)">RM50</div>
        <div class="chip" onclick="setAmt(100)">RM100</div>
        <div class="chip" onclick="setAmt(200)">RM200</div>
      </div>
    </div>

    <div class="input-row">
      <div>
        <label>æˆäº¤å•ä»· (RM/g)</label>
        <input id="pricePerGram" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ 380.50" step="0.01">
      </div>
      <div>
        <label>è·å¾—/å–å‡ºå…‹æ•° (g)</label>
        <input id="grams" type="number" inputmode="decimal" placeholder="è‡ªåŠ¨è®¡ç®—" step="0.000001">
      </div>
    </div>
    
    <div style="font-size:11px; color:var(--orange); margin-bottom:10px; display:none" id="calcHint">
      ğŸ’¡ è¾“å…¥é‡‘é¢å’Œå•ä»·ï¼Œè‡ªåŠ¨ç®—å…‹æ•°ã€‚æˆ–è¾“å…¥é‡‘é¢å’Œå…‹æ•°(ç…§æŠ„æ”¶æ®)ã€‚
    </div>

    <input id="note" type="text" placeholder="å¤‡æ³¨ (ä¾‹å¦‚: åˆæ˜¯é«˜ä½ç«™å²—...)" style="margin-bottom:12px;">

    <button class="btn-main" id="addBtn">ç¡®è®¤æ·»åŠ </button>
  </div>

  <div class="list-header">
    <div class="label">äº¤æ˜“è®°å½•</div>
    <div class="chip" onclick="openMenu()">æ•°æ®ç®¡ç† / å¯¼å‡º</div>
  </div>
  <div id="txList"></div>

</div>

<div class="modal" id="menuModal">
  <div class="modal-content">
    <h3>æ•°æ®ç®¡ç†</h3>
    <p style="font-size:12px; color:var(--sub); margin-bottom:20px;">æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ç¼“å­˜ä¸­ã€‚å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚</p>
    <button class="btn-main" style="background:var(--sub); margin-bottom:10px;" onclick="exportData()">å¯¼å‡ºå¤‡ä»½ (JSON)</button>
    <button class="btn-main" style="background:var(--sub); margin-bottom:10px;" onclick="document.getElementById('fileInput').click()">å¯¼å…¥å¤‡ä»½</button>
    <div class="flex-gap">
      <button class="btn-main btn-danger" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
      <button class="btn-main" style="background:var(--bg); color:var(--text); border:1px solid var(--line)" onclick="closeMenu()">å…³é—­</button>
    </div>
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(this)">
  </div>
</div>

<script>
  // --- Constants & State ---
  const LS_KEY = "tng_gold_v2";
  const LS_MARKET = "tng_last_market_price";
  
  // --- DOM Elements ---
  const el = (id) => document.getElementById(id);
  
  // --- Initialization ---
  function init(){
    const today = new Date().toISOString().split('T')[0];
    el('date').value = today;
    
    // Auto-calc logic: 
    // If Amount & Price changed -> Calc Grams
    // If Amount & Grams changed -> Calc Price
    ['amount', 'pricePerGram'].forEach(id => {
      el(id).addEventListener('input', () => tryCalc('grams'));
    });
    el('grams').addEventListener('input', () => tryCalc('price'));

    el('marketPrice').value = localStorage.getItem(LS_MARKET) || "";
    el('marketPrice').addEventListener('input', (e) => {
      localStorage.setItem(LS_MARKET, e.target.value);
      render();
    });

    render();
  }

  // --- Core Calculation Logic ---
  function tryCalc(target){
    const amt = parseFloat(el('amount').value);
    const price = parseFloat(el('pricePerGram').value);
    const grams = parseFloat(el('grams').value);

    if(target === 'grams' && amt && price){
      el('grams').value = (amt / price).toFixed(6);
    } else if (target === 'price' && amt && grams){
      el('pricePerGram').value = (amt / grams).toFixed(2);
    }
  }

  function setAmt(val){
    el('amount').value = val;
    tryCalc('grams');
  }

  function loadData(){
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : [];
  }

  function saveData(data){
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }

  function getMetrics(txs){
    let holding = 0;
    let costTotal = 0; // Total money spent on current holding
    let realizedPL = 0;

    // Sort by date then timestamp
    const sorted = [...txs].sort((a,b) => {
      if(a.date !== b.date) return a.date > b.date ? 1 : -1;
      return a.ts - b.ts;
    });

    for(let t of sorted){
      const g = parseFloat(t.grams);
      const amt = parseFloat(t.amount);
      
      if(t.type === 'buy'){
        holding += g;
        costTotal += amt;
      } else {
        // Selling uses Weighted Average Cost
        if(holding <= 0) continue; // Should not happen ideally
        const avgCost = costTotal / holding;
        const costOfSold = g * avgCost;
        
        realizedPL += (amt - costOfSold);
        holding -= g;
        costTotal -= costOfSold;
        
        if(holding < 0.000001) { holding = 0; costTotal = 0; }
      }
    }
    
    const avgCost = holding > 0 ? costTotal / holding : 0;
    return { holding, avgCost, realizedPL, costTotal };
  }

  // --- Rendering ---
  function render(){
    const txs = loadData();
    const m = getMetrics(txs);
    const marketPrice = parseFloat(el('marketPrice').value) || 0;

    // Update KPI Cards
    el('kpiHolding').textContent = m.holding.toFixed(4);
    el('kpiAvgCost').textContent = m.avgCost.toFixed(2);
    el('kpiRealized').textContent = "RM " + m.realizedPL.toFixed(2);
    el('kpiRealized').className = "val sm " + (m.realizedPL >= 0 ? "green" : "red");

    // Unrealized / Market Value Logic
    const marketVal = m.holding * marketPrice;
    el('kpiMarketValue').textContent = "RM " + (marketPrice > 0 ? marketVal.toFixed(2) : "0.00");
    
    if(marketPrice > 0 && m.holding > 0){
      const unrealized = marketVal - m.costTotal;
      const pct = (unrealized / m.costTotal) * 100;
      const sign = unrealized >= 0 ? "+" : "";
      el('kpiUnrealized').textContent = `${sign}${unrealized.toFixed(2)} (${sign}${pct.toFixed(1)}%)`;
      el('kpiUnrealized').className = "sub-val " + (unrealized >= 0 ? "green" : "red");
    } else {
      el('kpiUnrealized').textContent = "éœ€è¾“å…¥å¸‚åœºå–ä»·";
      el('kpiUnrealized').className = "sub-val";
    }

    // Render List (Newest first)
    const listEl = el('txList');
    listEl.innerHTML = "";
    
    const sortedDesc = [...txs].sort((a,b) => {
      if(a.date !== b.date) return a.date < b.date ? 1 : -1;
      return b.ts - a.ts;
    });

    sortedDesc.forEach(t => {
      const div = document.createElement('div');
      const isBuy = t.type === 'buy';
      div.className = `tx-item ${t.type}`;
      div.innerHTML = `
        <div class="tx-left">
          <h4>${isBuy ? 'ä¹°å…¥' : 'å–å‡º'} <span style="font-weight:400; color:var(--sub); font-size:12px">@ RM${parseFloat(t.price).toFixed(2)}/g</span></h4>
          <p>${t.date} ${t.note ? ' Â· '+t.note : ''}</p>
        </div>
        <div class="tx-right">
          <div class="amt ${isBuy?'':'green'}">RM ${parseFloat(t.amount).toFixed(2)}</div>
          <div class="grams">${parseFloat(t.grams).toFixed(4)} g</div>
        </div>
        <div class="del-btn" onclick="deleteTx(${t.ts})">Ã—</div>
      `;
      listEl.appendChild(div);
    });
  }

  // --- Actions ---
  el('addBtn').onclick = () => {
    const type = el('type').value;
    const date = el('date').value;
    const amount = parseFloat(el('amount').value);
    const grams = parseFloat(el('grams').value);
    const price = parseFloat(el('pricePerGram').value);

    if(!amount || !grams || !date) { alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯"); return; }
    
    // Check sell limit
    if(type === 'sell'){
      const currentData = loadData();
      const m = getMetrics(currentData);
      if(grams > m.holding + 0.000001){ // Tolerance
        alert(`æŒä»“ä¸è¶³ï¼å½“å‰åªæœ‰ ${m.holding.toFixed(4)}g`);
        return;
      }
    }

    const tx = {
      ts: Date.now(),
      type, date, amount, grams, price,
      note: el('note').value
    };

    const data = loadData();
    data.push(tx);
    saveData(data);
    
    // Reset Form
    el('amount').value = "";
    el('grams').value = "";
    el('note').value = "";
    render();
  }

  function deleteTx(ts){
    if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
    let data = loadData();
    data = data.filter(t => t.ts !== ts);
    saveData(data);
    render();
  }

  function updateFormColor(){
    const isBuy = el('type').value === 'buy';
    el('addBtn').style.background = isBuy ? 'var(--primary)' : 'var(--red)';
    el('addBtn').textContent = isBuy ? 'ç¡®è®¤ä¹°å…¥' : 'ç¡®è®¤å–å‡º';
  }

  // --- Data Mgmt ---
  function openMenu(){ el('menuModal').style.display = 'flex'; }
  function closeMenu(){ el('menuModal').style.display = 'none'; }
  
  function clearData(){
    if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ— æ³•æ¢å¤ï¼")){
      localStorage.removeItem(LS_KEY);
      render();
      closeMenu();
    }
  }

  function exportData(){
    const data = loadData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TNG_Gold_Backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
  }

  function importData(input){
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const json = JSON.parse(e.target.result);
        if(Array.isArray(json)){
          saveData(json);
          render();
          alert("å¯¼å…¥æˆåŠŸ");
          closeMenu();
        } else {
          alert("æ–‡ä»¶æ ¼å¼é”™è¯¯");
        }
      } catch(err){
        alert("JSON è§£æå¤±è´¥");
      }
    };
    reader.readAsText(file);
    input.value = "";
  }

  // Run
  init();

</script>
</body>
</html>
