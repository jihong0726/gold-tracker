<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>黄金买卖记录与成本计算器</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#8aa0b5; --text:#e6eef6;
      --line:#223044; --good:#40c57a; --bad:#ff5a6b; --warn:#ffcc66;
      --btn:#1f2a3a; --btn2:#223a5a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 40%, #0b0f14 100%);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans SC, PingFang SC, Microsoft YaHei, Arial;
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    h1{font-size:20px; margin:0 0 12px;}
    .grid{
      display:grid; grid-template-columns: 1fr; gap:12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 420px 1fr;}
    }
    .card{
      background:rgba(17,24,38,.92);
      border:1px solid var(--line);
      border-radius:16px; padding:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select, textarea{
      width:100%; padding:10px 10px; border-radius:12px;
      border:1px solid var(--line); background:#0c1320; color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:#3d5a80}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
    }
    button.primary{background:var(--btn2);}
    button.danger{background:#2a1014; border-color:#4b1f27;}
    button:hover{filter:brightness(1.08)}
    .kpis{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .kpi{
      border:1px dashed var(--line);
      border-radius:14px; padding:10px;
      background:rgba(12,19,32,.65);
    }
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:18px; margin-top:6px}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th, td{
      padding:10px 8px; border-bottom:1px solid var(--line);
      font-size:13px; text-align:left; vertical-align:top;
    }
    th{color:var(--muted); font-weight:600}
    .tag{
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-size:12px; border:1px solid var(--line); background:rgba(12,19,32,.7);
    }
    .buy{border-color:#275a3a; color:var(--good)}
    .sell{border-color:#5a2a33; color:var(--bad)}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .note{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.5}
    .split{height:1px; background:var(--line); margin:12px 0;}
    .nowrap{white-space:nowrap}
    .err{color:var(--bad); font-size:12px; margin-top:8px; display:none;}
    .ok{color:var(--good); font-size:12px; margin-top:8px; display:none;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>黄金买卖记录与成本计算器（每克计价）</h1>
  <div class="grid">
    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="t">当前持仓（克）</div>
          <div class="v" id="kpiHolding">0.000000</div>
          <div class="s">卖出会减少持仓，不能卖超出当前持仓</div>
        </div>
        <div class="kpi">
          <div class="t">当前平均成本（每克）</div>
          <div class="v" id="kpiAvg">RM 0.00</div>
          <div class="s">采用加权平均成本法</div>
        </div>
        <div class="kpi">
          <div class="t">持仓成本总额</div>
          <div class="v" id="kpiCost">RM 0.00</div>
          <div class="s">= 持仓克数 × 平均成本</div>
        </div>
        <div class="kpi">
          <div class="t">已实现盈亏</div>
          <div class="v" id="kpiRealized">RM 0.00</div>
          <div class="s">= 卖出收入 - 卖出部分成本</div>
        </div>
      </div>

      <div class="split"></div>

      <div class="row">
        <div style="flex:0.9">
          <label>类型</label>
          <select id="type">
            <option value="buy">买入</option>
            <option value="sell">卖出</option>
          </select>
        </div>
        <div style="flex:1.1">
          <label>日期</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>价格（每克，RM）</label>
          <input id="price" type="number" inputmode="decimal" step="0.000001" placeholder="例如 613.61" />
        </div>
        <div>
          <label>数量（克）</label>
          <input id="grams" type="number" inputmode="decimal" step="0.000001" placeholder="例如 0.896337" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>备注（可选）</label>
          <input id="note" type="text" placeholder="例如 金店A / 线上平台 / 促销等" />
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" id="addBtn">添加记录</button>
        <button id="exportBtn">导出备份（JSON）</button>
        <button id="importBtn">导入备份（JSON）</button>
        <button class="danger" id="clearBtn">清空全部数据</button>
      </div>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>

      <div class="note">
        说明<br/>
        - 金额会自动计算：总额 = 每克价格 × 克数<br/>
        - 卖出会按当前平均成本扣减成本并计算已实现盈亏<br/>
        - 数据只保存在你的浏览器里，换电脑或清缓存就没了，所以建议定期导出备份
      </div>

      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div style="flex:1.3">
          <label>快速筛选</label>
          <input id="search" type="text" placeholder="输入备注关键字或日期（YYYY-MM-DD）" />
        </div>
        <div style="flex:0.7">
          <label>只看</label>
          <select id="filterType">
            <option value="all">全部</option>
            <option value="buy">只看买入</option>
            <option value="sell">只看卖出</option>
          </select>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th class="nowrap">日期</th>
            <th>类型</th>
            <th class="right nowrap">每克价格</th>
            <th class="right nowrap">克数</th>
            <th class="right nowrap">总额</th>
            <th>备注</th>
            <th class="right nowrap">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="note small">
        计算逻辑（加权平均成本）<br/>
        - 买入：成本总额 += 买入金额；持仓克数 += 买入克数；平均成本 = 成本总额 / 持仓克数<br/>
        - 卖出：卖出部分成本 = 卖出克数 × 当前平均成本；已实现盈亏 += 卖出金额 - 卖出部分成本；成本总额 -= 卖出部分成本；持仓克数 -= 卖出克数
      </div>
    </div>
  </div>
</div>

<script>
  const LS_KEY = "gold_ledger_v1";

  const el = (id) => document.getElementById(id);
  const fmtRM = (n) => "RM " + (isFinite(n) ? Number(n).toFixed(2) : "0.00");
  const fmt6 = (n) => (isFinite(n) ? Number(n).toFixed(6) : "0.000000");

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { tx: [] };
      const parsed = JSON.parse(raw);
      if(!parsed || !Array.isArray(parsed.tx)) return { tx: [] };
      return parsed;
    }catch{
      return { tx: [] };
    }
  }

  function saveState(state){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function uid(){
    return Math.random().toString(36).slice(2) + Date.now().toString(36);
  }

  function showMsg(type, msg){
    const err = el("errBox");
    const ok = el("okBox");
    err.style.display = "none";
    ok.style.display = "none";
    if(type === "err"){
      err.textContent = msg;
      err.style.display = "block";
    }else{
      ok.textContent = msg;
      ok.style.display = "block";
      setTimeout(()=> ok.style.display="none", 2000);
    }
  }

  function compute(state){
    // 按时间 + 添加顺序排序，保证成本计算一致
    const tx = [...state.tx].sort((a,b)=>{
      const da = (a.date || "");
      const db = (b.date || "");
      if(da !== db) return da < db ? -1 : 1;
      return (a.createdAt||0) - (b.createdAt||0);
    });

    let holding = 0;
    let costTotal = 0;
    let realized = 0;

    for(const t of tx){
      const price = Number(t.price);
      const grams = Number(t.grams);
      if(!(price > 0 && grams > 0)) continue;

      const amount = price * grams;

      if(t.type === "buy"){
        costTotal += amount;
        holding += grams;
      }else if(t.type === "sell"){
        if(holding <= 0) continue;
        const avg = costTotal / holding;
        const sellCost = grams * avg;
        realized += amount - sellCost;
        costTotal -= sellCost;
        holding -= grams;

        // 防止浮点误差导致负数
        if(holding < 1e-12){ holding = 0; costTotal = 0; }
        if(costTotal < 1e-12) costTotal = 0;
      }
    }

    const avgCost = holding > 0 ? costTotal / holding : 0;
    return { holding, costTotal, avgCost, realized };
  }

  function validateAdd(state, t){
    if(!t.date) return "请填写日期";
    if(!(t.price > 0)) return "每克价格必须大于 0";
    if(!(t.grams > 0)) return "克数必须大于 0";

    if(t.type === "sell"){
      const m = compute(state);
      if(t.grams - m.holding > 1e-12){
        return "卖出克数不能超过当前持仓（当前持仓 " + fmt6(m.holding) + " 克）";
      }
    }
    return "";
  }

  function render(){
    const state = loadState();
    const m = compute(state);

    el("kpiHolding").textContent = fmt6(m.holding);
    el("kpiAvg").textContent = fmtRM(m.avgCost);
    el("kpiCost").textContent = fmtRM(m.costTotal);

    const realizedEl = el("kpiRealized");
    realizedEl.textContent = fmtRM(m.realized);
    realizedEl.style.color = m.realized >= 0 ? "var(--good)" : "var(--bad)";

    const q = (el("search").value || "").trim().toLowerCase();
    const ft = el("filterType").value;

    const rows = [...state.tx].sort((a,b)=>{
      const da = (a.date || "");
      const db = (b.date || "");
      if(da !== db) return da < db ? 1 : -1; // 默认最新在上
      return (b.createdAt||0) - (a.createdAt||0);
    }).filter(t=>{
      if(ft !== "all" && t.type !== ft) return false;
      if(!q) return true;
      const s = (t.date + " " + (t.note||"") + " " + t.type).toLowerCase();
      return s.includes(q);
    });

    const tb = el("tbody");
    tb.innerHTML = "";

    for(const t of rows){
      const price = Number(t.price);
      const grams = Number(t.grams);
      const amount = price * grams;

      const tr = document.createElement("tr");

      const typeTag = document.createElement("span");
      typeTag.className = "tag " + (t.type === "buy" ? "buy" : "sell");
      typeTag.textContent = t.type === "buy" ? "买入" : "卖出";

      tr.innerHTML = `
        <td class="nowrap">${t.date || "-"}</td>
        <td></td>
        <td class="right nowrap">${fmtRM(price)}</td>
        <td class="right nowrap">${fmt6(grams)}</td>
        <td class="right nowrap">${fmtRM(amount)}</td>
        <td>${(t.note || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
        <td class="right nowrap"></td>
      `;

      tr.children[1].appendChild(typeTag);

      const delBtn = document.createElement("button");
      delBtn.textContent = "删除";
      delBtn.className = "danger";
      delBtn.onclick = ()=>{
        const st = loadState();
        st.tx = st.tx.filter(x => x.id !== t.id);
        saveState(st);
        render();
        showMsg("ok", "已删除");
      };
      tr.children[6].appendChild(delBtn);

      tb.appendChild(tr);
    }
  }

  function init(){
    // 默认日期为今天（按浏览器本地时区）
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    el("date").value = `${yyyy}-${mm}-${dd}`;

    el("addBtn").onclick = ()=>{
      const state = loadState();
      const t = {
        id: uid(),
        type: el("type").value,
        date: el("date").value,
        price: Number(el("price").value),
        grams: Number(el("grams").value),
        note: el("note").value || "",
        createdAt: Date.now()
      };

      const err = validateAdd(state, t);
      if(err){ showMsg("err", err); return; }

      state.tx.push(t);
      saveState(state);

      el("price").value = "";
      el("grams").value = "";
      el("note").value = "";

      render();
      showMsg("ok", "已添加记录");
    };

    el("exportBtn").onclick = ()=>{
      const state = loadState();
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "黄金记录备份.json";
      a.click();
      URL.revokeObjectURL(url);
      showMsg("ok", "已导出备份");
    };

    el("importBtn").onclick = ()=> el("importFile").click();

    el("importFile").addEventListener("change", async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !Array.isArray(data.tx)) throw new Error("格式不正确");
        // 简单清洗
        data.tx = data.tx.map(t=>({
          id: t.id || uid(),
          type: t.type === "sell" ? "sell" : "buy",
          date: t.date || "",
          price: Number(t.price) || 0,
          grams: Number(t.grams) || 0,
          note: t.note || "",
          createdAt: Number(t.createdAt) || Date.now()
        }));
        saveState(data);
        render();
        showMsg("ok", "已导入备份");
      }catch(err){
        showMsg("err", "导入失败：请确认选择的是本工具导出的 JSON 文件");
      }finally{
        e.target.value = "";
      }
    });

    el("clearBtn").onclick = ()=>{
      const ok = confirm("确定要清空全部数据吗？清空后无法恢复，建议先导出备份。");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      render();
      showMsg("ok", "已清空");
    };

    el("search").addEventListener("input", render);
    el("filterType").addEventListener("change", render);

    render();
  }

  init();
</script>
</body>
</html>
