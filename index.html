<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>TNG 黄金管家</title>
  <style>
    :root{
      --bg: #f5f7fa; --card: #ffffff; --text: #1f2937; --sub: #9ca3af;
      --primary: #005eb8; --primary-light: rgba(0,94,184,0.1);
      --line: #e5e7eb; --green: #10b981; --red: #ef4444;
      --nav-height: 60px;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #111827; --card: #1f2937; --text: #f3f4f6; --sub: #6b7280;
        --line: #374151;
      }
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; background: var(--bg); color: var(--text); 
      font-family: -apple-system, sans-serif; 
      padding-bottom: calc(var(--nav-height) + 20px); /* 给底部导航栏留空 */
    }
    .wrap { max-width: 500px; margin: 0 auto; padding: 16px; display: none; }
    .wrap.active { display: block; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    /* Header & Cards */
    h2 { font-size: 18px; margin: 0 0 16px; color: var(--text); font-weight: 800; }
    .card { background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    
    /* Input Areas */
    .market-bar {
      background: linear-gradient(135deg, var(--primary), #004c9e);
      color: white; padding: 16px; border-radius: 16px;
      margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;
    }
    .market-bar input {
      width: 100px; text-align: right; padding: 8px; border-radius: 8px;
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: white; font-weight: 700; font-size: 18px; outline: none;
    }
    .market-bar input::placeholder { color: rgba(255,255,255,0.5); }

    /* Dashboard Grid */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .kpi-label { font-size: 11px; color: var(--sub); text-transform: uppercase; margin-bottom: 4px; }
    .kpi-val { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .kpi-sub { font-size: 11px; margin-top: 4px; }
    .green { color: var(--green); } .red { color: var(--red); }

    /* List */
    .tx-item { 
      display: flex; justify-content: space-between; padding: 14px 0; 
      border-bottom: 1px solid var(--line); 
    }
    .tx-item:last-child { border-bottom: none; }
    .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; font-weight: 600; }
    .tag.buy { background: rgba(16,185,129,0.1); color: var(--green); }
    .tag.sell { background: rgba(239,68,68,0.1); color: var(--red); }

    /* Chart Page Styles */
    .chart-box { width: 100%; height: 250px; position: relative; margin-top: 10px; }
    svg { width: 100%; height: 100%; overflow: visible; }
    .chart-line { fill: none; stroke: var(--primary); stroke-width: 3; stroke-linejoin: round; }
    .chart-area { fill: url(#gradient); stroke: none; }
    .chart-dot { fill: var(--card); stroke: var(--primary); stroke-width: 2; }
    .tooltip { 
      position: absolute; background: #1f2937; color: #fff; 
      padding: 6px 10px; border-radius: 6px; font-size: 11px; 
      pointer-events: none; opacity: 0; transition: 0.2s; transform: translate(-50%, -120%);
    }

    /* Bottom Navigation */
    .nav-bar {
      position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height);
      background: var(--card); border-top: 1px solid var(--line);
      display: flex; justify-content: space-around; align-items: center;
      padding-bottom: env(safe-area-inset-bottom); /* iPhone X适配 */
      z-index: 100;
    }
    .nav-item {
      flex: 1; text-align: center; color: var(--sub); cursor: pointer;
      font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
      height: 100%;
    }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item.active { color: var(--primary); }

    /* Modal & Form */
    .btn-float {
      position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px;
      width: 56px; height: 56px; border-radius: 50%; background: var(--primary);
      color: white; font-size: 28px; border: none; box-shadow: 0 4px 12px rgba(0,94,184,0.4);
      display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 90;
    }
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200;
      background: rgba(0,0,0,0.6); display: none; align-items: flex-end;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card); width: 100%; padding: 24px; 
      border-radius: 24px 24px 0 0; animation: slideUp 0.25s;
    }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    input, select { 
      width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--line); 
      border-radius: 12px; background: var(--bg); color: var(--text); font-size: 16px; box-sizing: border-box;
    }
    .btn-block { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; }

  </style>
</head>
<body>

<div id="view-home" class="wrap active">
  <h2>我的持仓</h2>
  
  <div class="market-bar">
    <div>
      <div style="font-size:13px; font-weight:600">今日回收价 (We Buy)</div>
      <div style="font-size:11px; opacity:0.8; margin-top:2px">输入价格更新市值</div>
    </div>
    <input type="number" id="marketPrice" placeholder="0.00" inputmode="decimal" step="0.01">
  </div>

  <div class="grid">
    <div class="card">
      <div class="kpi-label">持有黄金 (g)</div>
      <div class="kpi-val" id="kpiHolding">0.0000</div>
    </div>
    <div class="card">
      <div class="kpi-label">平均成本 (RM)</div>
      <div class="kpi-val" id="kpiAvg">0.00</div>
    </div>
    <div class="card" style="grid-column: span 2">
      <div style="display:flex; justify-content:space-between; align-items:flex-end">
        <div>
          <div class="kpi-label">浮动盈亏 (Unrealized)</div>
          <div class="kpi-val" id="kpiProfit">RM 0.00</div>
        </div>
        <div class="kpi-sub" id="kpiRoi">---</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="kpi-label" style="margin-bottom:12px">最近交易</div>
    <div id="txList"></div>
  </div>

  <button class="btn-float" onclick="openModal()">+</button>
</div>

<div id="view-chart" class="wrap">
  <h2>资产走势</h2>
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:flex-end">
      <div>
        <div class="kpi-label">总资产估值</div>
        <div class="kpi-val" id="chartTotalVal" style="color:var(--primary)">RM 0.00</div>
      </div>
      <div class="kpi-sub" style="color:var(--sub)">每日更新</div>
    </div>
    <div class="chart-box" id="chartBox">
      <div class="tooltip" id="tooltip"></div>
    </div>
  </div>

  <div class="card">
    <div class="kpi-label" style="margin-bottom:10px">市值历史记录</div>
    <div id="historyList" style="font-size:12px;"></div>
  </div>
  
  <div style="text-align:center; margin-top:20px">
    <button onclick="clearHistory()" style="background:transparent; border:1px solid var(--line); color:var(--sub); padding:8px 16px; border-radius:99px; font-size:12px">重置图表数据</button>
  </div>
</div>

<nav class="nav-bar">
  <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    <span>记账</span>
  </div>
  <div class="nav-item" onclick="switchTab('chart')" id="nav-chart">
    <svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
    <span>趋势</span>
  </div>
</nav>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 style="margin:0 0 20px">记一笔</h3>
    <div style="display:flex; gap:10px; margin-bottom:10px">
      <select id="type" style="flex:1"><option value="buy">买入 (Buy)</option><option value="sell">卖出 (Sell)</option></select>
      <input type="date" id="date" style="flex:1">
    </div>
    <input type="number" id="amount" placeholder="总金额 (RM)" oninput="calc()">
    <div style="display:flex; gap:10px">
      <input type="number" id="price" placeholder="单价 (RM/g)" oninput="calc()">
      <input type="number" id="grams" placeholder="克数 (g)" disabled style="background:var(--bg)">
    </div>
    <input type="text" id="note" placeholder="备注 (选填)">
    
    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn-block" style="background:var(--bg); color:var(--text); flex:1" onclick="closeModal()">取消</button>
      <button class="btn-block" style="flex:2" onclick="saveTx()">保存</button>
    </div>
  </div>
</div>

<script>
  // --- 配置与状态 ---
  const LS_TX = "tng_tx_v6";
  const LS_MARKET = "tng_market_v6";
  const LS_HIST = "tng_hist_v6";

  const el = (id) => document.getElementById(id);

  // --- 页面切换逻辑 ---
  function switchTab(tab){
    // 切换内容显隐
    document.querySelectorAll('.wrap').forEach(d => d.classList.remove('active'));
    el('view-' + tab).classList.add('active');
    
    // 切换底部按钮高亮
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el('nav-' + tab).classList.add('active');

    // 如果切换到图表页，立即重绘图表
    if(tab === 'chart') {
      renderChart();
      renderHistoryList();
    }
  }

  // --- 初始化 ---
  function init(){
    el('date').value = new Date().toISOString().split('T')[0];
    el('marketPrice').value = localStorage.getItem(LS_MARKET) || "";
    
    // 监听市场价变动 -> 自动记录历史
    el('marketPrice').addEventListener('change', (e) => {
      const p = parseFloat(e.target.value);
      if(p > 0){
        localStorage.setItem(LS_MARKET, p);
        recordHistory(p); // 核心：更新今日市值
        renderHome(); // 刷新首页数据
      }
    });

    renderHome();
  }

  // --- 数据处理 ---
  function loadTx() { return JSON.parse(localStorage.getItem(LS_TX) || "[]"); }
  function loadHist() { return JSON.parse(localStorage.getItem(LS_HIST) || "[]"); }

  function getHolding(){
    let holding = 0, cost = 0;
    const txs = loadTx().sort((a,b) => a.date > b.date ? 1 : -1);
    txs.forEach(t => {
      const g = parseFloat(t.grams), a = parseFloat(t.amount);
      if(t.type === 'buy') { holding += g; cost += a; }
      else { 
        if(holding > 0) cost -= (g * (cost/holding));
        holding -= g; 
      }
    });
    return { holding: Math.max(0, holding), cost: Math.max(0, cost) };
  }

  // 记录市值历史
  function recordHistory(price){
    const { holding } = getHolding();
    if(holding <= 0) return;
    
    const today = new Date().toISOString().split('T')[0];
    const val = holding * price;
    let hist = loadHist();
    
    const idx = hist.findIndex(h => h.date === today);
    if(idx >= 0) hist[idx].val = val;
    else hist.push({ date: today, val });
    
    hist.sort((a,b) => a.date > b.date ? 1 : -1);
    localStorage.setItem(LS_HIST, JSON.stringify(hist));
  }

  // --- 首页渲染 ---
  function renderHome(){
    const txs = loadTx();
    const { holding, cost } = getHolding();
    const mp = parseFloat(el('marketPrice').value) || 0;

    // KPI
    el('kpiHolding').innerText = holding.toFixed(6);
    const avg = holding > 0 ? cost/holding : 0;
    el('kpiAvg').innerText = avg.toFixed(2);

    // 盈亏
    if(mp > 0 && holding > 0){
      const marketVal = holding * mp;
      const profit = marketVal - cost;
      const pct = (profit / cost) * 100;
      const cls = profit >= 0 ? 'green' : 'red';
      el('kpiProfit').innerHTML = `<span class="${cls}">RM ${profit >= 0 ? '+':''}${profit.toFixed(2)}</span>`;
      el('kpiRoi').innerHTML = `<span class="${cls}">${pct.toFixed(2)}%</span>`;
    }

    // 列表 (取最新的5条)
    const list = el('txList');
    list.innerHTML = "";
    [...txs].reverse().slice(0, 5).forEach(t => {
      const isBuy = t.type === 'buy';
      list.innerHTML += `
        <div class="tx-item">
          <div>
            <span class="tag ${t.type}">${isBuy?'买':'卖'}</span>
            <span style="font-size:13px; font-weight:600">${t.date}</span>
          </div>
          <div style="text-align:right">
            <div style="font-size:13px; font-weight:700">RM ${t.amount}</div>
            <div style="font-size:11px; color:var(--sub)">${parseFloat(t.grams).toFixed(4)}g</div>
          </div>
        </div>
      `;
    });
    if(txs.length === 0) list.innerHTML = "<div style='text-align:center; padding:20px; color:var(--sub); font-size:12px'>暂无记录</div>";
  }

  // --- 图表渲染 (SVG) ---
  function renderChart(){
    const hist = loadHist();
    const box = el('chartBox');
    box.innerHTML = '<div class="tooltip" id="tooltip"></div><defs><linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="var(--primary)" stop-opacity="0.2"/><stop offset="100%" stop-color="var(--primary)" stop-opacity="0"/></linearGradient></defs>';

    if(hist.length < 1){
      el('chartTotalVal').innerText = "暂无数据";
      return;
    }
    
    // 显示最新市值
    const last = hist[hist.length-1];
    el('chartTotalVal').innerText = "RM " + last.val.toFixed(2);
    if(hist.length < 2) return; // 至少两个点才画线

    // 坐标计算
    const vals = hist.map(h => h.val);
    const min = Math.min(...vals) * 0.99;
    const max = Math.max(...vals) * 1.01;
    const range = max - min || 1;
    const w = box.offsetWidth;
    const h = box.offsetHeight;
    const pad = 10;

    const points = hist.map((d, i) => ({
      x: pad + (i / (hist.length - 1)) * (w - pad*2),
      y: h - pad - ((d.val - min) / range) * (h - pad*2),
      val: d.val, date: d.date
    }));

    // 绘制 Path
    let dLine = `M ${points[0].x} ${points[0].y}`;
    points.forEach(p => dLine += ` L ${p.x} ${p.y}`);
    
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    box.appendChild(svg); // 先append再操作，虽然此处无所谓，但习惯好

    // 区域填充
    const dArea = dLine + ` L ${points[points.length-1].x} ${h} L ${points[0].x} ${h} Z`;
    const areaPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
    areaPath.setAttribute("d", dArea);
    areaPath.setAttribute("class", "chart-area");
    svg.appendChild(areaPath);

    // 线条
    const linePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
    linePath.setAttribute("d", dLine);
    linePath.setAttribute("class", "chart-line");
    svg.appendChild(linePath);

    // 交互点
    points.forEach(p => {
      const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      c.setAttribute("cx", p.x); c.setAttribute("cy", p.y); c.setAttribute("r", 5);
      c.setAttribute("class", "chart-dot");
      c.onclick = () => {
        const t = el('tooltip');
        t.innerHTML = `${p.date}<br>RM ${p.val.toFixed(2)}`;
        t.style.left = p.x + 'px'; t.style.top = (p.y - 10) + 'px';
        t.style.opacity = 1;
        setTimeout(()=>t.style.opacity=0, 2000);
      };
      svg.appendChild(c);
    });
  }

  function renderHistoryList(){
    const hist = loadHist().reverse();
    const div = el('historyList');
    div.innerHTML = "";
    hist.forEach(h => {
      div.innerHTML += `
        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--line)">
          <span style="color:var(--sub)">${h.date}</span>
          <span style="font-weight:600">RM ${h.val.toFixed(2)}</span>
        </div>
      `;
    });
  }

  // --- 交易逻辑 ---
  function openModal(){ el('modal').classList.add('show'); }
  function closeModal(){ el('modal').classList.remove('show'); }
  function calc(){
    const a = parseFloat(el('amount').value), p = parseFloat(el('price').value);
    if(a && p) el('grams').value = (a/p).toFixed(6);
  }
  function saveTx(){
    const type = el('type').value;
    const date = el('date').value;
    const amount = el('amount').value;
    const grams = el('grams').value;
    const price = el('price').value;
    const note = el('note').value;
    if(!amount || !grams){ alert("数据不完整"); return; }
    
    const txs = loadTx();
    txs.push({ id: Date.now(), type, date, amount, grams, price, note });
    localStorage.setItem(LS_TX, JSON.stringify(txs));
    
    // 更新历史
    const mp = parseFloat(el('marketPrice').value);
    if(mp) recordHistory(mp);

    closeModal();
    el('amount').value = ""; el('grams').value = ""; el('price').value = ""; el('note').value = "";
    renderHome();
  }

  function clearHistory(){
    if(confirm("确定清空图表历史？交易记录不会被删除。")){
      localStorage.removeItem(LS_HIST);
      renderChart();
      renderHistoryList();
    }
  }

  init();
</script>
</body>
</html>
