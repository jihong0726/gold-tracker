<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TNG é»„é‡‘ç®¡å®¶ V26</title>
  <style>
    :root{
      --primary: #007aff; 
      --cost-color: #ff9f0a;
      --text: #1c1c1e; --sub: #8e8e93;
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-border: 1px solid rgba(255, 255, 255, 0.6);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      --blur: blur(25px);
      --nav-h: 65px; --safe-pb: env(safe-area-inset-bottom);
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --text: #f2f2f7; --sub: #98989d;
        --glass-bg: rgba(30, 30, 30, 0.7);
        --glass-border: 1px solid rgba(255, 255, 255, 0.12);
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; 
      background: radial-gradient(circle at 0% 0%, #e3f2fd 0%, #f3e5f5 50%, #fffde7 100%);
      background-attachment: fixed; color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
      padding-bottom: calc(var(--nav-h) + 20px + var(--safe-pb));
      user-select: none; -webkit-font-smoothing: antialiased;
    }
    @media (prefers-color-scheme: dark) {
      body { background: radial-gradient(circle at 0% 0%, #0f2027 0%, #203a43 50%, #2c5364 100%); }
    }

    .view { display: none; padding: 20px; padding-top: 60px; animation: fadeIn 0.4s ease; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

    /* æ°´æ™¶å¡ç‰‡ */
    .glass-card {
      background: var(--glass-bg); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      border-radius: 24px; border: var(--glass-border); box-shadow: var(--glass-shadow);
      padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden;
    }

    /* é¡¶éƒ¨å¯¼èˆª */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px; z-index: 90;
      background: rgba(255,255,255,0.01); backdrop-filter: blur(10px);
      display: flex; justify-content: space-between; align-items: flex-end; padding: 0 24px 12px;
    }
    .app-title { font-size: 22px; font-weight: 700; opacity: 0.9; }

    /* æ ¸å¿ƒèµ„äº§å¡ç‰‡ */
    .hero-card {
      text-align: center; padding: 40px 20px;
      background: linear-gradient(145deg, rgba(0,122,255,0.85), rgba(90,200,250,0.85));
      border: 1px solid rgba(255,255,255,0.3); color: white; box-shadow: 0 15px 35px rgba(0,122,255,0.3);
    }
    .hero-label { font-size: 13px; opacity: 0.9; font-weight: 500; margin-bottom: 8px; }
    .hero-val { font-size: 46px; font-weight: 800; letter-spacing: -1.5px; }
    .hero-pill { 
      font-size: 13px; background: rgba(255,255,255,0.25); padding: 6px 16px; 
      border-radius: 99px; display: inline-flex; align-items: center; gap: 6px; 
      backdrop-filter: blur(10px); margin-top: 12px; font-weight: 600;
    }

    /* è¾“å…¥æ¡ */
    .input-row {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--glass-bg); padding: 4px 6px 4px 20px; border-radius: 20px;
      box-shadow: var(--glass-shadow); border: var(--glass-border); margin-bottom: 20px;
    }
    .input-row input {
      border: none; background: transparent; text-align: right; 
      font-size: 20px; font-weight: 700; color: var(--primary); width: 120px; outline: none; margin-right: 10px;
    }
    .save-btn {
      width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 16px;
      display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border: none;
    }

    /* æ•°æ®ç½‘æ ¼ */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .stat-item { padding: 20px; display: flex; flex-direction: column; justify-content: center; }
    .stat-label { font-size: 12px; color: var(--sub); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }
    .stat-val { font-size: 19px; font-weight: 700; letter-spacing: -0.5px; } /* å­—ä½“ç¨å¾®è°ƒå°é€‚é…é•¿æ•°å­— */

    /* åˆ—è¡¨é¡¹ */
    .list-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 0; border-bottom: 0.5px solid rgba(150,150,150,0.15);
    }
    .list-row:last-child { border-bottom: none; }
    .row-l { display: flex; flex-direction: column; gap: 4px; }
    .row-r { text-align: right; display: flex; flex-direction: column; gap: 4px; }
    .tag { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 700; margin-right: 8px; }
    .buy { background: rgba(52,199,89,0.15); color: #32ae50; }
    .sell { background: rgba(255,59,48,0.15); color: #ff3b30; }

    /* å›¾è¡¨ç¼©æ”¾å®¹å™¨ */
    .chart-scroll-wrapper {
      overflow-x: auto; -webkit-overflow-scrolling: touch; /* å…è®¸æ¨ªå‘æ»šåŠ¨ */
      padding-bottom: 10px;
    }
    .chart-box { height: 280px; position: relative; margin-top: 10px; width: 100%; transition: width 0.2s; }
    svg { width: 100%; height: 100%; overflow: visible; }
    
    .line-val { fill: none; stroke: var(--primary); stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 4px 8px rgba(0,122,255,0.25)); }
    .line-cost { fill: none; stroke: var(--cost-color); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; } 
    .dot { fill: #fff; stroke: var(--primary); stroke-width: 3; cursor: pointer; transition: r 0.2s; }
    .val-label { font-size: 11px; font-weight: 800; fill: var(--primary); text-anchor: middle; opacity: 1; }
    .axis-label { font-size: 10px; fill: var(--sub); font-weight: 500; }
    .grid-line { stroke: var(--text); stroke-opacity: 0.05; stroke-width: 1; stroke-dasharray: 4,4; }

    /* ç¼©æ”¾æ§åˆ¶å™¨ */
    .zoom-ctrl { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.03); padding: 8px 12px; border-radius: 12px; }
    .zoom-label { font-size: 11px; color: var(--sub); font-weight: 600; white-space: nowrap; }
    input[type=range] { width: 100%; accent-color: var(--primary); }

    /* åº•éƒ¨å¯¼èˆª Dock */
    .dock {
      position: fixed; bottom: calc(20px + var(--safe-pb)); left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 320px; height: 70px;
      background: rgba(255,255,255,0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
      border-radius: 35px; display: flex; justify-content: space-around; align-items: center;
      box-shadow: 0 15px 40px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.5); z-index: 100;
    }
    @media (prefers-color-scheme: dark) { .dock { background: rgba(30,30,30,0.85); border: 1px solid rgba(255,255,255,0.1); } }
    .dock-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 50px; height: 50px; color: var(--sub); border-radius: 50%; transition: 0.3s; position: relative; }
    .dock-btn.active { color: var(--primary); transform: translateY(-5px); }
    .dock-btn svg { width: 28px; height: 28px; fill: currentColor; }

    /* FAB */
    .fab {
      position: fixed; bottom: calc(110px + var(--safe-pb)); right: 24px;
      width: 60px; height: 60px; background: var(--primary); border-radius: 50%;
      color: white; display: flex; justify-content: center; align-items: center;
      box-shadow: 0 10px 25px rgba(0,122,255,0.4); z-index: 90; 
    }

    /* Modals & Forms */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
    .modal-card { width: 85%; max-width: 360px; background: var(--glass-bg); backdrop-filter: blur(40px); border-radius: 32px; padding: 28px; box-shadow: 0 25px 60px rgba(0,0,0,0.25); border: var(--glass-border); transform: scale(0.95); transition: 0.3s; }
    .modal-overlay.show .modal-card { transform: scale(1); }
    
    input.form-input { width: 100%; padding: 16px; background: rgba(120,120,128,0.08); border: none; border-radius: 16px; font-size: 18px; color: var(--text); outline: none; margin-bottom: 12px; font-weight: 600; }
    .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 700; margin-top: 10px; }
    
    /* å†å²åˆ—è¡¨ */
    .hist-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 0.5px solid rgba(150,150,150,0.15); }
    .hist-date { font-weight: 600; font-size: 16px; color: var(--text); }
    .hist-val { font-weight: 700; font-size: 16px; color: var(--primary); }
    .hist-detail { font-size: 11px; color: var(--sub); display: flex; gap: 8px; margin-top: 4px; }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="app-title">TNG é»„é‡‘ç®¡å®¶</div>
  <div style="font-size:20px; opacity:0.6; cursor:pointer" onclick="openSettings()">âš™ï¸</div>
</div>

<div id="view-home" class="view active">
  <div class="glass-card hero-card">
    <div class="hero-label">å½“å‰æŒä»“æ€»å€¼ (RM)</div>
    <div class="hero-val" id="kpiVal">0.00</div>
    <div class="hero-pill" id="kpiProfit">ç›ˆäº: ---</div>
  </div>

  <div class="input-row">
    <div style="display:flex; align-items:center; gap:8px">
      <div style="width:4px; height:16px; background:var(--primary); border-radius:2px"></div>
      <div style="font-weight:600; font-size:16px">ä»Šæ—¥é‡‘ä»·</div>
    </div>
    <div style="display:flex; align-items:center">
      <input type="number" id="marketPrice" placeholder="0.00" inputmode="decimal" step="any">
      <button class="save-btn" onclick="saveAndChart()">â”</button>
    </div>
  </div>

  <div class="grid-2">
    <div class="glass-card stat-item">
      <div class="stat-label">æŒæœ‰å…‹æ•°</div>
      <div class="stat-val" id="kpiHolding">0.000000 <span style="font-size:14px;font-weight:500">g</span></div>
    </div>
    <div class="glass-card stat-item">
      <div class="stat-label">å¹³å‡æˆæœ¬</div>
      <div class="stat-val" id="kpiAvg">RM 0.00 <span style="font-size:14px;font-weight:500">/g</span></div>
    </div>
  </div>

  <div class="glass-card">
    <div style="font-weight:700; margin-bottom:16px; color:var(--text); font-size:15px">æœ€è¿‘äº¤æ˜“</div>
    <div id="txList"></div>
  </div>
</div>

<div id="view-chart" class="view">
  
  <div class="glass-card">
    <div style="font-weight:700; font-size:15px; margin-bottom:12px; display:flex; align-items:center; gap:8px">
      <span style="font-size:18px">ğŸ¯</span> ç›®æ ‡å–å‡ºè®¡ç®—å™¨
    </div>
    <div style="font-size:13px; color:var(--sub); margin-bottom:12px">è¾“å…¥æ‚¨çš„ç›®æ ‡åˆ©æ¶¦ (RM)ï¼Œè®¡ç®—æŒ‚å•ä»·æ ¼</div>
    <input type="number" id="calcInput" class="form-input" placeholder="æƒ³èµšå¤šå°‘ RM ?" inputmode="decimal" oninput="calcTarget()">
    <div style="background:rgba(0,122,255,0.08); padding:16px; border-radius:16px; text-align:center">
      <div style="font-size:12px; color:var(--primary); opacity:0.8; margin-bottom:4px">å»ºè®®å–å‡ºå•ä»· (RM/g)</div>
      <div style="font-size:28px; font-weight:800; color:var(--primary)" id="calcResult">0.00</div>
    </div>
  </div>

  <div class="glass-card" id="chartCard">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
      <div style="font-weight:700; font-size:16px">èµ„äº§èµ°åŠ¿</div>
      <button style="font-size:12px; color:var(--primary); background:rgba(0,122,255,0.1); border:none; padding:6px 12px; border-radius:12px; font-weight:600" onclick="openHistModal()">+ è¡¥å½•</button>
    </div>
    
    <div class="zoom-ctrl">
      <div class="zoom-label">ğŸ” ç¼©æ”¾</div>
      <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1" oninput="updateZoom()">
    </div>

    <div class="chart-scroll-wrapper">
      <div class="chart-box" id="trendChart"></div>
    </div>
  </div>

  <div class="glass-card">
    <div style="font-weight:700; font-size:15px; margin-bottom:12px; color:var(--text)">å†å²å›æº¯è¯¦æƒ…</div>
    <div id="histList"></div>
  </div>
</div>

<div class="dock">
  <div class="dock-btn active" id="nav-home" onclick="switchTab('home')">
    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
  </div>
  <div class="dock-btn" id="nav-chart" onclick="switchTab('chart')">
    <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
  </div>
</div>

<div class="fab" id="fabBtn" onclick="openTxModal()">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
</div>

<div class="modal-overlay" id="txModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:24px">è®°ä¸€ç¬”äº¤æ˜“</h3>
    <input type="date" class="form-input" id="tDate">
    <input type="number" class="form-input" id="tAmt" placeholder="æ€»é‡‘é¢ (RM)" inputmode="decimal" step="any" oninput="calcG()">
    <div style="display:flex; gap:12px">
      <input type="number" class="form-input" id="tPrice" placeholder="å•ä»· (RM/g)" inputmode="decimal" step="any" oninput="calcG()">
      <input type="number" class="form-input" id="tGrams" placeholder="å…‹æ•° (g)" disabled>
    </div>
    <button class="btn-main" onclick="saveTx()">ä¿å­˜è®°å½•</button>
    <div style="text-align:center; margin-top:16px; color:#ff3b30; font-size:14px; display:none" id="btnDelTx" onclick="delTx()">åˆ é™¤</div>
    <div style="text-align:center; margin-top:16px; color:var(--sub); font-size:14px" onclick="closeModal('txModal')">å–æ¶ˆ</div>
  </div>
</div>

<div class="modal-overlay" id="histModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:24px">è¡¥å½•å†å²èµ„äº§</h3>
    <input type="date" class="form-input" id="hDate">
    <input type="number" class="form-input" id="hTotalVal" placeholder="å½“æ—¥èµ„äº§æ€»å€¼ (RM)" inputmode="decimal" step="any">
    <button class="btn-main" onclick="saveHist()">ä¿å­˜</button>
    <div style="text-align:center; margin-top:16px; color:#ff3b30; font-size:14px; display:none" id="btnDelHist" onclick="delHist()">åˆ é™¤</div>
    <div style="text-align:center; margin-top:16px; color:var(--sub); font-size:14px" onclick="closeModal('histModal')">å–æ¶ˆ</div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-card">
    <h3 style="text-align:center; margin-bottom:20px">æ•°æ®ç®¡ç†</h3>
    <div style="display:flex; flex-direction:column; gap:10px">
      <button class="form-input" style="text-align:left; background:white" onclick="exportData()">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
      <div style="position:relative">
        <button class="form-input" style="text-align:left; background:white">ğŸ“¥ æ¢å¤å¤‡ä»½</button>
        <input type="file" onchange="importData(this)" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0">
      </div>
      <button class="form-input" style="text-align:left; color:#ff3b30; background:white" onclick="resetAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    </div>
    <button class="btn-main" onclick="closeModal('settingsModal')">å…³é—­</button>
  </div>
</div>

<script>
  // æ•°æ®åˆå§‹åŒ–
  const PRELOAD_TX = [{"ts":1769197202982,"type":"buy","date":"2025-05-18","amount":10,"grams":0.022438,"price":445.669382},{"ts":1769197251472,"type":"buy","date":"2025-12-25","amount":10,"grams":0.016995,"price":588.417299},{"ts":1769197276233,"type":"buy","date":"2025-12-31","amount":10,"grams":0.017494,"price":571.610734},{"ts":1769197303771,"type":"buy","date":"2026-01-21","amount":500,"grams":0.796725,"price":627.568989},{"ts":1769197324261,"type":"buy","date":"2026-01-23","amount":1000,"grams":1.553877,"price":643.551401}];
  const PRELOAD_HIST = [{"date":"2026-01-22","val":558.05},{"date":"2026-01-23","val":1547.97},{"date":"2026-01-24","val":1559.44},{"date":"2026-01-25","val":1558.89}];
  const KEY = { TX: 'tng_tx_v26', HS: 'tng_hs_v26', MK: 'tng_mk_v26' };
  const el = id => document.getElementById(id);
  
  let editId = null, editHistDate = null, txType = 'buy';
  let chartVis = { val: true, cost: true };
  let currentZoom = 1.0;

  function init(){
    if(!localStorage.getItem(KEY.TX)) localStorage.setItem(KEY.TX, JSON.stringify(PRELOAD_TX));
    if(!localStorage.getItem(KEY.HS)) localStorage.setItem(KEY.HS, JSON.stringify(PRELOAD_HIST));
    el('tDate').value = new Date().toISOString().split('T')[0];
    const savedP = localStorage.getItem(KEY.MK);
    if(savedP) el('marketPrice').value = savedP;
    render();
  }

  function getDB(){ return { tx: JSON.parse(localStorage.getItem(KEY.TX)||'[]'), hs: JSON.parse(localStorage.getItem(KEY.HS)||'[]') }; }
  
  function getHoldingAt(dateStr = null){
    const tx = getDB().tx.sort((a,b)=>a.date>b.date?1:-1);
    let h = 0, totalCost = 0;
    for(let t of tx){
      if(dateStr && t.date > dateStr) break;
      const g = Number(t.grams), a = Number(t.amount);
      if(t.type === 'buy'){ h += g; totalCost += a; }
      else { 
        if(h > 0){ const avg = totalCost / h; totalCost -= (g * avg); }
        h -= g; 
      }
    }
    if(h < 0.000001) { h = 0; totalCost = 0; }
    return { h, c: totalCost };
  }

  function render(){
    const {h, c} = getHoldingAt();
    const mp = parseFloat(el('marketPrice').value)||0;

    // 6-decimal precision
    el('kpiHolding').innerHTML = h.toFixed(6) + ' <span style="font-size:14px;font-weight:500">g</span>';
    
    // Explicit RM format
    const avg = h > 0 ? (c / h) : 0;
    el('kpiAvg').innerHTML = `RM ${avg.toFixed(2)} <span style="font-size:14px;font-weight:500">/g</span>`;
    
    if(mp && h){
      const val = h * mp;
      const profit = val - c;
      const pct = c > 0 ? (profit / c) * 100 : 0;
      const color = profit >= 0 ? '#ffffff' : '#ffcccc';
      const sign = profit >= 0 ? '+' : '';
      el('kpiVal').innerText = val.toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2});
      el('kpiProfit').innerHTML = `ç›ˆäº <strong style="color:${color}; margin-left:4px">RM ${sign}${profit.toFixed(2)} (${pct.toFixed(2)}%)</strong>`;
    } else {
      el('kpiVal').innerText = '0.00';
      el('kpiProfit').innerText = 'ç›ˆäº: ---';
    }

    // List: 6-decimal for grams
    const list = el('txList'); list.innerHTML = '';
    getDB().tx.sort((a,b)=>b.ts - a.ts).slice(0, 10).forEach(t => {
      list.innerHTML += `<div class="list-row" onclick="editT(${t.ts})">
          <div class="row-l"><div style="font-weight:600;font-size:16px;color:var(--text)"><span class="tag ${t.type}">${t.type==='buy'?'ä¹°':'å–'}</span>RM ${Number(t.amount).toFixed(2)}</div><div style="font-size:12px;color:var(--sub)">${t.date}</div></div>
          <div class="row-r"><div style="font-weight:700;font-size:15px;color:var(--text)">${Number(t.grams).toFixed(6)} g</div><div style="font-size:12px;color:var(--sub)">@ ${Number(t.price).toFixed(2)}</div></div></div>`;
    });

    // History
    const hList = el('histList'); hList.innerHTML = '';
    getDB().hs.sort((a,b)=>b.date > a.date ? 1 : -1).forEach(h => {
      const stats = getHoldingAt(h.date);
      const impliedPrice = stats.h > 0 ? (h.val / stats.h) : 0;
      hList.innerHTML += `<div class="hist-item" onclick="editHist('${h.date}', ${h.val})"><div><div class="hist-date">${h.date}</div><div class="hist-detail"><span>æŒä»“ ${stats.h.toFixed(6)}g</span><span>çº¦ ${impliedPrice.toFixed(2)}/g</span></div></div><div class="hist-val">RM ${Number(h.val).toFixed(2)}</div></div>`;
    });
    
    calcTarget();
  }

  // --- Zoom Logic ---
  function updateZoom(){
    currentZoom = parseFloat(el('zoomSlider').value);
    el('trendChart').style.width = (currentZoom * 100) + '%';
    drawChart();
  }

  function drawChart(){
    const {hs} = getDB();
    const box = el('trendChart'); box.innerHTML = '';
    if(hs.length < 2) { box.innerHTML = '<div style="text-align:center;padding-top:120px;font-size:12px;color:var(--sub)">æš‚æ— è¶³å¤Ÿæ•°æ®</div>'; return; }
    
    const data = hs.sort((a,b) => a.date > b.date ? 1 : -1).map(h => {
      const stats = getHoldingAt(h.date);
      return { date: h.date, val: h.val, cost: stats.c };
    });

    const allVals = data.map(d => d.val).concat(data.map(d => d.cost));
    const min = Math.min(...allVals) * 0.98;
    const max = Math.max(...allVals) * 1.02;
    const range = max - min || 1;
    
    // Width based on Zoom
    const w = box.offsetWidth; 
    const h = 280;
    
    const pts = data.map((d, i) => ({
      x: (i / (data.length - 1)) * w,
      yVal: h - 30 - ((d.val - min) / range) * (h - 60),
      yCost: h - 30 - ((d.cost - min) / range) * (h - 60),
      d: d
    }));

    let pVal = `M ${pts[0].x} ${pts[0].yVal}`, pCost = `M ${pts[0].x} ${pts[0].yCost}`;
    pts.forEach(p => { pVal += ` L ${p.x} ${p.yVal}`; pCost += ` L ${p.x} ${p.yCost}`; });

    let grid = '';
    for(let i=0; i<=4; i++){ let y = h - 30 - (i/4)*(h - 60); grid += `<line x1="0" y1="${y}" x2="${w}" y2="${y}" class="grid-line" />`; }

    // Dynamic Labels (Reduce clutter if zoomed out, show all if zoomed in)
    let labelStep = currentZoom > 2 ? 1 : Math.ceil(data.length / 5);
    let labels = pts.filter((_,i) => i % labelStep === 0 || i === pts.length-1).map(p => 
      `<text x="${p.x}" y="${h - 5}" class="axis-label" style="text-anchor:middle">${p.d.date.slice(5)}</text>`
    ).join('');

    let svg = `<svg style="min-width:100%">${grid}`;
    if(chartVis.cost) svg += `<path d="${pCost}" class="line-cost"/>`;
    if(chartVis.val) {
      svg += `<path d="${pVal}" class="line-val"/>`;
      svg += pts.map(p => 
        `<text x="${p.x}" y="${p.yVal - 15}" class="val-label">${p.d.val.toFixed(0)}</text>` +
        `<circle cx="${p.x}" cy="${p.yVal}" r="5" class="dot" onclick="alert('${p.d.date} å¸‚å€¼: ${p.d.val}')"/>`
      ).join('');
    }
    svg += `${labels}</svg>`;
    box.innerHTML = svg;
  }

  // --- Logic ---
  function saveAndChart(){
    const p = parseFloat(el('marketPrice').value);
    if(!p || p <= 0){ alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘ä»·"); return; }
    localStorage.setItem(KEY.MK, p);
    const {h} = getHoldingAt();
    if(h > 0) {
      const today = new Date().toISOString().split('T')[0];
      let hs = getDB().hs;
      const idx = hs.findIndex(x => x.date === today);
      const val = h * p;
      if(idx > -1) hs[idx].val = val; else hs.push({date: today, val: val});
      localStorage.setItem(KEY.HS, JSON.stringify(hs));
    }
    render(); switchTab('chart');
  }

  function calcTarget(){
    const input = parseFloat(el('calcInput').value);
    const {h, c} = getHoldingAt();
    if(!input || h<=0) { el('calcResult').innerText = "0.00"; return; }
    const targetPrice = (c + input) / h;
    el('calcResult').innerText = targetPrice.toFixed(2);
  }

  function saveTx(){
    const d=el('tDate').value, a=el('tAmt').value, p=el('tPrice').value, g=el('tGrams').value;
    if(!a || !g) return alert("è¯·å¡«å†™å®Œæ•´");
    let tx = getDB().tx;
    const rec = { ts: editId || Date.now(), type: 'buy', date: d, amount: a, grams: g, price: p };
    if(editId){ const i = tx.findIndex(x=>x.ts == editId); if(i>-1) tx[i]=rec; } else tx.push(rec);
    localStorage.setItem(KEY.TX, JSON.stringify(tx));
    closeModal('txModal'); render();
  }
  function saveHist(){
    const d=el('hDate').value, v=parseFloat(el('hTotalVal').value);
    if(!v) return alert("è¯·è¾“å…¥é‡‘é¢");
    let hs = getDB().hs;
    const i = hs.findIndex(x => x.date == d);
    if(i > -1) hs[i].val = v; else hs.push({date: d, val: v});
    localStorage.setItem(KEY.HS, JSON.stringify(hs));
    closeModal('histModal'); render(); drawChart();
  }
  
  function delTx(){ if(confirm("åˆ é™¤?")){ localStorage.setItem(KEY.TX, JSON.stringify(getDB().tx.filter(x=>x.ts!=editId))); closeModal('txModal'); render(); } }
  function delHist(){ if(confirm("åˆ é™¤?")){ localStorage.setItem(KEY.HS, JSON.stringify(getDB().hs.filter(x=>x.date!=editHistDate))); closeModal('histModal'); render(); drawChart(); } }
  function calcG(){ const a = parseFloat(el('tAmt').value), p = parseFloat(el('tPrice').value); if(a && p) el('tGrams').value = (a/p).toFixed(6); }
  
  function openModal(id){ el(id).classList.add('show'); }
  function closeModal(id){ el(id).classList.remove('show'); }
  function openTxModal(){ editId = null; el('tAmt').value=''; el('tPrice').value=''; el('tGrams').value=''; el('btnDelTx').style.display='none'; openModal('txModal'); }
  function editT(ts){ const t = getDB().tx.find(x => x.ts == ts); if(!t) return; editId = ts; el('tDate').value = t.date; el('tAmt').value = t.amount; el('tPrice').value = t.price; el('tGrams').value = t.grams; el('btnDelTx').style.display='block'; openModal('txModal'); }
  function openHistModal(){ editHistDate = null; el('hDate').value = new Date().toISOString().split('T')[0]; el('hTotalVal').value = ''; el('btnDelHist').style.display = 'none'; openModal('histModal'); }
  function editHist(date, val){ editHistDate = date; el('hDate').value = date; el('hTotalVal').value = val; el('btnDelHist').style.display = 'block'; openModal('histModal'); }
  function openSettings(){ openModal('settingsModal'); }
  
  function switchTab(t){ document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); el('view-'+t).classList.add('active'); el('nav-home').className = t==='home' ? 'dock-btn active' : 'dock-btn'; el('nav-chart').className = t==='chart' ? 'dock-btn active' : 'dock-btn'; el('fabBtn').style.display = t==='home' ? 'flex' : 'none'; if(t === 'chart') drawChart(); }
  function exportData(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(getDB())],{type:'application/json'})); a.download='backup.json'; a.click(); }
  function importData(i){ const r=new FileReader(); r.onload=e=>{ try{const d=JSON.parse(e.target.result); if(d.tx)localStorage.setItem(KEY.TX,JSON.stringify(d.tx)); if(d.hs)localStorage.setItem(KEY.HS,JSON.stringify(d.hs)); location.reload();}catch{alert('Error');} }; r.readAsText(i.files[0]); }
  function resetAll(){ if(confirm('æ¸…ç©º?')){ localStorage.clear(); location.reload(); } }

  init();
</script>
</body>
</html>
