<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TNG é»„é‡‘ç®¡å®¶ V79</title>
  <style>
    /* --- åŸºç¡€å˜é‡ --- */
    :root{
      --primary: #007aff; 
      --cost-color: #8e8e93; 
      --text: #1c1c1e; --sub: #8e8e93;
      --glass-bg: #ffffff; 
      --glass-border: 1px solid rgba(0,0,0,0.05);
      --glass-shadow: 0 8px 20px rgba(0,0,0,0.08);
      --nav-h: 65px; --safe-pb: env(safe-area-inset-bottom);
      --green: #34c759; --red: #ff3b30;
      --bg-color: #f5f5f7;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --text: #f2f2f7; --sub: #98989d;
        --glass-bg: #1c1c1e;
        --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        --bg-color: #000;
        --cost-color: #636366;
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; background: var(--bg-color); color: var(--text);
      font-family: -apple-system, "SF Pro Display", sans-serif;
      height: 100vh; display: flex; flex-direction: column; 
      overflow: hidden;
    }

    /* --- å¸ƒå±€ --- */
    .top-bar { 
      flex: 0 0 60px; z-index: 90; 
      background: var(--glass-bg); border-bottom: var(--glass-border); 
      display: flex; justify-content: space-between; align-items: flex-end; 
      padding: 0 24px 12px;
    }
    .app-title { font-size: 20px; font-weight: 700; }
    .icon-btn-top { font-size: 20px; padding: 4px 8px; opacity: 0.7; cursor: pointer; }

    .app-content { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
    .view { display: none; animation: fadeIn 0.3s; padding-bottom: 20px; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .dock { 
      flex: 0 0 calc(var(--nav-h) + var(--safe-pb));
      background: var(--glass-bg); border-top: var(--glass-border);
      display: grid; grid-template-columns: 1fr 1fr; 
      padding-bottom: var(--safe-pb); z-index: 100;
    }
    .dock-btn { 
      display: flex; flex-direction: column; align-items: center; justify-content: center; 
      height: 100%; color: var(--sub); transition: 0.2s; cursor: pointer;
    }
    .dock-btn.active { color: var(--primary); background: rgba(0,122,255,0.03); }
    .dock-btn svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 4px; }
    .dock-label { font-size: 11px; font-weight: 600; }

    /* --- ç»„ä»¶ --- */
    .glass-card {
      background: var(--glass-bg); border-radius: 24px; 
      border: var(--glass-border); box-shadow: var(--glass-shadow);
      padding: 24px; margin-bottom: 20px; position: relative; overflow: visible;
    }

    .hero-card {
      text-align: center; padding: 32px 20px;
      background: linear-gradient(135deg, #007aff, #0055ff);
      color: white; border: none; box-shadow: 0 8px 25px rgba(0,122,255,0.3);
    }
    .hero-label { font-size: 13px; opacity: 0.9; font-weight: 500; margin-bottom: 8px; }
    .hero-val { font-size: 42px; font-weight: 800; letter-spacing: -1px; margin: 4px 0 16px 0; }
    .hero-pill { font-size: 13px; background: rgba(255,255,255,0.9); padding: 6px 14px; border-radius: 20px; font-weight: 600; color: #333; }
    .eye-btn { font-size: 16px; cursor: pointer; opacity: 0.8; margin-left: 5px; }
    .blur-mode { filter: blur(8px); opacity: 0.5; }

    .input-wrapper { background: var(--glass-bg); padding: 20px; border-radius: 20px; box-shadow: var(--glass-shadow); margin-bottom: 20px; }
    .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .input-row input { border: none; background: transparent; text-align: right; font-size: 24px; font-weight: 700; color: var(--primary); width: 140px; outline: none; }
    .save-btn { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
    .implied-price { text-align: right; font-size: 12px; color: var(--sub); font-weight: 500; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .stat-item { padding: 20px; display: flex; flex-direction: column; justify-content: center; position: relative; }
    .stat-label { font-size: 12px; color: var(--sub); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }
    .stat-val { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .list-title { font-weight: 700; font-size: 15px; color: var(--text); }
    .list-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 0.5px solid rgba(0,0,0,0.05); cursor: pointer; }
    .row-l { display: flex; flex-direction: column; gap: 4px; }
    .row-r { text-align: right; display: flex; flex-direction: column; gap: 4px; }

    /* Chart V79 Fixed: Width Handling */
    .chart-head-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .chart-title { font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }
    .filter-tabs { display: flex; background: rgba(120,120,128,0.08); padding: 4px; border-radius: 10px; }
    .filter-btn { padding: 6px 12px; font-size: 12px; border-radius: 8px; border:none; background:transparent; color:var(--sub); font-weight:600; transition:0.2s; cursor:pointer; }
    .filter-btn.active { background: var(--glass-bg); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    
    /* V79 Fix: Removed 'width: 100%' to allow JS to set dynamic width */
    .chart-box { height: 320px; position: relative; cursor: crosshair; touch-action: pan-x; overflow: visible; }
    
    /* V79 Fix: Wrapper handles the scroll */
    .chart-scroll-wrapper { 
        overflow-x: auto; 
        padding-bottom: 10px; 
        -webkit-overflow-scrolling: touch; 
        width: 100%;
        /* Ensure flex logic doesn't shrink it */
        flex-shrink: 0; 
    }
    
    .area-cost { fill: var(--cost-color); opacity: 0.05; }
    .line-asset { fill: none; stroke: var(--primary); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
    .line-cost { fill: none; stroke: var(--cost-color); stroke-width: 1.5; stroke-dasharray: 6,4; opacity: 0.6; }
    .grid-line { stroke: var(--text); stroke-opacity: 0.05; stroke-width: 1; }
    .axis-label { font-size: 10px; fill: var(--sub); font-weight: 500; }
    .val-label { font-size: 9px; font-weight: 700; fill: var(--text); text-anchor: middle; opacity: 1; }
    
    /* Tooltip */
    .chart-tooltip {
      position: absolute; top: 10px; left: 0; pointer-events: none;
      background: rgba(255,255,255,0.95); border: 1px solid var(--glass-border);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12); border-radius: 16px; padding: 12px 16px;
      font-size: 12px; z-index: 200; opacity: 0; transition: opacity 0.1s;
      min-width: 160px; backdrop-filter: blur(12px);
    }
    @media (prefers-color-scheme: dark) { .chart-tooltip { background: rgba(30,30,32,0.95); border: 1px solid rgba(255,255,255,0.1); } }

    .chart-tooltip.show { opacity: 1; }
    .tt-date { font-weight: 700; color: var(--sub); margin-bottom: 6px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    .tt-row { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
    .tt-row:last-child { margin-bottom: 0; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 6px; }
    .tt-label { color: var(--sub); }
    .tt-val { font-weight: 700; color: var(--text); font-size: 13px; }
    
    .crosshair { stroke: var(--text); stroke-width: 1; stroke-dasharray: 4,4; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
    .crosshair.show { opacity: 0.5; }
    .active-dot { fill: var(--glass-bg); stroke: var(--primary); stroke-width: 3; r: 6; opacity: 0; transition: opacity 0.1s; pointer-events: none; }
    .active-dot.show { opacity: 1; }

    /* Summary Card */
    .chart-summary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px; }
    .cs-item { background: rgba(120,120,128,0.03); padding: 16px; border-radius: 16px; text-align: center; }
    .cs-label { font-size: 11px; color: var(--sub); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }
    .cs-val { font-size: 14px; font-weight: 800; white-space: nowrap; }

    /* Modals & Utils */
    .fab { position: fixed; bottom: calc(90px + var(--safe-pb)); right: 24px; width: 56px; height: 56px; background: var(--primary); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 25px rgba(0,122,255,0.4); z-index: 90; cursor: pointer; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-overlay.show { display: flex; }
    .modal-card { width: 85%; max-width: 320px; background: var(--glass-bg); border-radius: 24px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--sub); margin-bottom: 6px; }
    input.form-input { width: 100%; padding: 12px; background: rgba(120,120,128,0.08); border: none; border-radius: 12px; font-size: 16px; color: var(--text); outline: none; font-weight: 600; }
    .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="app-title">TNG é»„é‡‘ç®¡å®¶</div>
  <div><span class="icon-btn-top" onclick="openSettings()">âš™ï¸</span></div>
</div>

<div class="app-content">

  <div id="view-home" class="view active">
    <div class="glass-card hero-card">
      <div class="hero-label">å½“å‰æŒä»“æ€»å€¼ (RM) <span class="eye-btn" onclick="togglePrivacy()">ğŸ‘ï¸</span></div>
      <div class="hero-val" id="kpiVal">0.00</div>
      <div class="hero-pill" id="kpiProfit">ç›ˆäº: ---</div>
    </div>
    
    <div class="input-wrapper">
        <div class="input-row">
            <div style="display:flex;align-items:center;gap:8px;font-weight:700">å½“å‰æ€»å¸‚å€¼</div>
            <div style="display:flex;align-items:center;gap:10px">
                <input type="number" id="inputTotalVal" placeholder="0.00" inputmode="decimal" oninput="calcImpliedPrice()">
                <button class="save-btn" onclick="confirmSave()">â”</button>
            </div>
        </div>
        <div class="implied-price" id="impliedPriceLabel">è‡ªåŠ¨æ¢ç®—å•ä»·: -- /g</div>
    </div>

    <div class="grid-2">
      <div class="glass-card stat-item">
        <div class="stat-label">æŒæœ‰å…‹æ•°</div>
        <div class="stat-val"><span id="kpiHolding">0.0000</span> <span style="font-size:12px">g</span></div>
      </div>
      <div class="glass-card stat-item">
        <div class="stat-label">å¹³å‡æˆæœ¬</div>
        <div class="stat-val"><span id="kpiAvg">0.00</span> <span style="font-size:12px">/g</span></div>
      </div>
    </div>
    
    <div class="glass-card">
      <div class="list-header">
        <div class="list-title">æœ€è¿‘äº¤æ˜“</div>
        <div style="font-size:12px;color:var(--primary);cursor:pointer" onclick="openTxModal()">+ è®°ä¸€ç¬”</div>
      </div>
      <div id="txList"></div>
    </div>
  </div>

  <div id="view-chart" class="view">
    <div class="glass-card">
      <div class="chart-summary">
        <div class="cs-item"><div class="cs-label">æ€»æŠ•å…¥</div><div class="cs-val" id="chartTotalCost">--</div></div>
        <div class="cs-item"><div class="cs-label">å½“å‰å¸‚å€¼</div><div class="cs-val" style="color:var(--primary)" id="chartTotalVal">--</div></div>
        <div class="cs-item"><div class="cs-label">æ€»ç›ˆäº</div><div class="cs-val" id="chartTotalPL">--</div></div>
      </div>
      <div class="chart-head-row">
        <div class="chart-title">èµ„äº§èµ°åŠ¿</div>
        <div class="filter-tabs">
          <button class="filter-btn active" id="filter-1m" onclick="setChartFilter('1m')">1æœˆ</button>
          <button class="filter-btn" id="filter-3m" onclick="setChartFilter('3m')">3æœˆ</button>
          <button class="filter-btn" id="filter-all" onclick="setChartFilter('all')">å…¨</button>
          <button class="filter-btn" id="filter-fit" onclick="setChartFit()">å…¨è§ˆ</button>
        </div>
      </div>
      
      <div class="chart-scroll-wrapper" id="chartWrapper">
        <div class="chart-box" id="trendChart">
             <div id="chartTooltip" class="chart-tooltip"></div>
        </div>
      </div>
      
      <div style="display:flex;justify-content:center;gap:15px;margin-top:15px;font-size:11px;color:var(--sub)">
          <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:var(--green);border-radius:2px;opacity:0.6"></span>ç›ˆåˆ©</div>
          <div style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:var(--red);border-radius:2px;opacity:0.6"></span>äºæŸ</div>
          <div style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:var(--primary)"></span>å¸‚å€¼</div>
          <div style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:var(--cost-color);border-bottom:2px dashed var(--cost-color)"></span>æˆæœ¬</div>
      </div>
    </div>
    
    <div style="text-align:center">
        <button class="btn-main" style="width:auto;padding:10px 20px;font-size:14px;background:rgba(120,120,128,0.1);color:var(--text)" onclick="openHistModal()">+ è¡¥å½•å†å²å¸‚å€¼</button>
    </div>
    <div class="glass-card" style="margin-top:20px">
        <div class="list-title" style="margin-bottom:12px">æ•°æ®æ˜ç»†</div>
        <div id="histList"></div>
    </div>
  </div>

</div>

<div class="dock">
  <div class="dock-btn active" id="nav-home" onclick="switchTab('home')">
    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    <span class="dock-label">é¦–é¡µ</span>
  </div>
  <div class="dock-btn" id="nav-chart" onclick="switchTab('chart')">
    <svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
    <span class="dock-label">èµ°åŠ¿</span>
  </div>
</div>

<div class="modal-overlay" id="txModal">
  <div class="modal-card">
    <h3 style="text-align:center;margin-bottom:20px">ä¹°å…¥/å–å‡º</h3>
    <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-input" id="tDate"></div>
    <div class="form-group"><label class="form-label">æ€»é‡‘é¢ (RM)</label><input type="number" class="form-input" id="tAmt" placeholder="ä¾‹å¦‚: 10.00" oninput="calcG()"></div>
    <div style="display:flex;gap:10px">
        <div class="form-group" style="flex:1"><label class="form-label">ä¹°å…¥å•ä»·</label><input type="number" class="form-input" id="tPrice" oninput="calcG()"></div>
        <div class="form-group" style="flex:1"><label class="form-label">å…‹æ•°</label><input type="number" class="form-input" id="tGrams" disabled></div>
    </div>
    <button class="btn-main" onclick="saveTx()">ä¿å­˜è®°å½•</button>
    <div style="text-align:center;margin-top:15px;color:var(--sub);cursor:pointer" onclick="document.getElementById('txModal').classList.remove('show')">å–æ¶ˆ</div>
    <div id="btnDelTx" style="text-align:center;margin-top:10px;color:var(--red);cursor:pointer;display:none" onclick="delTx()">åˆ é™¤</div>
  </div>
</div>

<div class="modal-overlay" id="histModal">
  <div class="modal-card">
    <h3 style="text-align:center;margin-bottom:20px">è¡¥å½•å½“æ—¥æ€»å¸‚å€¼</h3>
    <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-input" id="hDate"></div>
    <div class="form-group"><label class="form-label">æ—¶é—´</label><input type="time" class="form-input" id="hTime"></div>
    <div class="form-group"><label class="form-label">æ€»å¸‚å€¼ (RM)</label><input type="number" class="form-input" id="hTotalVal" placeholder="æ³¨æ„ï¼šæ˜¯æ€»å€¼"></div>
    <button class="btn-main" onclick="saveHist()">ä¿å­˜</button>
    <div style="display:flex; justify-content:space-between; margin-top:15px; align-items:center">
        <div id="btnDelHist" style="color:var(--red);font-size:13px;cursor:pointer;display:none" onclick="delHist()">ğŸ—‘ï¸ åˆ é™¤</div>
        <div style="font-size:13px;color:var(--sub);cursor:pointer" onclick="document.getElementById('histModal').classList.remove('show')">å–æ¶ˆ</div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-card">
    <h3 style="text-align:center;margin-bottom:20px">æ•°æ®ç®¡ç†</h3>
    <div class="settings-list">
        <div class="settings-item" onclick="exportData()"><span>ğŸ“¤ å¤‡ä»½æ•°æ®</span></div>
        <div class="settings-item" style="position:relative"><span>ğŸ“¥ æ¢å¤æ•°æ®</span><input type="file" onchange="importData(this)" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0"></div>
        <div class="settings-item" onclick="resetAll()"><span style="color:var(--red)">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</span></div>
    </div>
    <button class="btn-main" style="background:#eee;color:#333;margin-top:20px" onclick="document.getElementById('settingsModal').classList.remove('show')">å…³é—­</button>
  </div>
</div>

<script>
  // Data V79 (22nd Deleted)
  const KEY = { TX: 'tng_tx_v79', HS: 'tng_hs_v79' };
  const PRELOAD_TX = [{"ts":1769197202982,"type":"buy","date":"2025-05-18","amount":10,"grams":0.022438,"price":445.669382},{"ts":1769197251472,"type":"buy","date":"2025-12-25","amount":10,"grams":0.016995,"price":588.417299},{"ts":1769197276233,"type":"buy","date":"2025-12-31","amount":10,"grams":0.017494,"price":571.610734},{"ts":1769197303771,"type":"buy","date":"2026-01-21","amount":500,"grams":0.796725,"price":627.568989},{"ts":1769197324261,"type":"buy","date":"2026-01-23","amount":1000,"grams":1.553877,"price":643.551401},{"ts":1769679188602,"type":"buy","date":"2025-04-23","amount":10,"grams":0.021294,"price":469.623106},{"ts":1769679209117,"type":"buy","date":"2025-05-10","amount":10,"grams":0.021391,"price":467.48292},{"ts":1770188908558,"type":"buy","date":"2026-01-31","amount":10,"grams":0.014681,"price":681.146353},{"ts":1770188927873,"type":"buy","date":"2026-01-30","amount":10,"grams":0.014713,"price":679.665226}];
  const PRELOAD_HIST = [{"ts":1770000000001,"date":"2026-01-23","time":"00:00","val":1547.97},{"ts":1770000000002,"date":"2026-01-24","time":"00:00","val":1559.44},{"ts":1770000000003,"date":"2026-01-25","time":"00:00","val":1558.89},{"ts":1769570138096,"date":"2026-01-26","time":"10:00","val":1580.48},{"ts":1769570149763,"date":"2026-01-27","time":"10:00","val":1571.57},{"ts":1769570157362,"date":"2026-01-28","time":"10:00","val":1597.82},{"ts":1769708569185,"date":"2026-01-29","time":"01:42","val":1648.48},{"ts":1769679309649,"date":"2026-01-29","time":"10:00","val":1623.05},{"ts":1769679322265,"date":"2026-01-29","time":"11:00","val":1627.36},{"ts":1769679331450,"date":"2026-01-29","time":"12:00","val":1708.71},{"ts":1769679360449,"date":"2026-01-29","time":"17:00","val":1696.79},{"ts":1769738400000,"date":"2026-01-30","time":"10:00","val":1648.48},{"ts":1769742000000,"date":"2026-01-30","time":"11:00","val":1647.24},{"ts":1769745600000,"date":"2026-01-30","time":"12:00","val":1615.23},{"ts":1769749200000,"date":"2026-01-30","time":"13:00","val":1567.28},{"ts":1769922467213,"date":"2026-01-31","time":"10:00","val":1499.76},{"ts":1769922479699,"date":"2026-02-01","time":"10:00","val":1537.53},{"ts":1770188969456,"date":"2026-02-03","time":"10:00","val":1523.45},{"ts":1770199200000,"date":"2026-02-04","time":"10:00","val":1551.36},{"ts":1770202800000,"date":"2026-02-04","time":"11:00","val":1578.0},{"ts":1770285600000,"date":"2026-02-05","time":"10:00","val":1528.71},{"ts":1770289200000,"date":"2026-02-05","time":"11:00","val":1515.3},{"ts":1770372000000,"date":"2026-02-06","time":"10:00","val":1519.28},{"ts":1770458400000,"date":"2026-02-07","time":"10:00","val":1548.65},{"ts":1770544800000,"date":"2026-02-08","time":"10:00","val":1548.65},{"ts":1770631200000,"date":"2026-02-09","time":"10:00","val":1563.72},{"ts":1770717600000,"date":"2026-02-10","time":"10:00","val":1564.98}];
  const el = id => document.getElementById(id);
  let editId=null, editHistId=null, chartFilter='1m', privacyMode=false, isFitMode=false;
  let chartData = []; 
  let chartStep = 0; // Store for interaction

  function init(){
    if(!localStorage.getItem(KEY.TX)) localStorage.setItem(KEY.TX, JSON.stringify(PRELOAD_TX));
    if(!localStorage.getItem(KEY.HS)) localStorage.setItem(KEY.HS, JSON.stringify(PRELOAD_HIST));
    el('tDate').value = new Date().toISOString().split('T')[0];
    el('hDate').value = new Date().toISOString().split('T')[0];
    el('hTime').value = "10:00";
    render();
    
    // Bind Chart Events
    const chartBox = el('trendChart');
    if(chartBox) {
        chartBox.addEventListener('touchstart', handleTouch, {passive: false}); 
        chartBox.addEventListener('touchmove', handleTouch, {passive: false});
        chartBox.addEventListener('touchend', hideTip);
        chartBox.addEventListener('mousemove', handleMouse);
        chartBox.addEventListener('mouseleave', hideTip);
    }
  }

  function getDB(){ return { tx: JSON.parse(localStorage.getItem(KEY.TX)||'[]'), hs: JSON.parse(localStorage.getItem(KEY.HS)||'[]') }; }
  
  function getHoldingAt(dateStr = null){
    const tx = getDB().tx.sort((a,b)=> a.date.localeCompare(b.date) || a.ts - b.ts);
    let h = 0, totalCost = 0;
    for(let t of tx){
      if(dateStr && t.date > dateStr) break;
      const g = Number(t.grams), a = Number(t.amount);
      if(t.type === 'buy'){ h += g; totalCost += a; }
      else { if(h > 0){ const avg = totalCost / h; totalCost -= (g * avg); } h -= g; }
    }
    return { h, c: totalCost };
  }

  function calcImpliedPrice(){
      const val = parseFloat(el('inputTotalVal').value);
      const {h} = getHoldingAt();
      if(val > 0 && h > 0){
          el('impliedPriceLabel').innerText = `è‡ªåŠ¨æ¢ç®—å•ä»·: RM ${(val/h).toFixed(2)} /g`;
      } else {
          el('impliedPriceLabel').innerText = `è‡ªåŠ¨æ¢ç®—å•ä»·: -- /g`;
      }
  }

  function render(previewOnly = false){
    const {h, c} = getHoldingAt();
    let currentVal = 0;
    const hs = getDB().hs;
    if(hs.length > 0) {
        const sorted = hs.sort((a,b)=>b.date.localeCompare(a.date) || b.time.localeCompare(a.time));
        currentVal = sorted[0].val;
    }
    
    const blurClass = privacyMode ? 'blur-mode' : '';
    el('kpiHolding').className = blurClass; el('kpiHolding').innerText = h.toFixed(4);
    el('kpiAvg').className = blurClass; el('kpiAvg').innerText = "RM " + (h>0?c/h:0).toFixed(2);
    el('kpiVal').className = "hero-val " + blurClass;

    const profit = currentVal - c;
    const pct = c>0 ? (profit/c)*100 : 0;
    const color = profit>=0 ? 'var(--green)' : 'var(--red)';
    
    if(!privacyMode) el('kpiVal').innerText = currentVal.toLocaleString('en-US',{minimumFractionDigits:2});
    el('kpiProfit').innerHTML = `ç›ˆäº <strong style="color:${color}">RM ${profit>=0?'+':''}${profit.toFixed(2)} (${pct.toFixed(2)}%)</strong>`;

    if(!previewOnly){
        const list = el('txList'); list.innerHTML = '';
        let txs = getDB().tx.sort((a,b)=>b.date.localeCompare(a.date));
        txs.forEach(t=>{
            list.innerHTML += `<div class="list-row" onclick="editT(${t.ts})">
                <div class="row-l"><div style="font-weight:600">${t.date}</div><div style="font-size:12px;color:var(--sub)">${t.type=='buy'?'ä¹°å…¥':'å–å‡º'}</div></div>
                <div class="row-r"><div style="font-weight:700">RM ${Number(t.amount).toFixed(2)}</div><div style="font-size:12px;color:var(--sub)">@${Number(t.price).toFixed(2)}</div></div>
            </div>`;
        });
        
        const hList = el('histList'); hList.innerHTML='';
        const sortedHs = getDB().hs.sort((a,b)=>b.date.localeCompare(a.date) || b.time.localeCompare(a.time));
        sortedHs.forEach(h=>{
            const s = getHoldingAt(h.date);
            const unit = s.h>0 ? h.val/s.h : 0;
            hList.innerHTML += `<div class="list-row" onclick="editHist(${h.ts})">
                <div class="row-l"><div style="font-weight:600">${h.date}</div><div style="font-size:12px;color:var(--sub)">${h.time}</div></div>
                <div class="row-r"><div style="font-weight:700">RM ${Number(h.val).toFixed(2)}</div><div style="font-size:12px;color:var(--sub)">~${unit.toFixed(2)}/g</div></div>
            </div>`;
        });
        updateChartSummary();
    }
  }

  function updateChartSummary(){
     const {h, c} = getHoldingAt();
     let currentVal = 0;
     const hs = getDB().hs;
     if(hs.length>0) currentVal = hs.sort((a,b)=>b.date.localeCompare(a.date) || b.time.localeCompare(a.time))[0].val;
     const pl = currentVal - c;
     const color = pl >= 0 ? 'var(--green)' : 'var(--red)';
     el('chartTotalCost').innerText = "RM " + c.toLocaleString('en-US',{minimumFractionDigits:2});
     el('chartTotalVal').innerText = "RM " + currentVal.toLocaleString('en-US',{minimumFractionDigits:2});
     el('chartTotalPL').innerHTML = `<span style="color:${color}">${pl>=0?'+':''}${pl.toLocaleString('en-US',{minimumFractionDigits:2})}</span>`;
  }

  function setChartFit(){ isFitMode=true; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); el('filter-fit').classList.add('active'); drawChart(); }
  function setChartFilter(range){ isFitMode=false; chartFilter = range; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); el('filter-'+range).classList.add('active'); drawChart(); }
  
  // Date Helpers
  function addDays(dateStr, days) {
      const result = new Date(dateStr);
      result.setDate(result.getDate() + days);
      return result.toISOString().split('T')[0];
  }

  function drawChart(){
    const {hs} = getDB(); const box = el('trendChart'); const wrapper = el('chartWrapper'); box.innerHTML = '';
    let data = hs.sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
    const now = new Date();
    
    if(!isFitMode) {
      if(chartFilter === '1d'){ const last=data[data.length-1]; data = data.filter(d=>d.date===last.date); }
      else if(chartFilter === '1w'){ const cut=new Date(); cut.setDate(now.getDate()-7); data = data.filter(d=>new Date(d.date)>=cut); }
      else if(chartFilter === '1m'){ const cut=new Date(); cut.setMonth(now.getMonth()-1); data = data.filter(d=>new Date(d.date)>=cut); }
      else if(chartFilter === '3m'){ const cut=new Date(); cut.setMonth(now.getMonth()-3); data = data.filter(d=>new Date(d.date)>=cut); }
    }
    
    if(data.length===0){ box.innerHTML='<div style="display:flex;height:100%;align-items:center;justify-content:center;color:var(--sub)">æ— æ•°æ®</div>'; return; }

    chartData = data.map(d => {
        const s = getHoldingAt(d.date);
        return { date: d.date, time: d.time, asset: d.val, cost: s.c, unitP: s.h>0?d.val/s.h:0 };
    }).filter(c=>c.cost>0);

    const candles = chartData;
    const allVals = candles.map(c=>c.asset).concat(candles.map(c=>c.cost));
    const minVal=Math.min(...allVals), maxVal=Math.max(...allVals);
    const range=maxVal-minVal, minY=Math.max(0,minVal-range*0.1), maxY=maxVal+range*0.1;
    const H=320;
    
    // Future Padding: 10 extra slots
    const futureDays = 10;
    const dataLen = candles.length;
    const totalLen = dataLen + futureDays;
    
    let W;
    if(isFitMode) {
        W = wrapper.offsetWidth;
    } else {
        W = Math.max(wrapper.offsetWidth, totalLen * 50); 
    }
    
    const step = W / totalLen;
    chartStep = step; // Global for interactions
    
    // V79 FIX: Force box width to unlock scroll!
    box.style.width = W + "px"; 
    
    const getY=(v)=>H-20-((v-minY)/(maxY-minY))*(H-40);

    let pathAsset="", pathCost="";
    candles.forEach((c,i)=>{
        const x=i*step+step/2, yA=getY(c.asset), yC=getY(c.cost);
        if(i===0){ pathAsset=`M ${x} ${yA}`; pathCost=`M ${x} ${yC}`; }
        else{ pathAsset+=` L ${x} ${yA}`; pathCost+=` L ${x} ${yC}`; }
    });
    
    // Close Cost Area for gradient
    const firstX=step/2;
    const lastDataX=(dataLen-1)*step+step/2;
    const bottomY=H-20;
    const pathCostArea = pathCost + ` L ${lastDataX} ${bottomY} L ${firstX} ${bottomY} Z`;
    
    let svg=`<svg width="${W}px" height="${H}px"><defs><linearGradient id="gradProfit" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="var(--green)" stop-opacity="0.3"/><stop offset="100%" stop-color="var(--green)" stop-opacity="0.05"/></linearGradient><linearGradient id="gradLoss" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="var(--red)" stop-opacity="0.3"/><stop offset="100%" stop-color="var(--red)" stop-opacity="0.05"/></linearGradient></defs>`;
    
    // Grid Lines (Full width including future)
    for(let i=0;i<=4;i++){ const y=H-20-(i/4)*(H-40); svg+=`<line x1="0" y1="${y}" x2="${W}" y2="${y}" class="grid-line"/>`; }
    
    // Areas & Lines (Stop at dataLen)
    svg+=`<path d="${pathCostArea}" class="area-cost"/><path d="${pathCost}" class="line-cost"/>`;
    
    candles.forEach((c,i)=>{
        const x=i*step+step/2, yA=getY(c.asset), yC=getY(c.cost);
        const yTop=Math.min(yA,yC), hBar=Math.abs(yA-yC);
        svg+=`<rect x="${x-step/2}" y="${yTop}" width="${step}" height="${Math.max(1,hBar)}" fill="${c.asset>=c.cost?'url(#gradProfit)':'url(#gradLoss)'}"/>`;
    });
    svg+=`<path d="${pathAsset}" class="line-asset"/>`;
    
    // Interactions
    candles.forEach((c,i)=>{
        const x=i*step+step/2, yA=getY(c.asset);
        // Elements for Hover
        svg += `<line id="crosshair-${i}" class="crosshair" x1="${x}" y1="0" x2="${x}" y2="${H}" />`;
        svg += `<circle id="dot-${i}" class="active-dot" cx="${x}" cy="${yA}" />`;
    });

    // X Axis Labels (Including Future)
    // Label Density
    const density = isFitMode ? 5 : 2; // Show every Nth label
    for (let i = 0; i < totalLen; i++) {
        if (i % density === 0 || i === dataLen - 1) { // Show start, end of data, and steps
             const x = i * step + step/2;
             let labelText = "";
             if (i < dataLen) {
                 labelText = candles[i].date.slice(5);
             } else {
                 // Future date calculation
                 const lastDate = candles[dataLen-1].date;
                 const futureOffset = i - (dataLen - 1);
                 const futureDate = addDays(lastDate, futureOffset);
                 labelText = futureDate.slice(5);
             }
             // Dim future labels
             const opacity = i >= dataLen ? 0.4 : 1;
             svg += `<text x="${x}" y="${H-5}" class="axis-label" text-anchor="middle" style="opacity:${opacity}">${labelText}</text>`;
        }
    }
    
    box.innerHTML=svg+'<div id="chartTooltip" class="chart-tooltip"></div></svg>'; 
    if(!isFitMode) setTimeout(()=>{wrapper.scrollLeft=wrapper.scrollWidth},50);
  }

  // --- Tooltip Logic (Boundaries & Scroll) ---
  function handleTouch(e){
      // Do NOT preventDefault if scrolling horizontally, but we want to capture position
      // Check if touch is moving mainly horizontally?
      // Simple logic: if inside chart box, show tooltip.
      const touch = e.touches[0];
      showTooltipAt(touch.clientX);
  }
  function handleMouse(e){
      e.preventDefault();
      showTooltipAt(e.clientX);
  }
  
  function showTooltipAt(clientX){
      if(!chartData.length) return;
      const box = el('trendChart');
      const rect = box.getBoundingClientRect();
      const xInBox = clientX - rect.left;
      
      // If user is touching outside of chart content (e.g. padding area), hide
      // But we want to snap to nearest.
      
      const scrollLeft = el('chartWrapper').scrollLeft;
      const xTotal = xInBox + scrollLeft; 
      
      let idx = Math.floor(xTotal / chartStep);
      
      // Boundary check for data
      if(idx < 0) idx = 0;
      // If cursor is in "Future" empty space (idx >= chartData.length), hide tooltip
      if(idx >= chartData.length) {
          hideTip();
          return;
      }
      
      const c = chartData[idx];
      const pl = c.asset - c.cost;
      const plColor = pl >= 0 ? 'var(--green)' : 'var(--red)';
      
      const tt = el('chartTooltip');
      tt.innerHTML = `
        <div class="tt-date">${c.date} ${c.time}</div>
        <div class="tt-row"><span class="tt-label">æ€»èµ„äº§</span><span class="tt-val">RM ${c.asset.toFixed(2)}</span></div>
        <div class="tt-row"><span class="tt-label">æ€»æˆæœ¬</span><span class="tt-val">RM ${c.cost.toFixed(2)}</span></div>
        <div class="tt-row"><span class="tt-label">æŠ˜åˆå•ä»·</span><span class="tt-val">RM ${c.unitP.toFixed(2)}</span></div>
        <div class="tt-row">
            <span class="tt-label">ç›ˆäº</span>
            <span class="tt-val" style="color:${plColor}">${pl>=0?'+':''}${pl.toFixed(2)}</span>
        </div>
      `;
      
      // Tooltip positioning logic (Sticky)
      // We want tooltip to stay visible.
      // xInsideVisible is where user is looking.
      let tipLeft = xInBox + 10;
      
      // If tooltip would go off right edge
      if(tipLeft + 160 > rect.width) {
          tipLeft = xInBox - 170;
      }
      
      tt.style.left = tipLeft + "px"; // Fixed relative to viewport (box)
      tt.style.top = "10px";
      tt.classList.add('show');
      
      // Highlights
      document.querySelectorAll('.crosshair').forEach(l => l.classList.remove('show'));
      document.querySelectorAll('.active-dot').forEach(d => d.classList.remove('show'));
      const line = document.getElementById(`crosshair-${idx}`);
      const dot = document.getElementById(`dot-${idx}`);
      if(line) line.classList.add('show');
      if(dot) dot.classList.add('show');
  }

  function hideTip(){
      el('chartTooltip').classList.remove('show');
      document.querySelectorAll('.crosshair').forEach(l => l.classList.remove('show'));
      document.querySelectorAll('.active-dot').forEach(d => d.classList.remove('show'));
  }

  // Common Functions
  function confirmSave(){ const v = parseFloat(el('inputTotalVal').value); if(!v) return; if(confirm(`ç¡®è®¤å½•å…¥ä»Šæ—¥æ€»å¸‚å€¼: RM ${v.toFixed(2)} ?`)){ let hs=getDB().hs; hs.push({ts:Date.now(), date:new Date().toISOString().split('T')[0], time:new Date().toTimeString().slice(0,5), val:v}); localStorage.setItem(KEY.HS,JSON.stringify(hs)); alert("å·²ä¿å­˜"); el('inputTotalVal').value=''; render(); } }
  function saveTx(){ const t={ ts:Date.now(), type:'buy', date:el('tDate').value, amount:el('tAmt').value, price:el('tPrice').value, grams:el('tGrams').value }; let db=getDB(); db.tx.push(t); localStorage.setItem(KEY.TX,JSON.stringify(db.tx)); el('txModal').classList.remove('show'); render(); }
  function saveHist(){ const h={ ts:Date.now(), date:el('hDate').value, time:el('hTime').value, val:parseFloat(el('hTotalVal').value) }; let db=getDB(); if(editHistId){const i=db.hs.findIndex(x=>x.ts==editHistId);if(i>-1)db.hs[i]={...db.hs[i],date:h.date,time:h.time,val:h.val};}else{db.hs.push(h);} localStorage.setItem(KEY.HS,JSON.stringify(db.hs)); el('histModal').classList.remove('show'); drawChart(); render(); }
  function delTx(){ if(confirm('åˆ ?')){ let db=getDB(); db.tx=db.tx.filter(x=>x.ts!=editId); localStorage.setItem(KEY.TX,JSON.stringify(db.tx)); el('txModal').classList.remove('show'); render(); } }
  function delHist(){ if(confirm('åˆ é™¤æ­¤æ¡å¸‚å€¼è®°å½•?')){ let db=getDB(); db.hs=db.hs.filter(x=>x.ts!=editHistId); localStorage.setItem(KEY.HS,JSON.stringify(db.hs)); el('histModal').classList.remove('show'); drawChart(); render(); } }
  function calcG(){ const a=parseFloat(el('tAmt').value), p=parseFloat(el('tPrice').value); if(a && p) el('tGrams').value = (a/p).toFixed(6); }
  function openTxModal(){ el('txModal').classList.add('show'); el('tDate').value=new Date().toISOString().split('T')[0]; el('btnDelTx').style.display='none'; }
  function editT(ts){ editId=ts; const t=getDB().tx.find(x=>x.ts==ts); el('tDate').value=t.date; el('tAmt').value=t.amount; el('tPrice').value=t.price; calcG(); el('txModal').classList.add('show'); el('btnDelTx').style.display='block'; }
  function openHistModal(){ editHistId=null; el('histModal').classList.add('show'); el('hDate').value=new Date().toISOString().split('T')[0]; el('hTime').value="10:00"; el('hTotalVal').value=''; el('btnDelHist').style.display='none'; }
  function editHist(ts){ editHistId=ts; const h=getDB().hs.find(x=>x.ts==ts); el('hDate').value=h.date; el('hTime').value=h.time; el('hTotalVal').value=h.val; el('histModal').classList.add('show'); el('btnDelHist').style.display='block'; }
  function openSettings(){ el('settingsModal').classList.add('show'); }
  function openShareModal(){ alert('æˆªå›¾å³å¯åˆ†äº«'); }
  function togglePrivacy(){ privacyMode=!privacyMode; render(true); }
  function switchTab(t){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.querySelectorAll('.dock-btn').forEach(b=>b.classList.remove('active')); el('view-'+t).classList.add('active'); el('nav-'+t).classList.add('active'); if(t=='chart'){drawChart(); updateChartSummary();} }
  function exportData(){ const blob=new Blob([JSON.stringify(getDB())],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tng_backup.json'; a.click(); }
  function importData(e){ const r=new FileReader(); r.onload=ev=>{ const d=JSON.parse(ev.target.result); localStorage.setItem(KEY.TX,JSON.stringify(d.tx)); localStorage.setItem(KEY.HS,JSON.stringify(d.hs)); location.reload(); }; r.readAsText(e.files[0]); }
  function resetAll(){ if(confirm('æ¸…ç©º?')) { localStorage.clear(); location.reload(); } }

  init();
</script>
</body>
</html>
